/**
 * This decorator delays a potentially unsafe event (like loaded/unloaded that will sometimes be called before ngOnInit) to be handled safely by ensuring it's called after a lifecycle hook.
 * @param runAfterEvent event/function call to wait until the event can be fired ('ngOnInit', 'ngAfterViewInit', ...)
 * @param options Optional event handling params
 * @returns decorator
 */
export function NativeScriptNgSafeEvent(runAfterEvent, options = {}) {
    const event = runAfterEvent;
    return function (target, propertyKey, descriptor) {
        function getNgSafe() {
            return target['__ng_safe__'];
        }
        if (!target['__ng_safe__']) {
            const defaultNgSafe = {
                events: {},
                runBefore: {},
            };
            target['__ng_safe__'] = defaultNgSafe;
        }
        if (!getNgSafe().events[event]) {
            getNgSafe().events[event] = {
                done: false,
                buffer: [],
                originalDelegate: target[event],
            };
            target[event] = function (...args) {
                try {
                    if (getNgSafe().events[event].originalDelegate) {
                        return getNgSafe().events[event].originalDelegate.apply(this, args);
                    }
                }
                finally {
                    getNgSafe().events[event].done = true;
                    getNgSafe().events[event].buffer.forEach((fn) => fn.fn());
                    getNgSafe().events[event].buffer = [];
                }
            };
        }
        if (options.alwaysRunBefore) {
            getNgSafe().runBefore[propertyKey] = target[options.alwaysRunBefore];
            target[`${options.alwaysRunBefore}`] = function (...args) {
                getNgSafe()
                    .events[event].buffer.filter((v) => v.key === propertyKey)
                    .forEach((fn) => fn.fn());
                getNgSafe().events[event].buffer = getNgSafe().events[event].buffer.filter((v) => v.key !== propertyKey);
                getNgSafe().runBefore[propertyKey];
                if (getNgSafe().runBefore[propertyKey]) {
                    return getNgSafe().runBefore[propertyKey].apply(this, args);
                }
            };
        }
        const oldFn = descriptor.value;
        descriptor.value = function (...args) {
            if (getNgSafe().events[event].done) {
                return oldFn.apply(this, args);
            }
            let shouldPush = true;
            if (options.onlyFirst || options.onlyLast) {
                for (let i = 0; i < getNgSafe().events[event].buffer.length; i++) {
                    if (getNgSafe().events[event].buffer[i].key === propertyKey) {
                        if (options.onlyFirst) {
                            shouldPush = false;
                            break;
                        }
                        if (options.onlyLast) {
                            getNgSafe().events[event].buffer.splice(i, 1);
                            break;
                        }
                    }
                }
            }
            if (shouldPush) {
                getNgSafe().events[event].buffer.push({
                    key: propertyKey,
                    fn: oldFn.bind(this, args),
                });
            }
        };
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctc2FmZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9saWIvdXRpbHMvbmctc2FmZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7R0FLRztBQUNILE1BQU0sVUFBVSx1QkFBdUIsQ0FDckMsYUFBcUIsRUFDckIsVUFJSSxFQUFFO0lBRU4sTUFBTSxLQUFLLEdBQUcsYUFBYSxDQUFDO0lBQzVCLE9BQU8sVUFBVSxNQUFlLEVBQUUsV0FBbUIsRUFBRSxVQUE4QjtRQWdCbkYsU0FBUyxTQUFTO1lBQ2hCLE9BQU8sTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQy9CLENBQUM7UUFDRCxJQUFJLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxFQUFFO1lBQzFCLE1BQU0sYUFBYSxHQUFlO2dCQUNoQyxNQUFNLEVBQUUsRUFBRTtnQkFDVixTQUFTLEVBQUUsRUFBRTthQUNkLENBQUM7WUFDRixNQUFNLENBQUMsYUFBYSxDQUFDLEdBQUcsYUFBYSxDQUFDO1NBQ3ZDO1FBQ0QsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUM5QixTQUFTLEVBQUUsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUc7Z0JBQzFCLElBQUksRUFBRSxLQUFLO2dCQUNYLE1BQU0sRUFBRSxFQUFFO2dCQUNWLGdCQUFnQixFQUFFLE1BQU0sQ0FBQyxLQUFLLENBQUM7YUFDaEMsQ0FBQztZQUNGLE1BQU0sQ0FBQyxLQUFLLENBQUMsR0FBRyxVQUFVLEdBQUcsSUFBSTtnQkFDL0IsSUFBSTtvQkFDRixJQUFJLFNBQVMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxnQkFBZ0IsRUFBRTt3QkFDOUMsT0FBTyxTQUFTLEVBQUUsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztxQkFD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QUNELElBQUksVUFBVSxFQUFFO2dCQUNkLFNBQVMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDO29CQUNwQyxHQUFHLEVBQUUsV0FBVztvQkFDaEIsRUFBRSxFQUFFLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQztpQkFDM0IsQ0FBQyxDQUFDO2FBQ0o7UUFDSCxDQUFDLENBQUM7SUFDSixDQUFDLENBQUM7QUFDSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBUaGlzIGRlY29yYXRvciBkZWxheXMgYSBwb3RlbnRpYWxseSB1bnNhZmUgZXZlbnQgKGxpa2UgbG9hZGVkL3VubG9hZGVkIHRoYXQgd2lsbCBzb21ldGltZXMgYmUgY2FsbGVkIGJlZm9yZSBuZ09uSW5pdCkgdG8gYmUgaGFuZGxlZCBzYWZlbHkgYnkgZW5zdXJpbmcgaXQncyBjYWxsZWQgYWZ0ZXIgYSBsaWZlY3ljbGUgaG9vay5cbiAqIEBwYXJhbSBydW5BZnRlckV2ZW50IGV2ZW50L2Z1bmN0aW9uIGNhbGwgdG8gd2FpdCB1bnRpbCB0aGUgZXZlbnQgY2FuIGJlIGZpcmVkICgnbmdPbkluaXQnLCAnbmdBZnRlclZpZXdJbml0JywgLi4uKVxuICogQHBhcmFtIG9wdGlvbnMgT3B0aW9uYWwgZXZlbnQgaGFuZGxpbmcgcGFyYW1zXG4gKiBAcmV0dXJucyBkZWNvcmF0b3JcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIE5hdGl2ZVNjcmlwdE5nU2FmZUV2ZW50KFxuICBydW5BZnRlckV2ZW50OiBzdHJpbmcsXG4gIG9wdGlvbnM6IHtcbiAgICBvbmx5TGFzdD86IGJvb2xlYW47XG4gICAgb25seUZpcnN0PzogYm9vbGVhbjtcbiAgICBhbHdheXNSdW5CZWZvcmU/OiBzdHJpbmc7XG4gIH0gPSB7fVxuKSB7XG4gIGNvbnN0IGV2ZW50ID0gcnVuQWZ0ZXJFdmVudDtcbiAgcmV0dXJuIGZ1bmN0aW9uICh0YXJnZXQ6IHVua25vd24sIHByb3BlcnR5S2V5OiBzdHJpbmcsIGRlc2NyaXB0b3I6IFByb3BlcnR5RGVzY3JpcHRvcikge1xuICAgIHR5cGUgTmdTYWZlVHlwZSA9IHtcbiAgICAgIGV2ZW50czoge1xuICAgICAgICBba2V5OiBzdHJpbmddOiB7XG4gICAgICAgICAgZG9uZTogYm9vbGVhbjtcbiAgICAgICAgICBvcmlnaW5hbERlbGVnYXRlOiAoLi4uYXJnczogdW5rbm93bltdKSA9PiB1bmtub3duO1xuICAgICAgICAgIGJ1ZmZlcjogQXJyYXk8e1xuICAgICAgICAgICAga2V5OiBzdHJpbmc7XG4gICAgICAgICAgICBmbjogKC4uLmFyZ3M6IHVua25vd25bXSkgPT4gdW5rbm93bjtcbiAgICAgICAgICB9PjtcbiAgICAgICAgfTtcbiAgICAgIH07XG4gICAgICBydW5CZWZvcmU6IHtcbiAgICAgICAgW3Byb3BlcnR5S2V5OiBzdHJpbmddOiAoLi4uYXJnczogdW5rbm93bltdKSA9PiB1bmtub3duO1xuICAgICAgfTtcbiAgICB9O1xuICAgIGZ1bmN0aW9uIGdldE5nU2FmZSgpOiBOZ1NhZmVUeXBlIHtcbiAgICAgIHJldHVybiB0YXJnZXRbJ19fbmdfc2FmZV9fJ107XG4gICAgfVxuICAgIGlmICghdGFyZ2V0WydfX25nX3NhZmVfXyddKSB7XG4gICAgICBjb25zdCBkZWZhdWx0TmdTYWZlOiBOZ1NhZmVUeXBlID0ge1xuICAgICAgICBldmVudHM6IHt9LFxuICAgICAgICBydW5CZWZvcmU6IHt9LFxuICAgICAgfTtcbiAgICAgIHRhcmdldFsnX19uZ19zYWZlX18nXSA9IGRlZmF1bHROZ1NhZmU7XG4gICAgfVxuICAgIGlmICghZ2V0TmdTYWZlKCkuZXZlbnRzW2V2ZW50XSkge1xuICAgICAgZ2V0TmdTYWZlKCkuZXZlbnRzW2V2ZW50XSA9IHtcbiAgICAgICAgZG9uZTogZmFsc2UsXG4gICAgICAgIGJ1ZmZlcjogW10sXG4gICAgICAgIG9yaWdpbmFsRGVsZWdhdGU6IHRhcmdldFtldmVudF0sXG4gICAgICB9O1xuICAgICAgdGFyZ2V0W2V2ZW50XSA9IGZ1bmN0aW9uICguLi5hcmdzKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgaWYgKGdldE5nU2FmZSgpLmV2ZW50c1tldmVudF0ub3JpZ2luYWxEZWxlZ2F0ZSkge1xuICAgICAgICAgICAgcmV0dXJuIGdldE5nU2FmZSgpLmV2ZW50c1tldmVudF0ub3JpZ2luYWxEZWxlZ2F0ZS5hcHBseSh0aGlzLCBhcmdzKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgZ2V0TmdTYWZlKCkuZXZlbnRzW2V2ZW50XS5kb25lID0gdHJ1ZTtcbiAgICAgICAgICBnZXROZ1NhZmUoKS5ldmVudHNbZXZlbnRdLmJ1ZmZlci5mb3JFYWNoKChmbikgPT4gZm4uZm4oKSk7XG4gICAgICAgICAgZ2V0TmdTYWZlKCkuZXZlbnRzW2V2ZW50XS5idWZmZXIgPSBbXTtcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICB9XG5cbiAgICBpZiAob3B0aW9ucy5hbHdheXNSdW5CZWZvcmUpIHtcbiAgICAgIGdldE5nU2FmZSgpLnJ1bkJlZm9yZVtwcm9wZXJ0eUtleV0gPSB0YXJnZXRbb3B0aW9ucy5hbHdheXNSdW5CZWZvcmVdO1xuXG4gICAgICB0YXJnZXRbYCR7b3B0aW9ucy5hbHdheXNSdW5CZWZvcmV9YF0gPSBmdW5jdGlvbiAoLi4uYXJncykge1xuICAgICAgICBnZXROZ1NhZmUoKVxuICAgICAgICAgIC5ldmVudHNbZXZlbnRdLmJ1ZmZlci5maWx0ZXIoKHYpID0+IHYua2V5ID09PSBwcm9wZXJ0eUtleSlcbiAgICAgICAgICAuZm9yRWFjaCgoZm4pID0+IGZuLmZuKCkpO1xuICAgICAgICBnZXROZ1NhZmUoKS5ldmVudHNbZXZlbnRdLmJ1ZmZlciA9IGdldE5nU2FmZSgpLmV2ZW50c1tldmVudF0uYnVmZmVyLmZpbHRlcigodikgPT4gdi5rZXkgIT09IHByb3BlcnR5S2V5KTtcbiAgICAgICAgZ2V0TmdTYWZlKCkucnVuQmVmb3JlW3Byb3BlcnR5S2V5XTtcbiAgICAgICAgaWYgKGdldE5nU2FmZSgpLnJ1bkJlZm9yZVtwcm9wZXJ0eUtleV0pIHtcbiAgICAgICAgICByZXR1cm4gZ2V0TmdTYWZlKCkucnVuQmVmb3JlW3Byb3BlcnR5S2V5XS5hcHBseSh0aGlzLCBhcmdzKTtcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICB9XG5cbiAgICBjb25zdCBvbGRGbiA9IGRlc2NyaXB0b3IudmFsdWU7XG4gICAgZGVzY3JpcHRvci52YWx1ZSA9IGZ1bmN0aW9uICguLi5hcmdzKSB7XG4gICAgICBpZiAoZ2V0TmdTYWZlKCkuZXZlbnRzW2V2ZW50XS5kb25lKSB7XG4gICAgICAgIHJldHVybiBvbGRGbi5hcHBseSh0aGlzLCBhcmdzKTtcbiAgICAgIH1cbiAgICAgIGxldCBzaG91bGRQdXNoID0gdHJ1ZTtcbiAgICAgIGlmIChvcHRpb25zLm9ubHlGaXJzdCB8fCBvcHRpb25zLm9ubHlMYXN0KSB7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZ2V0TmdTYWZlKCkuZXZlbnRzW2V2ZW50XS5idWZmZXIubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICBpZiAoZ2V0TmdTYWZlKCkuZXZlbnRzW2V2ZW50XS5idWZmZXJbaV0ua2V5ID09PSBwcm9wZXJ0eUtleSkge1xuICAgICAgICAgICAgaWYgKG9wdGlvbnMub25seUZpcnN0KSB7XG4gICAgICAgICAgICAgIHNob3VsZFB1c2ggPSBmYWxzZTtcbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAob3B0aW9ucy5vbmx5TGFzdCkge1xuICAgICAgICAgICAgICBnZXROZ1NhZmUoKS5ldmVudHNbZXZlbnRdLmJ1ZmZlci5zcGxpY2UoaSwgMSk7XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKHNob3VsZFB1c2gpIHtcbiAgICAgICAgZ2V0TmdTYWZlKCkuZXZlbnRzW2V2ZW50XS5idWZmZXIucHVzaCh7XG4gICAgICAgICAga2V5OiBwcm9wZXJ0eUtleSxcbiAgICAgICAgICBmbjogb2xkRm4uYmluZCh0aGlzLCBhcmdzKSxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfTtcbiAgfTtcbn1cbiJdfQ==