import { __decorate } from "tslib";
import { Inject, Injectable, Optional, ViewEncapsulation } from '@angular/core';
import { addTaggedAdditionalCSS, Application, ContentView, getViewById, Observable, profile, View } from '@nativescript/core';
import { isKnownView } from './element-registry';
import { getFirstNativeLikeView } from './views';
import { NAMESPACE_FILTERS } from './property-filter';
import { APP_ROOT_VIEW, ENABLE_REUSABE_VIEWS, NATIVESCRIPT_ROOT_MODULE_ID } from './tokens';
import { NativeScriptDebug } from './trace';
import { ViewUtil } from './view-util';
const ɵ0 = function addStyleToCss(style, tag) {
    if (tag) {
        addTaggedAdditionalCSS(style, tag);
    }
    else {
        Application.addCss(style);
    }
};
const addStyleToCss = profile('"renderer".addStyleToCss', ɵ0);
export class NativeScriptRendererFactory {
    constructor(rootView, namespaceFilters, rootModuleID, reuseViews) {
        this.rootView = rootView;
        this.namespaceFilters = namespaceFilters;
        this.rootModuleID = rootModuleID;
        this.reuseViews = reuseViews;
        this.componentRenderers = new Map();
        // backwards compatibility with RadListView
        this.viewUtil = new ViewUtil(this.namespaceFilters, this.reuseViews);
        if (typeof this.reuseViews !== 'boolean') {
            this.reuseViews = false; // default to false
        }
        this.defaultRenderer = new NativeScriptRenderer(rootView, namespaceFilters, this.reuseViews);
    }
    createRenderer(hostElement, type) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRendererFactory.createRenderer ${hostElement}. type.id: ${type.id} type.encapsulation: ${type.encapsulation}`);
        }
        if (!hostElement || !type) {
            return this.defaultRenderer;
        }
        let renderer = this.componentRenderers.get(type.id);
        /**
         *! WARNING
         *! We're reusing the renderer for the components
         *! this might cause unexpected behavior as the "rootView" is an arbitrary hostElement
         *! also, the renderer has it's .destroy() called!
         *! might be useful to create a BaseEmulatedRender and a ProxyEmulatedRender
         *! every component type gets a BaseEmulatedRender (singleton) which is passed to ProxyEmulatedRender
         *! ProxyEmulatedRenderer registers with BaseEmulatedRender so we can clean up things like CSS when it's not needed
         *! this might be useful if we find a way to HMR component styling without a full rebootstrap
         */
        if (renderer) {
            if (renderer instanceof EmulatedRenderer) {
                renderer.applyToHost(hostElement);
            }
            return renderer;
        }
        if (type.encapsulation === ViewEncapsulation.None) {
            type.styles.map((s) => s.toString()).forEach((v) => addStyleToCss(v, this.rootModuleID));
            renderer = this.defaultRenderer;
        }
        else {
            renderer = new EmulatedRenderer(type, hostElement, this.namespaceFilters, this.rootModuleID, this.reuseViews);
            renderer.applyToHost(hostElement);
        }
        this.componentRenderers.set(type.id, renderer);
        return renderer;
    }
    // begin?(): void {
    //     throw new Error("Method not implemented.");
    // }
    // end?(): void {
    //     throw new Error("Method not implemented.");
    // }
    whenRenderingDone() {
        if (!this.rootView) {
            return Promise.resolve();
        }
        return new Promise((resolve) => {
            let interval = 0;
            function scheduleResolve() {
                // iOS really hates synchronous things...
                // Utils.queueMacrotask(resolve);
                setTimeout(resolve, 15);
            }
            function fireWhenLoaded() {
                const view = rootFactory();
                if (view.isLoaded) {
                    scheduleResolve();
                }
                else {
                    view.once('loaded', scheduleResolve);
                }
            }
            const rootFactory = () => (this.rootView instanceof ContentView ? this.rootView.content : this.rootView);
            if (!rootFactory()) {
                interval = setInterval(() => {
                    if (rootFactory()) {
                        clearInterval(interval);
                        fireWhenLoaded();
                    }
                }, 10);
            }
            else {
                fireWhenLoaded();
            }
        });
        // throw new Error("Method not implemented.");
    }
}
NativeScriptRendererFactory.ctorParameters = () => [
    { type: View, decorators: [{ type: Inject, args: [APP_ROOT_VIEW,] }] },
    { type: Array, decorators: [{ type: Inject, args: [NAMESPACE_FILTERS,] }] },
    { type: undefined, decorators: [{ type: Inject, args: [NATIVESCRIPT_ROOT_MODULE_ID,] }] },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [ENABLE_REUSABE_VIEWS,] }] }
];
class NativeScriptRenderer {
    constructor(rootView, namespaceFilters, reuseViews) {
        this.rootView = rootView;
        this.namespaceFilters = namespaceFilters;
        this.reuseViews = reuseViews;
        this.viewUtil = new ViewUtil(this.namespaceFilters, this.reuseViews);
        this.destroyNode = (node) => {
            if (NativeScriptDebug.enabled) {
                NativeScriptDebug.rendererLog(`NativeScriptRenderer.destroyNode node: ${node}`);
            }
            if (node === null || node === void 0 ? void 0 : node.destroyNode) {
                node === null || node === void 0 ? void 0 : node.destroyNode();
            }
        };
    }
    get data() {
        throw new Error('Method not implemented.');
    }
    destroy() {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog('NativeScriptRenderer.destroy');
        }
    }
    createElement(name, namespace) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.createElement: ${name}`);
        }
        let oldName;
        if (!isKnownView(name)) {
            oldName = name;
            name = 'ProxyViewContainer';
        }
        const view = this.viewUtil.createView(name);
        if (oldName) {
            view.customCSSName = oldName;
        }
        return view;
    }
    createComment(value) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.createComment ${value}`);
        }
        return this.viewUtil.createComment(value);
    }
    createText(value) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.createText ${value}`);
        }
        return this.viewUtil.createText(value);
    }
    appendChild(parent, newChild) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.appendChild child: ${newChild} parent: ${parent}`);
        }
        this.viewUtil.appendChild(parent, newChild);
    }
    insertBefore(parent, newChild, refChild) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.insertBefore child: ${newChild} ` + `parent: ${parent} refChild: ${refChild}`);
        }
        this.viewUtil.insertBefore(parent, newChild, refChild);
    }
    removeChild(parent, oldChild, isHostElement) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.removeChild child: ${oldChild} parent: ${parent}`);
        }
        this.viewUtil.removeChild(parent, oldChild);
    }
    selectRootElement(selectorOrNode, preserveContent) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.selectRootElement: ${selectorOrNode}`);
        }
        if (selectorOrNode instanceof View) {
            return selectorOrNode;
        }
        if (selectorOrNode && selectorOrNode[0] === '#') {
            const result = getViewById(this.rootView, selectorOrNode.slice(1));
            return (result || this.rootView);
        }
        if (typeof selectorOrNode === 'string') {
            const view = this.viewUtil.createView(selectorOrNode);
            if (getFirstNativeLikeView(view) === view) {
                // view is nativelike!
                this.appendChild(this.rootView, view);
                return view;
            }
        }
        return this.rootView;
    }
    parentNode(node) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.parentNode for node: ${node} is ${node.parentNode}`);
        }
        return node.parentNode;
    }
    nextSibling(node) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.nextSibling of ${node} is ${node.nextSibling}`);
        }
        return node.nextSibling;
    }
    setAttribute(el, name, value, namespace) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.setAttribute ${namespace ? namespace + ':' : ''}${el}.${name} = ${value}`);
        }
        this.viewUtil.setProperty(el, name, value, namespace);
    }
    removeAttribute(el, name, namespace) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.removeAttribute ${namespace ? namespace + ':' : ''}${el}.${name}`);
        }
    }
    addClass(el, name) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.addClass ${name}`);
        }
        this.viewUtil.addClass(el, name);
    }
    removeClass(el, name) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.removeClass ${name}`);
        }
        this.viewUtil.removeClass(el, name);
    }
    setStyle(el, style, value, flags) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.setStyle: ${el}, ${style} = ${value}`);
        }
        this.viewUtil.setStyle(el, style, value);
    }
    removeStyle(el, style, flags) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog('NativeScriptRenderer.removeStyle: ${styleName}');
        }
        this.viewUtil.removeStyle(el, style);
    }
    setProperty(el, name, value) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.setProperty ${el}.${name} = ${value}`);
        }
        this.viewUtil.setProperty(el, name, value);
    }
    setValue(node, value) {
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.setValue renderNode: ${node}, value: ${value}`);
        }
        // throw new Error("Method not implemented.");
    }
    listen(target, eventName, callback) {
        // throw new Error("Method not implemented.");
        if (NativeScriptDebug.enabled) {
            NativeScriptDebug.rendererLog(`NativeScriptRenderer.listen: ${eventName}`);
        }
        target.on(eventName, callback);
        if (eventName === View.loadedEvent && target.isLoaded) {
            // we must create a new obervable here to ensure that the event goes through whatever zone patches are applied
            const obs = new Observable();
            obs.once(eventName, callback);
            obs.notify({
                eventName,
                object: target,
            });
        }
        return () => target.off(eventName, callback);
    }
}
// CONTENT_ATTR not exported from nativescript-renderer - we need it for styles application.
const COMPONENT_REGEX = /%COMP%/g;
const ATTR_SANITIZER = /-/g;
export const COMPONENT_VARIABLE = '%COMP%';
export const HOST_ATTR = `_nghost-${COMPONENT_VARIABLE}`;
export const CONTENT_ATTR = `_ngcontent-${COMPONENT_VARIABLE}`;
const replaceNgAttribute = function (input, componentId) {
    return input.replace(COMPONENT_REGEX, componentId);
};
const ɵ1 = replaceNgAttribute;
const ɵ2 = function addScopedStyleToCss(style, tag) {
    if (tag) {
        addTaggedAdditionalCSS(style, tag);
    }
    else {
        Application.addCss(style);
    }
};
const addScopedStyleToCss = profile(`"renderer".addScopedStyleToCss`, ɵ2);
export class EmulatedRenderer extends NativeScriptRenderer {
    constructor(component, rootView, namespaceFilters, rootModuleId, reuseViews) {
        super(rootView, namespaceFilters, reuseViews);
        this.rootModuleId = rootModuleId;
        const componentId = component.id.replace(ATTR_SANITIZER, '_');
        this.contentAttr = replaceNgAttribute(CONTENT_ATTR, componentId);
        this.hostAttr = replaceNgAttribute(HOST_ATTR, componentId);
        this.addStyles(component.styles, componentId);
    }
    applyToHost(view) {
        super.setAttribute(view, this.hostAttr, '');
    }
    appendChild(parent, newChild) {
        super.appendChild(parent, newChild);
    }
    createElement(parent, name) {
        const view = super.createElement(parent, name);
        // Set an attribute to the view to scope component-specific css.
        // The property name is pre-generated by Angular.
        super.setAttribute(view, this.contentAttr, '');
        return view;
    }
    addStyles(styles, componentId) {
        styles
            .map((s) => s.toString())
            .map((s) => replaceNgAttribute(s, componentId))
            .forEach((s) => addScopedStyleToCss(s, this.rootModuleId));
    }
}
EmulatedRenderer.decorators = [
    { type: Injectable }
];
EmulatedRenderer.ctorParameters = () => [
    { type: undefined },
    { type: View },
    { type: Array },
    { type: undefined },
    { type: Boolean }
];
__decorate([
    profile
], EmulatedRenderer.prototype, "addStyles", null);
export { ɵ0, ɵ1, ɵ2 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF0aXZlc2NyaXB0LXJlbmRlcmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2xpYi9uYXRpdmVzY3JpcHQtcmVuZGVyZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFVLFFBQVEsRUFBbUUsaUJBQWlCLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDekosT0FBTyxFQUFFLHNCQUFzQixFQUFFLFdBQVcsRUFBRSxXQUFXLEVBQVUsV0FBVyxFQUFFLFVBQVUsRUFBRSxPQUFPLEVBQVMsSUFBSSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDN0ksT0FBTyxFQUFnQixXQUFXLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUMvRCxPQUFPLEVBQUUsc0JBQXNCLEVBQVUsTUFBTSxTQUFTLENBQUM7QUFFekQsT0FBTyxFQUFtQixpQkFBaUIsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3ZFLE9BQU8sRUFBRSxhQUFhLEVBQUUsb0JBQW9CLEVBQUUsMkJBQTJCLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDNUYsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQzVDLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxhQUFhLENBQUM7V0FFbUIsU0FBUyxhQUFhLENBQUMsS0FBYSxFQUFFLEdBQXFCO0lBQ25ILElBQUksR0FBRyxFQUFFO1FBQ1Asc0JBQXNCLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0tBQ3BDO1NBQU07UUFDTCxXQUFXLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO0tBQzNCO0FBQ0gsQ0FBQztBQU5ELE1BQU0sYUFBYSxHQUFHLE9BQU8sQ0FBQywwQkFBMEIsS0FNdEQsQ0FBQztBQUVILE1BQU0sT0FBTywyQkFBMkI7SUFNdEMsWUFBMkMsUUFBYyxFQUFxQyxnQkFBbUMsRUFBK0MsWUFBNkIsRUFBb0QsVUFBVTtRQUFoTyxh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Q0FBQyxDQUFDO0lBQzlDLENBQUM7SUFFRCxXQUFXLENBQUMsTUFBVyxFQUFFLFFBQWdCO1FBQ3ZDLEtBQUssQ0FBQyxXQUFXLENBQUMsTUFBTSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQ3RDLENBQUM7SUFFRCxhQUFhLENBQUMsTUFBVyxFQUFFLElBQVk7UUFDckMsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLGFBQWEsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFFL0MsZ0VBQWdFO1FBQ2hFLGlEQUFpRDtRQUNqRCxLQUFLLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsV0FBVyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRS9DLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUdPLFNBQVMsQ0FBQyxNQUEwQixFQUFFLFdBQW1CO1FBQy9ELE1BQU07YUFDSCxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQzthQUN4QixHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLGtCQUFrQixDQUFDLENBQUMsRUFBRSxXQUFXLENBQUMsQ0FBQzthQUM5QyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLG1CQUFtQixDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztJQUMvRCxDQUFDOzs7WUF0Q0YsVUFBVTs7OztZQW5TaUcsSUFBSTs7Ozs7QUFvVTlHO0lBREMsT0FBTztpREFNUCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgTmdab25lLCBPcHRpb25hbCwgUmVuZGVyZXIyLCBSZW5kZXJlckZhY3RvcnkyLCBSZW5kZXJlclN0eWxlRmxhZ3MyLCBSZW5kZXJlclR5cGUyLCBWaWV3RW5jYXBzdWxhdGlvbiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgYWRkVGFnZ2VkQWRkaXRpb25hbENTUywgQXBwbGljYXRpb24sIENvbnRlbnRWaWV3LCBEZXZpY2UsIGdldFZpZXdCeUlkLCBPYnNlcnZhYmxlLCBwcm9maWxlLCBVdGlscywgVmlldyB9IGZyb20gJ0BuYXRpdmVzY3JpcHQvY29yZSc7XG5pbXBvcnQgeyBnZXRWaWV3Q2xhc3MsIGlzS25vd25WaWV3IH0gZnJvbSAnLi9lbGVtZW50LXJlZ2lzdHJ5JztcbmltcG9ydCB7IGdldEZpcnN0TmF0aXZlTGlrZVZpZXcsIE5nVmlldyB9IGZyb20gJy4vdmlld3MnO1xuXG5pbXBvcnQgeyBOYW1lc3BhY2VGaWx0ZXIsIE5BTUVTUEFDRV9GSUxURVJTIH0gZnJvbSAnLi9wcm9wZXJ0eS1maWx0ZXInO1xuaW1wb3J0IHsgQVBQX1JPT1RfVklFVywgRU5BQkxFX1JFVVNBQkVfVklFV1MsIE5BVElWRVNDUklQVF9ST09UX01PRFVMRV9JRCB9IGZyb20gJy4vdG9rZW5zJztcbmltcG9ydCB7IE5hdGl2ZVNjcmlwdERlYnVnIH0gZnJvbSAnLi90cmFjZSc7XG5pbXBvcnQgeyBWaWV3VXRpbCB9IGZyb20gJy4vdmlldy11dGlsJztcblxuY29uc3QgYWRkU3R5bGVUb0NzcyA9IHByb2ZpbGUoJ1wicmVuZGVyZXJcIi5hZGRTdHlsZVRvQ3NzJywgZnVuY3Rpb24gYWRkU3R5bGVUb0NzcyhzdHlsZTogc3RyaW5nLCB0YWc/OiBzdHJpbmcgfCBudW1iZXIpOiB2b2lkIHtcbiAgaWYgKHRhZykge1xuICAgIGFkZFRhZ2dlZEFkZGl0aW9uYWxDU1Moc3R5bGUsIHRhZyk7XG4gIH0gZWxzZSB7XG4gICAgQXBwbGljYXRpb24uYWRkQ3NzKHN0eWxlKTtcbiAgfVxufSk7XG5cbmV4cG9ydCBjbGFzcyBOYXRpdmVTY3JpcHRSZW5kZXJlckZhY3RvcnkgaW1wbGVtZW50cyBSZW5kZXJlckZhY3RvcnkyIHtcbiAgcHJpdmF0ZSBjb21wb25lbnRSZW5kZXJlcnMgPSBuZXcgTWFwPHN0cmluZywgUmVuZGVyZXIyPigpO1xuICBwcml2YXRlIGRlZmF1bHRSZW5kZXJlcjogUmVuZGVyZXIyO1xuICAvLyBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eSB3aXRoIFJhZExpc3RWaWV3XG4gIHByaXZhdGUgdmlld1V0aWwgPSBuZXcgVmlld1V0aWwodGhpcy5uYW1lc3BhY2VGaWx0ZXJzLCB0aGlzLnJldXNlVmlld3MpO1xuXG4gIGNvbnN0cnVjdG9yKEBJbmplY3QoQVBQX1JPT1RfVklFVykgcHJpdmF0ZSByb290VmlldzogVmlldywgQEluamVjdChOQU1FU1BBQ0VfRklMVEVSUykgcHJpdmF0ZSBuYW1lc3BhY2VGaWx0ZXJzOiBOYW1lc3BhY2VGaWx0ZXJbXSwgQEluamVjdChOQVRJVkVTQ1JJUFRfUk9PVF9NT0RVTEVfSUQpIHByaXZhdGUgcm9vdE1vZHVsZUlEOiBzdHJpbmcgfCBudW1iZXIsIEBPcHRpb25hbCgpIEBJbmplY3QoRU5BQkxFX1JFVVNBQkVfVklFV1MpIHByaXZhdGUgcmV1c2VWaWV3cykge1xuICAgIGlmICh0eXBlb2YgdGhpcy5yZXVzZVZpZXdzICE9PSAnYm9vbGVhbicpIHtcbiAgICAgIHRoaXMucmV1c2VWaWV3cyA9IGZhbHNlOyAvLyBkZWZhdWx0IHRvIGZhbHNlXG4gICAgfVxuICAgIHRoaXMuZGVmYXVsdFJlbmRlcmVyID0gbmV3IE5hdGl2ZVNjcmlwdFJlbmRlcmVyKHJvb3RWaWV3LCBuYW1lc3BhY2VGaWx0ZXJzLCB0aGlzLnJldXNlVmlld3MpO1xuICB9XG4gIGNyZWF0ZVJlbmRlcmVyKGhvc3RFbGVtZW50OiBhbnksIHR5cGU6IFJlbmRlcmVyVHlwZTIpOiBSZW5kZXJlcjIge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5lbmFibGVkKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yZW5kZXJlckxvZyhgTmF0aXZlU2NyaXB0UmVuZGVyZXJGYWN0b3J5LmNyZWF0ZVJlbmRlcmVyICR7aG9zdEVsZW1lbnR9LiB0eXBlLmlkOiAke3R5cGUuaWR9IHR5cGUuZW5jYXBzdWxhdGlvbjogJHt0eXBlLmVuY2Fwc3VsYXRpb259YCk7XG4gICAgfVxuICAgIGlmICghaG9zdEVsZW1lbnQgfHwgIXR5cGUpIHtcbiAgICAgIHJldHVybiB0aGlzLmRlZmF1bHRSZW5kZXJlcjtcbiAgICB9XG5cbiAgICBsZXQgcmVuZGVyZXIgPSB0aGlzLmNvbXBvbmVudFJlbmRlcmVycy5nZXQodHlwZS5pZCk7XG4gICAgLyoqXG4gICAgICohIFdBUk5JTkdcbiAgICAgKiEgV2UncmUgcmV1c2luZyB0aGUgcmVuZGVyZXIgZm9yIHRoZSBjb21wb25lbnRzXG4gICAgICohIHRoaXMgbWlnaHQgY2F1c2UgdW5leHBlY3RlZCBiZWhhdmlvciBhcyB0aGUgXCJyb290Vmlld1wiIGlzIGFuIGFyYml0cmFyeSBob3N0RWxlbWVudFxuICAgICAqISBhbHNvLCB0aGUgcmVuZGVyZXIgaGFzIGl0J3MgLmRlc3Ryb3koKSBjYWxsZWQhXG4gICAgICohIG1pZ2h0IGJlIHVzZWZ1bCB0byBjcmVhdGUgYSBCYXNlRW11bGF0ZWRSZW5kZXIgYW5kIGEgUHJveHlFbXVsYXRlZFJlbmRlclxuICAgICAqISBldmVyeSBjb21wb25lbnQgdHlwZSBnZXRzIGEgQmFzZUVtdWxhdGVkUmVuZGVyIChzaW5nbGV0b24pIHdoaWNoIGlzIHBhc3NlZCB0byBQcm94eUVtdWxhdGVkUmVuZGVyXG4gICAgICohIFByb3h5RW11bGF0ZWRSZW5kZXJlciByZWdpc3RlcnMgd2l0aCBCYXNlRW11bGF0ZWRSZW5kZXIgc28gd2UgY2FuIGNsZWFuIHVwIHRoaW5ncyBsaWtlIENTUyB3aGVuIGl0J3Mgbm90IG5lZWRlZFxuICAgICAqISB0aGlzIG1pZ2h0IGJlIHVzZWZ1bCBpZiB3ZSBmaW5kIGEgd2F5IHRvIEhNUiBjb21wb25lbnQgc3R5bGluZyB3aXRob3V0IGEgZnVsbCByZWJvb3RzdHJhcFxuICAgICAqL1xuICAgIGlmIChyZW5kZXJlcikge1xuICAgICAgaWYgKHJlbmRlcmVyIGluc3RhbmNlb2YgRW11bGF0ZWRSZW5kZXJlcikge1xuICAgICAgICByZW5kZXJlci5hcHBseVRvSG9zdChob3N0RWxlbWVudCk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiByZW5kZXJlcjtcbiAgICB9XG5cbiAgICBpZiAodHlwZS5lbmNhcHN1bGF0aW9uID09PSBWaWV3RW5jYXBzdWxhdGlvbi5Ob25lKSB7XG4gICAgICB0eXBlLnN0eWxlcy5tYXAoKHMpID0+IHMudG9TdHJpbmcoKSkuZm9yRWFjaCgodikgPT4gYWRkU3R5bGVUb0Nzcyh2LCB0aGlzLnJvb3RNb2R1bGVJRCkpO1xuICAgICAgcmVuZGVyZXIgPSB0aGlzLmRlZmF1bHRSZW5kZXJlcjtcbiAgICB9IGVsc2Uge1xuICAgICAgcmVuZGVyZXIgPSBuZXcgRW11bGF0ZWRSZW5kZXJlcih0eXBlLCBob3N0RWxlbWVudCwgdGhpcy5uYW1lc3BhY2VGaWx0ZXJzLCB0aGlzLnJvb3RNb2R1bGVJRCwgdGhpcy5yZXVzZVZpZXdzKTtcbiAgICAgICg8RW11bGF0ZWRSZW5kZXJlcj5yZW5kZXJlcikuYXBwbHlUb0hvc3QoaG9zdEVsZW1lbnQpO1xuICAgIH1cblxuICAgIHRoaXMuY29tcG9uZW50UmVuZGVyZXJzLnNldCh0eXBlLmlkLCByZW5kZXJlcik7XG4gICAgcmV0dXJuIHJlbmRlcmVyO1xuICB9XG4gIC8vIGJlZ2luPygpOiB2b2lkIHtcbiAgLy8gICAgIHRocm93IG5ldyBFcnJvcihcIk1ldGhvZCBub3QgaW1wbGVtZW50ZWQuXCIpO1xuICAvLyB9XG4gIC8vIGVuZD8oKTogdm9pZCB7XG4gIC8vICAgICB0aHJvdyBuZXcgRXJyb3IoXCJNZXRob2Qgbm90IGltcGxlbWVudGVkLlwiKTtcbiAgLy8gfVxuICB3aGVuUmVuZGVyaW5nRG9uZSgpOiBQcm9taXNlPGFueT4ge1xuICAgIGlmICghdGhpcy5yb290Vmlldykge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICAgIH1cbiAgICByZXR1cm4gbmV3IFByb21pc2U8dm9pZD4oKHJlc29sdmUpID0+IHtcbiAgICAgIGxldCBpbnRlcnZhbDogYW55ID0gMDtcbiAgICAgIGZ1bmN0aW9uIHNjaGVkdWxlUmVzb2x2ZSgpIHtcbiAgICAgICAgLy8gaU9TIHJlYWxseSBoYXRlcyBzeW5jaHJvbm91cyB0aGluZ3MuLi5cbiAgICAgICAgLy8gVXRpbHMucXVldWVNYWNyb3Rhc2socmVzb2x2ZSk7XG4gICAgICAgIHNldFRpbWVvdXQocmVzb2x2ZSwgMTUpO1xuICAgICAgfVxuICAgICAgZnVuY3Rpb24gZmlyZVdoZW5Mb2FkZWQoKSB7XG4gICAgICAgIGNvbnN0IHZpZXcgPSByb290RmFjdG9yeSgpO1xuICAgICAgICBpZiAodmlldy5pc0xvYWRlZCkge1xuICAgICAgICAgIHNjaGVkdWxlUmVzb2x2ZSgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHZpZXcub25jZSgnbG9hZGVkJywgc2NoZWR1bGVSZXNvbHZlKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgY29uc3Qgcm9vdEZhY3RvcnkgPSAoKSA9PiAodGhpcy5yb290VmlldyBpbnN0YW5jZW9mIENvbnRlbnRWaWV3ID8gdGhpcy5yb290Vmlldy5jb250ZW50IDogdGhpcy5yb290Vmlldyk7XG4gICAgICBpZiAoIXJvb3RGYWN0b3J5KCkpIHtcbiAgICAgICAgaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICAgICAgaWYgKHJvb3RGYWN0b3J5KCkpIHtcbiAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwoaW50ZXJ2YWwpO1xuICAgICAgICAgICAgZmlyZVdoZW5Mb2FkZWQoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0sIDEwKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGZpcmVXaGVuTG9hZGVkKCk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgLy8gdGhyb3cgbmV3IEVycm9yKFwiTWV0aG9kIG5vdCBpbXBsZW1lbnRlZC5cIik7XG4gIH1cbn1cblxuY2xhc3MgTmF0aXZlU2NyaXB0UmVuZGVyZXIgaW1wbGVtZW50cyBSZW5kZXJlcjIge1xuICBwcml2YXRlIHZpZXdVdGlsID0gbmV3IFZpZXdVdGlsKHRoaXMubmFtZXNwYWNlRmlsdGVycywgdGhpcy5yZXVzZVZpZXdzKTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJvb3RWaWV3OiBWaWV3LCBwcml2YXRlIG5hbWVzcGFjZUZpbHRlcnM/OiBOYW1lc3BhY2VGaWx0ZXJbXSwgcHJpdmF0ZSByZXVzZVZpZXdzPzogYm9vbGVhbikge31cbiAgZ2V0IGRhdGEoKTogeyBba2V5OiBzdHJpbmddOiBhbnkgfSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdNZXRob2Qgbm90IGltcGxlbWVudGVkLicpO1xuICB9XG4gIGRlc3Ryb3koKTogdm9pZCB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmVuYWJsZWQpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJlbmRlcmVyTG9nKCdOYXRpdmVTY3JpcHRSZW5kZXJlci5kZXN0cm95Jyk7XG4gICAgfVxuICB9XG4gIGNyZWF0ZUVsZW1lbnQobmFtZTogc3RyaW5nLCBuYW1lc3BhY2U/OiBzdHJpbmcpIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuZW5hYmxlZCkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucmVuZGVyZXJMb2coYE5hdGl2ZVNjcmlwdFJlbmRlcmVyLmNyZWF0ZUVsZW1lbnQ6ICR7bmFtZX1gKTtcbiAgICB9XG4gICAgbGV0IG9sZE5hbWU7XG4gICAgaWYgKCFpc0tub3duVmlldyhuYW1lKSkge1xuICAgICAgb2xkTmFtZSA9IG5hbWU7XG4gICAgICBuYW1lID0gJ1Byb3h5Vmlld0NvbnRhaW5lcic7XG4gICAgfVxuICAgIGNvbnN0IHZpZXcgPSB0aGlzLnZpZXdVdGlsLmNyZWF0ZVZpZXcobmFtZSk7XG4gICAgaWYgKG9sZE5hbWUpIHtcbiAgICAgICh2aWV3IGFzIGFueSkuY3VzdG9tQ1NTTmFtZSA9IG9sZE5hbWU7XG4gICAgfVxuICAgIHJldHVybiB2aWV3O1xuICB9XG4gIGNyZWF0ZUNvbW1lbnQodmFsdWU6IHN0cmluZykge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5lbmFibGVkKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yZW5kZXJlckxvZyhgTmF0aXZlU2NyaXB0UmVuZGVyZXIuY3JlYXRlQ29tbWVudCAke3ZhbHVlfWApO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy52aWV3VXRpbC5jcmVhdGVDb21tZW50KHZhbHVlKTtcbiAgfVxuICBjcmVhdGVUZXh0KHZhbHVlOiBzdHJpbmcpIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuZW5hYmxlZCkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucmVuZGVyZXJMb2coYE5hdGl2ZVNjcmlwdFJlbmRlcmVyLmNyZWF0ZVRleHQgJHt2YWx1ZX1gKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMudmlld1V0aWwuY3JlYXRlVGV4dCh2YWx1ZSk7XG4gIH1cbiAgZGVzdHJveU5vZGU6IChub2RlOiBhbnkpID0+IHZvaWQgPSAobm9kZTogVmlldykgPT4ge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5lbmFibGVkKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yZW5kZXJlckxvZyhgTmF0aXZlU2NyaXB0UmVuZGVyZXIuZGVzdHJveU5vZGUgbm9kZTogJHtub2RlfWApO1xuICAgIH1cbiAgICBpZiAobm9kZT8uZGVzdHJveU5vZGUpIHtcbiAgICAgIG5vZGU/LmRlc3Ryb3lOb2RlKCk7XG4gICAgfVxuICB9O1xuICBhcHBlbmRDaGlsZChwYXJlbnQ6IFZpZXcsIG5ld0NoaWxkOiBWaWV3KTogdm9pZCB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmVuYWJsZWQpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJlbmRlcmVyTG9nKGBOYXRpdmVTY3JpcHRSZW5kZXJlci5hcHBlbmRDaGlsZCBjaGlsZDogJHtuZXdDaGlsZH0gcGFyZW50OiAke3BhcmVudH1gKTtcbiAgICB9XG4gICAgdGhpcy52aWV3VXRpbC5hcHBlbmRDaGlsZChwYXJlbnQsIG5ld0NoaWxkKTtcbiAgfVxuICBpbnNlcnRCZWZvcmUocGFyZW50OiBhbnksIG5ld0NoaWxkOiBhbnksIHJlZkNoaWxkOiBhbnkpOiB2b2lkIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuZW5hYmxlZCkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucmVuZGVyZXJMb2coYE5hdGl2ZVNjcmlwdFJlbmRlcmVyLmluc2VydEJlZm9yZSBjaGlsZDogJHtuZXdDaGlsZH0gYCArIGBwYXJlbnQ6ICR7cGFyZW50fSByZWZDaGlsZDogJHtyZWZDaGlsZH1gKTtcbiAgICB9XG4gICAgdGhpcy52aWV3VXRpbC5pbnNlcnRCZWZvcmUocGFyZW50LCBuZXdDaGlsZCwgcmVmQ2hpbGQpO1xuICB9XG4gIHJlbW92ZUNoaWxkKHBhcmVudDogYW55LCBvbGRDaGlsZDogYW55LCBpc0hvc3RFbGVtZW50PzogYm9vbGVhbik6IHZvaWQge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5lbmFibGVkKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yZW5kZXJlckxvZyhgTmF0aXZlU2NyaXB0UmVuZGVyZXIucmVtb3ZlQ2hpbGQgY2hpbGQ6ICR7b2xkQ2hpbGR9IHBhcmVudDogJHtwYXJlbnR9YCk7XG4gICAgfVxuICAgIHRoaXMudmlld1V0aWwucmVtb3ZlQ2hpbGQocGFyZW50LCBvbGRDaGlsZCk7XG4gIH1cbiAgc2VsZWN0Um9vdEVsZW1lbnQoc2VsZWN0b3JPck5vZGU6IGFueSwgcHJlc2VydmVDb250ZW50PzogYm9vbGVhbikge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5lbmFibGVkKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yZW5kZXJlckxvZyhgTmF0aXZlU2NyaXB0UmVuZGVyZXIuc2VsZWN0Um9vdEVsZW1lbnQ6ICR7c2VsZWN0b3JPck5vZGV9YCk7XG4gICAgfVxuICAgIGlmIChzZWxlY3Rvck9yTm9kZSBpbnN0YW5jZW9mIFZpZXcpIHtcbiAgICAgIHJldHVybiBzZWxlY3Rvck9yTm9kZTtcbiAgICB9XG4gICAgaWYgKHNlbGVjdG9yT3JOb2RlICYmIHNlbGVjdG9yT3JOb2RlWzBdID09PSAnIycpIHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGdldFZpZXdCeUlkKHRoaXMucm9vdFZpZXcsIHNlbGVjdG9yT3JOb2RlLnNsaWNlKDEpKTtcbiAgICAgIHJldHVybiAocmVzdWx0IHx8IHRoaXMucm9vdFZpZXcpIGFzIFZpZXc7XG4gICAgfVxuICAgIGlmICh0eXBlb2Ygc2VsZWN0b3JPck5vZGUgPT09ICdzdHJpbmcnKSB7XG4gICAgICBjb25zdCB2aWV3ID0gdGhpcy52aWV3VXRpbC5jcmVhdGVWaWV3KHNlbGVjdG9yT3JOb2RlKTtcbiAgICAgIGlmIChnZXRGaXJzdE5hdGl2ZUxpa2VWaWV3KHZpZXcpID09PSB2aWV3KSB7XG4gICAgICAgIC8vIHZpZXcgaXMgbmF0aXZlbGlrZSFcbiAgICAgICAgdGhpcy5hcHBlbmRDaGlsZCh0aGlzLnJvb3RWaWV3LCB2aWV3KTtcbiAgICAgICAgcmV0dXJuIHZpZXc7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnJvb3RWaWV3O1xuICB9XG4gIHBhcmVudE5vZGUobm9kZTogTmdWaWV3KSB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmVuYWJsZWQpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJlbmRlcmVyTG9nKGBOYXRpdmVTY3JpcHRSZW5kZXJlci5wYXJlbnROb2RlIGZvciBub2RlOiAke25vZGV9IGlzICR7bm9kZS5wYXJlbnROb2RlfWApO1xuICAgIH1cbiAgICByZXR1cm4gbm9kZS5wYXJlbnROb2RlO1xuICB9XG4gIG5leHRTaWJsaW5nKG5vZGU6IE5nVmlldykge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5lbmFibGVkKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yZW5kZXJlckxvZyhgTmF0aXZlU2NyaXB0UmVuZGVyZXIubmV4dFNpYmxpbmcgb2YgJHtub2RlfSBpcyAke25vZGUubmV4dFNpYmxpbmd9YCk7XG4gICAgfVxuICAgIHJldHVybiBub2RlLm5leHRTaWJsaW5nO1xuICB9XG4gIHNldEF0dHJpYnV0ZShlbDogYW55LCBuYW1lOiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcsIG5hbWVzcGFjZT86IHN0cmluZyk6IHZvaWQge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5lbmFibGVkKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yZW5kZXJlckxvZyhgTmF0aXZlU2NyaXB0UmVuZGVyZXIuc2V0QXR0cmlidXRlICR7bmFtZXNwYWNlID8gbmFtZXNwYWNlICsgJzonIDogJyd9JHtlbH0uJHtuYW1lfSA9ICR7dmFsdWV9YCk7XG4gICAgfVxuICAgIHRoaXMudmlld1V0aWwuc2V0UHJvcGVydHkoZWwsIG5hbWUsIHZhbHVlLCBuYW1lc3BhY2UpO1xuICB9XG4gIHJlbW92ZUF0dHJpYnV0ZShlbDogYW55LCBuYW1lOiBzdHJpbmcsIG5hbWVzcGFjZT86IHN0cmluZyk6IHZvaWQge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5lbmFibGVkKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yZW5kZXJlckxvZyhgTmF0aXZlU2NyaXB0UmVuZGVyZXIucmVtb3ZlQXR0cmlidXRlICR7bmFtZXNwYWNlID8gbmFtZXNwYWNlICsgJzonIDogJyd9JHtlbH0uJHtuYW1lfWApO1xuICAgIH1cbiAgfVxuICBhZGRDbGFzcyhlbDogYW55LCBuYW1lOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuZW5hYmxlZCkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucmVuZGVyZXJMb2coYE5hdGl2ZVNjcmlwdFJlbmRlcmVyLmFkZENsYXNzICR7bmFtZX1gKTtcbiAgICB9XG4gICAgdGhpcy52aWV3VXRpbC5hZGRDbGFzcyhlbCwgbmFtZSk7XG4gIH1cbiAgcmVtb3ZlQ2xhc3MoZWw6IGFueSwgbmFtZTogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmVuYWJsZWQpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJlbmRlcmVyTG9nKGBOYXRpdmVTY3JpcHRSZW5kZXJlci5yZW1vdmVDbGFzcyAke25hbWV9YCk7XG4gICAgfVxuICAgIHRoaXMudmlld1V0aWwucmVtb3ZlQ2xhc3MoZWwsIG5hbWUpO1xuICB9XG4gIHNldFN0eWxlKGVsOiBhbnksIHN0eWxlOiBzdHJpbmcsIHZhbHVlOiBhbnksIGZsYWdzPzogUmVuZGVyZXJTdHlsZUZsYWdzMik6IHZvaWQge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5lbmFibGVkKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yZW5kZXJlckxvZyhgTmF0aXZlU2NyaXB0UmVuZGVyZXIuc2V0U3R5bGU6ICR7ZWx9LCAke3N0eWxlfSA9ICR7dmFsdWV9YCk7XG4gICAgfVxuICAgIHRoaXMudmlld1V0aWwuc2V0U3R5bGUoZWwsIHN0eWxlLCB2YWx1ZSk7XG4gIH1cbiAgcmVtb3ZlU3R5bGUoZWw6IGFueSwgc3R5bGU6IHN0cmluZywgZmxhZ3M/OiBSZW5kZXJlclN0eWxlRmxhZ3MyKTogdm9pZCB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmVuYWJsZWQpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJlbmRlcmVyTG9nKCdOYXRpdmVTY3JpcHRSZW5kZXJlci5yZW1vdmVTdHlsZTogJHtzdHlsZU5hbWV9Jyk7XG4gICAgfVxuICAgIHRoaXMudmlld1V0aWwucmVtb3ZlU3R5bGUoZWwsIHN0eWxlKTtcbiAgfVxuICBzZXRQcm9wZXJ0eShlbDogYW55LCBuYW1lOiBzdHJpbmcsIHZhbHVlOiBhbnkpOiB2b2lkIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuZW5hYmxlZCkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucmVuZGVyZXJMb2coYE5hdGl2ZVNjcmlwdFJlbmRlcmVyLnNldFByb3BlcnR5ICR7ZWx9LiR7bmFtZX0gPSAke3ZhbHVlfWApO1xuICAgIH1cbiAgICB0aGlzLnZpZXdVdGlsLnNldFByb3BlcnR5KGVsLCBuYW1lLCB2YWx1ZSk7XG4gIH1cbiAgc2V0VmFsdWUobm9kZTogYW55LCB2YWx1ZTogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmVuYWJsZWQpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJlbmRlcmVyTG9nKGBOYXRpdmVTY3JpcHRSZW5kZXJlci5zZXRWYWx1ZSByZW5kZXJOb2RlOiAke25vZGV9LCB2YWx1ZTogJHt2YWx1ZX1gKTtcbiAgICB9XG4gICAgLy8gdGhyb3cgbmV3IEVycm9yKFwiTWV0aG9kIG5vdCBpbXBsZW1lbnRlZC5cIik7XG4gIH1cbiAgbGlzdGVuKHRhcmdldDogVmlldywgZXZlbnROYW1lOiBzdHJpbmcsIGNhbGxiYWNrOiAoZXZlbnQ6IGFueSkgPT4gYm9vbGVhbiB8IHZvaWQpOiAoKSA9PiB2b2lkIHtcbiAgICAvLyB0aHJvdyBuZXcgRXJyb3IoXCJNZXRob2Qgbm90IGltcGxlbWVudGVkLlwiKTtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuZW5hYmxlZCkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucmVuZGVyZXJMb2coYE5hdGl2ZVNjcmlwdFJlbmRlcmVyLmxpc3RlbjogJHtldmVudE5hbWV9YCk7XG4gICAgfVxuICAgIHRhcmdldC5vbihldmVudE5hbWUsIGNhbGxiYWNrKTtcbiAgICBpZiAoZXZlbnROYW1lID09PSBWaWV3LmxvYWRlZEV2ZW50ICYmIHRhcmdldC5pc0xvYWRlZCkge1xuICAgICAgLy8gd2UgbXVzdCBjcmVhdGUgYSBuZXcgb2JlcnZhYmxlIGhlcmUgdG8gZW5zdXJlIHRoYXQgdGhlIGV2ZW50IGdvZXMgdGhyb3VnaCB3aGF0ZXZlciB6b25lIHBhdGNoZXMgYXJlIGFwcGxpZWRcbiAgICAgIGNvbnN0IG9icyA9IG5ldyBPYnNlcnZhYmxlKCk7XG4gICAgICBvYnMub25jZShldmVudE5hbWUsIGNhbGxiYWNrKTtcbiAgICAgIG9icy5ub3RpZnkoe1xuICAgICAgICBldmVudE5hbWUsXG4gICAgICAgIG9iamVjdDogdGFyZ2V0LFxuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiAoKSA9PiB0YXJnZXQub2ZmKGV2ZW50TmFtZSwgY2FsbGJhY2spO1xuICB9XG59XG5cbi8vIENPTlRFTlRfQVRUUiBub3QgZXhwb3J0ZWQgZnJvbSBuYXRpdmVzY3JpcHQtcmVuZGVyZXIgLSB3ZSBuZWVkIGl0IGZvciBzdHlsZXMgYXBwbGljYXRpb24uXG5jb25zdCBDT01QT05FTlRfUkVHRVggPSAvJUNPTVAlL2c7XG5jb25zdCBBVFRSX1NBTklUSVpFUiA9IC8tL2c7XG5leHBvcnQgY29uc3QgQ09NUE9ORU5UX1ZBUklBQkxFID0gJyVDT01QJSc7XG5leHBvcnQgY29uc3QgSE9TVF9BVFRSID0gYF9uZ2hvc3QtJHtDT01QT05FTlRfVkFSSUFCTEV9YDtcbmV4cG9ydCBjb25zdCBDT05URU5UX0FUVFIgPSBgX25nY29udGVudC0ke0NPTVBPTkVOVF9WQVJJQUJMRX1gO1xuXG5jb25zdCByZXBsYWNlTmdBdHRyaWJ1dGUgPSBmdW5jdGlvbiAoaW5wdXQ6IHN0cmluZywgY29tcG9uZW50SWQ6IHN0cmluZyk6IHN0cmluZyB7XG4gIHJldHVybiBpbnB1dC5yZXBsYWNlKENPTVBPTkVOVF9SRUdFWCwgY29tcG9uZW50SWQpO1xufTtcblxuY29uc3QgYWRkU2NvcGVkU3R5bGVUb0NzcyA9IHByb2ZpbGUoYFwicmVuZGVyZXJcIi5hZGRTY29wZWRTdHlsZVRvQ3NzYCwgZnVuY3Rpb24gYWRkU2NvcGVkU3R5bGVUb0NzcyhzdHlsZTogc3RyaW5nLCB0YWc/OiBudW1iZXIgfCBzdHJpbmcpOiB2b2lkIHtcbiAgaWYgKHRhZykge1xuICAgIGFkZFRhZ2dlZEFkZGl0aW9uYWxDU1Moc3R5bGUsIHRhZyk7XG4gIH0gZWxzZSB7XG4gICAgQXBwbGljYXRpb24uYWRkQ3NzKHN0eWxlKTtcbiAgfVxufSk7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBFbXVsYXRlZFJlbmRlcmVyIGV4dGVuZHMgTmF0aXZlU2NyaXB0UmVuZGVyZXIge1xuICBwcml2YXRlIGNvbnRlbnRBdHRyOiBzdHJpbmc7XG4gIHByaXZhdGUgaG9zdEF0dHI6IHN0cmluZztcblxuICBjb25zdHJ1Y3Rvcihjb21wb25lbnQ6IFJlbmRlcmVyVHlwZTIsIHJvb3RWaWV3OiBWaWV3LCBuYW1lc3BhY2VGaWx0ZXJzOiBOYW1lc3BhY2VGaWx0ZXJbXSwgcHJpdmF0ZSByb290TW9kdWxlSWQ6IHN0cmluZyB8IG51bWJlciwgcmV1c2VWaWV3czogYm9vbGVhbikge1xuICAgIHN1cGVyKHJvb3RWaWV3LCBuYW1lc3BhY2VGaWx0ZXJzLCByZXVzZVZpZXdzKTtcblxuICAgIGNvbnN0IGNvbXBvbmVudElkID0gY29tcG9uZW50LmlkLnJlcGxhY2UoQVRUUl9TQU5JVElaRVIsICdfJyk7XG4gICAgdGhpcy5jb250ZW50QXR0ciA9IHJlcGxhY2VOZ0F0dHJpYnV0ZShDT05URU5UX0FUVFIsIGNvbXBvbmVudElkKTtcbiAgICB0aGlzLmhvc3RBdHRyID0gcmVwbGFjZU5nQXR0cmlidXRlKEhPU1RfQVRUUiwgY29tcG9uZW50SWQpO1xuICAgIHRoaXMuYWRkU3R5bGVzKGNvbXBvbmVudC5zdHlsZXMsIGNvbXBvbmVudElkKTtcbiAgfVxuXG4gIGFwcGx5VG9Ib3N0KHZpZXc6IE5nVmlldykge1xuICAgIHN1cGVyLnNldEF0dHJpYnV0ZSh2aWV3LCB0aGlzLmhvc3RBdHRyLCAnJyk7XG4gIH1cblxuICBhcHBlbmRDaGlsZChwYXJlbnQ6IGFueSwgbmV3Q2hpbGQ6IE5nVmlldyk6IHZvaWQge1xuICAgIHN1cGVyLmFwcGVuZENoaWxkKHBhcmVudCwgbmV3Q2hpbGQpO1xuICB9XG5cbiAgY3JlYXRlRWxlbWVudChwYXJlbnQ6IGFueSwgbmFtZTogc3RyaW5nKTogTmdWaWV3IHtcbiAgICBjb25zdCB2aWV3ID0gc3VwZXIuY3JlYXRlRWxlbWVudChwYXJlbnQsIG5hbWUpO1xuXG4gICAgLy8gU2V0IGFuIGF0dHJpYnV0ZSB0byB0aGUgdmlldyB0byBzY29wZSBjb21wb25lbnQtc3BlY2lmaWMgY3NzLlxuICAgIC8vIFRoZSBwcm9wZXJ0eSBuYW1lIGlzIHByZS1nZW5lcmF0ZWQgYnkgQW5ndWxhci5cbiAgICBzdXBlci5zZXRBdHRyaWJ1dGUodmlldywgdGhpcy5jb250ZW50QXR0ciwgJycpO1xuXG4gICAgcmV0dXJuIHZpZXc7XG4gIH1cblxuICBAcHJvZmlsZVxuICBwcml2YXRlIGFkZFN0eWxlcyhzdHlsZXM6IChzdHJpbmcgfCBhbnlbXSlbXSwgY29tcG9uZW50SWQ6IHN0cmluZykge1xuICAgIHN0eWxlc1xuICAgICAgLm1hcCgocykgPT4gcy50b1N0cmluZygpKVxuICAgICAgLm1hcCgocykgPT4gcmVwbGFjZU5nQXR0cmlidXRlKHMsIGNvbXBvbmVudElkKSlcbiAgICAgIC5mb3JFYWNoKChzKSA9PiBhZGRTY29wZWRTdHlsZVRvQ3NzKHMsIHRoaXMucm9vdE1vZHVsZUlkKSk7XG4gIH1cbn1cbiJdfQ==