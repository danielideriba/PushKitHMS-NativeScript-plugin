import { unsetValue } from '@nativescript/core';
import { getViewClass, getViewMeta, isKnownView } from './element-registry';
import { CommentNode, TextNode, isDetachedElement, isInvisibleNode, isView, isContentView, isLayout } from './views';
import { NativeScriptDebug } from './trace';
const ELEMENT_NODE_TYPE = 1;
const XML_ATTRIBUTES = Object.freeze(['style', 'rows', 'columns', 'fontAttributes']);
const whiteSpaceSplitter = /\s+/;
function printNgTree(view) {
    let parent = view;
    while (parent.parent && parent.parent.firstChild) {
        parent = parent.parent;
    }
    printChildrenRecurse(parent);
}
function printChildrenRecurse(parent) {
    const children = parent.firstChild ? [parent.firstChild, ...getChildrenSiblings(parent.firstChild).nextSiblings] : [];
    console.log(`parent: ${parent}, firstChild: ${parent.firstChild}, lastChild: ${parent.lastChild} children: ${children}`);
    if (parent.firstChild) {
        console.log(`----- start ${parent}`);
    }
    children.forEach((c) => printChildrenRecurse(c));
    if (parent.firstChild) {
        console.log(`----- end ${parent}`);
    }
}
function getChildrenSiblings(view) {
    const nextSiblings = [];
    const previousSiblings = [];
    let sibling = view.nextSibling;
    while (sibling) {
        nextSiblings.push(sibling);
        sibling = sibling.nextSibling;
    }
    sibling = view.previousSibling;
    while (sibling) {
        previousSiblings.push(sibling);
        sibling = sibling.previousSibling;
    }
    return {
        previousSiblings,
        nextSiblings,
    };
}
function printSiblingsTree(view) {
    const { previousSiblings, nextSiblings } = getChildrenSiblings(view);
    console.log(`${view} previousSiblings: ${previousSiblings} nextSiblings: ${nextSiblings}`);
}
const propertyMaps = new Map();
export class ViewUtil {
    constructor(namespaceFilters, reuseViews) {
        this.namespaceFilters = namespaceFilters;
        this.reuseViews = reuseViews;
    }
    /**
     * Inserts a child into a parrent, preferably before next.
     * @param parent parent view
     * @param child child view to be added
     * @param previous previous element. If present, insert after this.
     * @param next next element. If present, insert before this (previous is ignored).
     */
    insertChild(parent, child, previous, next) {
        if (!parent) {
            return;
        }
        const extendedParent = this.ensureNgViewExtensions(parent);
        const extendedChild = this.ensureNgViewExtensions(child);
        // if there's a next child, previous is the previousSibling of it
        if (next) {
            previous = next.previousSibling;
        }
        else if (previous) {
            // if there's a previous, next is the nextSibling of it
            next = previous.nextSibling;
        }
        else {
            // no previous or next, append to the parent
            previous = extendedParent.lastChild; // this can still be undefined if the parent has no children!
        }
        this.insertInList(extendedParent, extendedChild, previous, next);
        if (isInvisibleNode(child)) {
            extendedChild.parentNode = extendedParent;
        }
        if (!isDetachedElement(child)) {
            const nextVisual = this.findNextVisual(next);
            this.addToVisualTree(extendedParent, extendedChild, nextVisual);
        }
        // printNgTree(extendedChild);
    }
    insertBefore(parent, child, refChild) {
        const extendedRef = refChild ? this.ensureNgViewExtensions(refChild) : undefined;
        this.insertChild(parent, child, undefined, extendedRef);
    }
    insertAfter(parent, child, refChild) {
        const extendedRef = refChild ? this.ensureNgViewExtensions(refChild) : undefined;
        this.insertChild(parent, child, extendedRef);
    }
    appendChild(parent, child) {
        this.insertChild(parent, child);
    }
    /**
     * Inserts a view into the parent/sibling linked list
     * !WARNING: this method makes no checks to validate the integrity of previous/next children
     * @param parent parent view
     * @param child child view
     * @param previous previous element. null/undefined for first element
     * @param next next element. null/undefined for last element
     */
    insertInList(parent, child, previous, next) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`ViewUtil.insertInList parent: ${parent}, view: ${child}, ` + `previous: ${previous}, next: ${next}`);
        }
        if (previous) {
            previous.nextSibling = child;
            child.previousSibling = previous;
        }
        else {
            parent.firstChild = child;
        }
        if (next) {
            child.nextSibling = next;
            next.previousSibling = child;
        }
        else {
            parent.lastChild = child;
        }
    }
    addToVisualTree(parent, child, next) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`ViewUtil.addToVisualTree parent: ${parent}, view: ${child}, next: ${next}`);
        }
        if (parent.meta && parent.meta.insertChild) {
            parent.meta.insertChild(parent, child, next);
        }
        else if (isLayout(parent)) {
            this.insertToLayout(parent, child, next);
        }
        else if (isContentView(parent)) {
            parent.content = child;
        }
        else if (parent && parent._addChildFromBuilder) {
            parent._addChildFromBuilder(child.nodeName, child);
        }
    }
    insertToLayout(parent, child, next) {
        if (child.parent === parent) {
            this.removeLayoutChild(parent, child);
        }
        const nextVisual = this.findNextVisual(next);
        if (nextVisual) {
            const index = parent.getChildIndex(nextVisual);
            parent.insertChild(child, index);
        }
        else {
            parent.addChild(child);
        }
        // parent.eachChild((c) => {console.log(c); return true});
    }
    findNextVisual(view) {
        let next = view;
        while (next && isDetachedElement(next)) {
            next = next.nextSibling;
        }
        return next;
    }
    removeChild(parent, child) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`ViewUtil.removeChild parent: ${parent} child: ${child}`);
        }
        if (!parent) {
            return;
        }
        const extendedParent = this.ensureNgViewExtensions(parent);
        const extendedChild = this.ensureNgViewExtensions(child);
        this.removeFromList(extendedParent, extendedChild);
        if (!isDetachedElement(extendedChild)) {
            this.removeFromVisualTree(extendedParent, extendedChild);
        }
    }
    removeFromList(parent, child) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`ViewUtil.removeFromList parent: ${parent} child: ${child}`);
        }
        if (parent.firstChild === child && parent.lastChild === child) {
            parent.firstChild = null;
            parent.lastChild = null;
            child.nextSibling = null;
            child.previousSibling = null;
            return;
        }
        if (parent.firstChild === child) {
            parent.firstChild = child.nextSibling;
        }
        const previous = child.previousSibling;
        if (parent.lastChild === child) {
            parent.lastChild = previous;
        }
        if (previous) {
            previous.nextSibling = child.nextSibling;
            if (child.nextSibling) {
                child.nextSibling.previousSibling = previous;
            }
        }
        child.nextSibling = null;
        child.previousSibling = null;
    }
    // NOTE: This one is O(n) - use carefully
    findPreviousElement(parent, child) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`ViewUtil.findPreviousElement parent: ${parent} child: ${child}`);
        }
        let previousVisual;
        if (isLayout(parent)) {
            previousVisual = this.getPreviousVisualElement(parent, child);
        }
        let previous = previousVisual || parent.firstChild;
        // since detached elements are not added to the visual tree,
        // we need to find the actual previous sibling of the view,
        // which may as well be an invisible node
        while (previous && previous !== child && previous.nextSibling !== child) {
            previous = previous.nextSibling;
        }
        return previous;
    }
    getPreviousVisualElement(parent, child) {
        const elementIndex = parent.getChildIndex(child);
        if (elementIndex > 0) {
            return parent.getChildAt(elementIndex - 1);
        }
    }
    // NOTE: This one is O(n) - use carefully
    getChildIndex(parent, child) {
        if (isLayout(parent)) {
            return parent.getChildIndex(child);
        }
        else if (isContentView(parent)) {
            return child === parent.content ? 0 : -1;
        }
    }
    removeFromVisualTree(parent, child) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`ViewUtil.removeFromVisualTree parent: ${parent} child: ${child}`);
        }
        if (parent.meta && parent.meta.removeChild) {
            parent.meta.removeChild(parent, child);
        }
        else if (isLayout(parent)) {
            this.removeLayoutChild(parent, child);
        }
        else if (isContentView(parent) && parent.content === child) {
            parent.content = null;
        }
        else if (isView(parent)) {
            parent._removeView(child);
        }
    }
    removeLayoutChild(parent, child) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`ViewUtil.removeLayoutChild parent: ${parent} child: ${child}`);
        }
        const index = parent.getChildIndex(child);
        if (index !== -1) {
            parent.removeChild(child);
        }
    }
    createComment(value) {
        return new CommentNode(value);
    }
    createText(value) {
        return new TextNode(value);
    }
    createView(name) {
        const originalName = name;
        if (!isKnownView(name)) {
            name = 'ProxyViewContainer';
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`Creating view: ${originalName} ${name}`);
        }
        const viewClass = getViewClass(name);
        const view = new viewClass();
        const ngView = this.setNgViewExtensions(view, name);
        ngView.reusable = !!this.reuseViews;
        return ngView;
    }
    ensureNgViewExtensions(view) {
        if (view.hasOwnProperty('meta')) {
            return view;
        }
        else {
            const name = view.cssType;
            const ngView = this.setNgViewExtensions(view, name);
            return ngView;
        }
    }
    setNgViewExtensions(view, name) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`Make into a NgView view: ${view} name: "${name}"`);
        }
        const ngView = view;
        ngView.nodeName = name;
        ngView.meta = getViewMeta(name);
        // we're setting the node type of the view
        // to 'element' because of checks done in the
        // dom animation engine
        ngView.nodeType = ELEMENT_NODE_TYPE;
        return ngView;
    }
    setProperty(view, attributeName, value, namespace) {
        if (!view || (namespace && !this.runsIn(namespace))) {
            return;
        }
        if (attributeName.indexOf('.') !== -1) {
            // Handle nested properties
            const properties = attributeName.split('.');
            attributeName = properties[properties.length - 1];
            let propMap = this.getProperties(view);
            let i = 0;
            while (i < properties.length - 1 && typeof view !== 'undefined') {
                let prop = properties[i];
                if (propMap.has(prop)) {
                    prop = propMap.get(prop);
                }
                view = view[prop];
                propMap = this.getProperties(view);
                i++;
            }
        }
        if (typeof view !== 'undefined') {
            this.setPropertyInternal(view, attributeName, value);
        }
    }
    runsIn(platform) {
        let runs = true;
        const last = () => true;
        if (this.namespaceFilters) {
            let chain = (p) => true;
            for (let i = this.namespaceFilters.length - 1; i >= 0; i--) {
                const currentChain = chain;
                chain = (p) => this.namespaceFilters[i].runsIn(p, currentChain);
            }
            runs = chain(platform);
            runs = runs !== false ? true : false; // undefined means true
            // this.namespaceFilters.some((filter) => {
            // 	const runsInFilter = filter.runsIn(platform);
            // 	if (runsInFilter !== undefined) {
            // 		runs = runsInFilter;
            // 		return true;
            // 	}
            // });
        }
        return runs;
    }
    setPropertyInternal(view, attributeName, value) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.viewUtilLog(`Setting attribute: ${attributeName}=${value} to ${view}`);
        }
        if (attributeName === 'class') {
            this.setClasses(view, value);
            return;
        }
        if (XML_ATTRIBUTES.indexOf(attributeName) !== -1) {
            view[attributeName] = value;
            return;
        }
        const propMap = this.getProperties(view);
        const propertyName = propMap.get(attributeName);
        // Ensure the children of a collection currently have no parent set.
        if (Array.isArray(value)) {
            this.removeParentReferencesFromItems(value);
        }
        if (propertyName) {
            // We have a lower-upper case mapped property.
            view[propertyName] = value;
            return;
        }
        // Unknown attribute value -- just set it to our object as is.
        view[attributeName] = value;
    }
    removeParentReferencesFromItems(items) {
        for (const item of items) {
            if (item.parent && item.parentNode) {
                if (NativeScriptDebug.isLogEnabled()) {
                    NativeScriptDebug.viewUtilLog(`Unassigning parent ${item.parentNode} on value: ${item}`);
                }
                item.parent = undefined;
                item.parentNode = undefined;
            }
        }
    }
    getProperties(instance) {
        const type = instance && instance.constructor;
        if (!type) {
            return new Map();
        }
        if (!propertyMaps.has(type)) {
            let propMap = new Map();
            for (let propName in instance) {
                // tslint:disable:forin
                propMap.set(propName.toLowerCase(), propName);
            }
            propertyMaps.set(type, propMap);
        }
        return propertyMaps.get(type);
    }
    cssClasses(view) {
        if (!view.ngCssClasses) {
            view.ngCssClasses = new Map();
        }
        return view.ngCssClasses;
    }
    addClass(view, className) {
        const extendedView = this.ensureNgViewExtensions(view);
        this.cssClasses(extendedView).set(className, true);
        this.syncClasses(extendedView);
    }
    removeClass(view, className) {
        const extendedView = this.ensureNgViewExtensions(view);
        this.cssClasses(extendedView).delete(className);
        this.syncClasses(extendedView);
    }
    setClasses(view, classesValue) {
        let classes = classesValue.split(whiteSpaceSplitter);
        this.cssClasses(view).clear();
        classes.forEach((className) => this.cssClasses(view).set(className, true));
        this.syncClasses(view);
    }
    syncClasses(view) {
        let classValue = Array.from(this.cssClasses(view).keys()).join(' ');
        view.className = classValue;
    }
    setStyle(view, styleName, value) {
        view.style[styleName] = value;
    }
    removeStyle(view, styleName) {
        view.style[styleName] = unsetValue;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlldy11dGlsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2xpYi92aWV3LXV0aWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFRLFVBQVUsRUFBNEQsTUFBTSxvQkFBb0IsQ0FBQztBQUNoSCxPQUFPLEVBQUUsWUFBWSxFQUFFLFdBQVcsRUFBRSxXQUFXLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUM1RSxPQUFPLEVBQUUsV0FBVyxFQUFVLFFBQVEsRUFBa0IsaUJBQWlCLEVBQUUsZUFBZSxFQUFFLE1BQU0sRUFBRSxhQUFhLEVBQUUsUUFBUSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBRzdJLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUc1QyxNQUFNLGlCQUFpQixHQUFHLENBQUMsQ0FBQztBQUM1QixNQUFNLGNBQWMsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDO0FBQ3JGLE1BQU0sa0JBQWtCLEdBQUcsS0FBSyxDQUFDO0FBSWpDLFNBQVMsV0FBVyxDQUFDLElBQVk7SUFDL0IsSUFBSSxNQUFNLEdBQUcsSUFBSSxDQUFDO0lBQ2xCLE9BQU8sTUFBTSxDQUFDLE1BQU0sSUFBSyxNQUFNLENBQUMsTUFBaUIsQ0FBQyxVQUFVLEVBQUU7UUFDNUQsTUFBTSxHQUFHLE1BQU0sQ0FBQyxNQUFnQixDQUFDO0tBQ2xDO0lBQ0Qsb0JBQW9CLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDL0IsQ0FBQztBQUNELFNBQVMsb0JBQW9CLENBQUMsTUFBYztJQUMxQyxNQUFNLFFBQVEsR0FBRyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFVLEVBQUUsR0FBRyxtQkFBbUIsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMs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LENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDM0UsSUFBSSxDQUFDLFNBQVMsR0FBRyxVQUFVLENBQUM7SUFDOUIsQ0FBQztJQUVNLFFBQVEsQ0FBQyxJQUFVLEVBQUUsU0FBaUIsRUFBRSxLQUFVO1FBQ3ZELElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLEdBQUcsS0FBSyxDQUFDO0lBQ2hDLENBQUM7SUFFTSxXQUFXLENBQUMsSUFBVSxFQUFFLFNBQWlCO1FBQzlDLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLEdBQUcsVUFBVSxDQUFDO0lBQ3JDLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFZpZXcsIHVuc2V0VmFsdWUsIFBsYWNlaG9sZGVyLCBDb250ZW50VmlldywgTGF5b3V0QmFzZSwgUHJveHlWaWV3Q29udGFpbmVyIH0gZnJvbSAnQG5hdGl2ZXNjcmlwdC9jb3JlJztcbmltcG9ydCB7IGdldFZpZXdDbGFzcywgZ2V0Vmlld01ldGEsIGlzS25vd25WaWV3IH0gZnJvbSAnLi9lbGVtZW50LXJlZ2lzdHJ5JztcbmltcG9ydCB7IENvbW1lbnROb2RlLCBOZ1ZpZXcsIFRleHROb2RlLCBWaWV3RXh0ZW5zaW9ucywgaXNEZXRhY2hlZEVsZW1lbnQsIGlzSW52aXNpYmxlTm9kZSwgaXNWaWV3LCBpc0NvbnRlbnRWaWV3LCBpc0xheW91dCB9IGZyb20gJy4vdmlld3MnO1xuaW1wb3J0IHsgTmFtZXNwYWNlRmlsdGVyIH0gZnJvbSAnLi9wcm9wZXJ0eS1maWx0ZXInO1xuXG5pbXBvcnQgeyBOYXRpdmVTY3JpcHREZWJ1ZyB9IGZyb20gJy4vdHJhY2UnO1xuaW1wb3J0IHsgTmdMYXlvdXRCYXNlIH0gZnJvbSAnLi92aWV3cy92aWV3LXR5cGVzJztcblxuY29uc3QgRUxFTUVOVF9OT0RFX1RZUEUgPSAxO1xuY29uc3QgWE1MX0FUVFJJQlVURVMgPSBPYmplY3QuZnJlZXplKFsnc3R5bGUnLCAncm93cycsICdjb2x1bW5zJywgJ2ZvbnRBdHRyaWJ1dGVzJ10pO1xuY29uc3Qgd2hpdGVTcGFjZVNwbGl0dGVyID0gL1xccysvO1xuXG5leHBvcnQgdHlwZSBCZWZvcmVBdHRhY2hBY3Rpb24gPSAodmlldzogVmlldykgPT4gdm9pZDtcblxuZnVuY3Rpb24gcHJpbnROZ1RyZWUodmlldzogTmdWaWV3KSB7XG4gIGxldCBwYXJlbnQgPSB2aWV3O1xuICB3aGlsZSAocGFyZW50LnBhcmVudCAmJiAocGFyZW50LnBhcmVudCBhcyBOZ1ZpZXcpLmZpcnN0Q2hpbGQpIHtcbiAgICBwYXJlbnQgPSBwYXJlbnQucGFyZW50IGFzIE5nVmlldztcbiAgfVxuICBwcmludENoaWxkcmVuUmVjdXJzZShwYXJlbnQpO1xufVxuZnVuY3Rpb24gcHJpbnRDaGlsZHJlblJlY3Vyc2UocGFyZW50OiBOZ1ZpZXcpIHtcbiAgY29uc3QgY2hpbGRyZW4gPSBwYXJlbnQuZmlyc3RDaGlsZCA/IFtwYXJlbnQuZmlyc3RDaGlsZCwgLi4uZ2V0Q2hpbGRyZW5TaWJsaW5ncyhwYXJlbnQuZmlyc3RDaGlsZCkubmV4dFNpYmxpbmdzXSA6IFtdO1xuICBjb25zb2xlLmxvZyhgcGFyZW50OiAke3BhcmVudH0sIGZpcnN0Q2hpbGQ6ICR7cGFyZW50LmZpcnN0Q2hpbGR9LCBsYXN0Q2hpbGQ6ICR7cGFyZW50Lmxhc3RDaGlsZH0gY2hpbGRyZW46ICR7Y2hpbGRyZW59YCk7XG4gIGlmIChwYXJlbnQuZmlyc3RDaGlsZCkge1xuICAgIGNvbnNvbGUubG9nKGAtLS0tLSBzdGFydCAke3BhcmVudH1gKTtcbiAgfVxuICBjaGlsZHJlbi5mb3JFYWNoKChjKSA9PiBwcmludENoaWxkcmVuUmVjdXJzZShjKSk7XG4gIGlmIChwYXJlbnQuZmlyc3RDaGlsZCkge1xuICAgIGNvbnNvbGUubG9nKGAtLS0tLSBlbmQgJHtwYXJlbnR9YCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gZ2V0Q2hpbGRyZW5TaWJsaW5ncyh2aWV3OiBOZ1ZpZXcpIHtcbiAgY29uc3QgbmV4dFNpYmxpbmdzID0gW107XG4gIGNvbnN0IHByZXZpb3VzU2libGluZ3MgPSBbXTtcbiAgbGV0IHNpYmxpbmcgPSB2aWV3Lm5leHRTaWJsaW5nO1xuICB3aGlsZSAoc2libGluZykge1xuICAgIG5leHRTaWJsaW5ncy5wdXNoKHNpYmxpbmcpO1xuICAgIHNpYmxpbmcgPSBzaWJsaW5nLm5leHRTaWJsaW5nO1xuICB9XG4gIHNpYmxpbmcgPSB2aWV3LnByZXZpb3VzU2libGluZztcbiAgd2hpbGUgKHNpYmxpbmcpIHtcbiAgICBwcmV2aW91c1NpYmxpbmdzLnB1c2goc2libGluZyk7XG4gICAgc2libGluZyA9IHNpYmxpbmcucHJldmlvdXNTaWJsaW5nO1xuICB9XG4gIHJldHVybiB7XG4gICAgcHJldmlvdXNTaWJsaW5ncyxcbiAgICBuZXh0U2libGluZ3MsXG4gIH07XG59XG5cbmZ1bmN0aW9uIHByaW50U2libGluZ3NUcmVlKHZpZXc6IE5nVmlldykge1xuICBjb25zdCB7IHByZXZpb3VzU2libGluZ3MsIG5leHRTaWJsaW5ncyB9ID0gZ2V0Q2hpbGRyZW5TaWJsaW5ncyh2aWV3KTtcbiAgY29uc29sZS5sb2coYCR7dmlld30gcHJldmlvdXNTaWJsaW5nczogJHtwcmV2aW91c1NpYmxpbmdzfSBuZXh0U2libGluZ3M6ICR7bmV4dFNpYmxpbmdzfWApO1xufVxuXG5jb25zdCBwcm9wZXJ0eU1hcHM6IE1hcDxGdW5jdGlvbiwgTWFwPHN0cmluZywgc3RyaW5nPj4gPSBuZXcgTWFwPEZ1bmN0aW9uLCBNYXA8c3RyaW5nLCBzdHJpbmc+PigpO1xuXG5leHBvcnQgY2xhc3MgVmlld1V0aWwge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIG5hbWVzcGFjZUZpbHRlcnM/OiBOYW1lc3BhY2VGaWx0ZXJbXSwgcHJpdmF0ZSByZXVzZVZpZXdzPzogYm9vbGVhbikge31cbiAgLyoqXG4gICAqIEluc2VydHMgYSBjaGlsZCBpbnRvIGEgcGFycmVudCwgcHJlZmVyYWJseSBiZWZvcmUgbmV4dC5cbiAgICogQHBhcmFtIHBhcmVudCBwYXJlbnQgdmlld1xuICAgKiBAcGFyYW0gY2hpbGQgY2hpbGQgdmlldyB0byBiZSBhZGRlZFxuICAgKiBAcGFyYW0gcHJldmlvdXMgcHJldmlvdXMgZWxlbWVudC4gSWYgcHJlc2VudCwgaW5zZXJ0IGFmdGVyIHRoaXMuXG4gICAqIEBwYXJhbSBuZXh0IG5leHQgZWxlbWVudC4gSWYgcHJlc2VudCwgaW5zZXJ0IGJlZm9yZSB0aGlzIChwcmV2aW91cyBpcyBpZ25vcmVkKS5cbiAgICovXG4gIHByaXZhdGUgaW5zZXJ0Q2hpbGQocGFyZW50OiBWaWV3LCBjaGlsZDogVmlldywgcHJldmlvdXM/OiBOZ1ZpZXcsIG5leHQ/OiBOZ1ZpZXcpIHtcbiAgICBpZiAoIXBhcmVudCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGV4dGVuZGVkUGFyZW50ID0gdGhpcy5lbnN1cmVOZ1ZpZXdFeHRlbnNpb25zKHBhcmVudCk7XG4gICAgY29uc3QgZXh0ZW5kZWRDaGlsZCA9IHRoaXMuZW5zdXJlTmdWaWV3RXh0ZW5zaW9ucyhjaGlsZCk7XG5cbiAgICAvLyBpZiB0aGVyZSdzIGEgbmV4dCBjaGlsZCwgcHJldmlvdXMgaXMgdGhlIHByZXZpb3VzU2libGluZyBvZiBpdFxuICAgIGlmIChuZXh0KSB7XG4gICAgICBwcmV2aW91cyA9IG5leHQucHJldmlvdXNTaWJsaW5nO1xuICAgIH0gZWxzZSBpZiAocHJldmlvdXMpIHtcbiAgICAgIC8vIGlmIHRoZXJlJ3MgYSBwcmV2aW91cywgbmV4dCBpcyB0aGUgbmV4dFNpYmxpbmcgb2YgaXRcbiAgICAgIG5leHQgPSBwcmV2aW91cy5uZXh0U2libGluZztcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gbm8gcHJldmlvdXMgb3IgbmV4dCwgYXBwZW5kIHRvIHRoZSBwYXJlbnRcbiAgICAgIHByZXZpb3VzID0gZXh0ZW5kZWRQYXJlbnQubGFzdENoaWxkOyAvLyB0aGlzIGNhbiBzdGlsbCBiZSB1bmRlZmluZWQgaWYgdGhlIHBhcmVudCBoYXMgbm8gY2hpbGRyZW4hXG4gICAgfVxuICAgIHRoaXMuaW5zZXJ0SW5MaXN0KGV4dGVuZGVkUGFyZW50LCBleHRlbmRlZENoaWxkLCBwcmV2aW91cywgbmV4dCk7XG5cbiAgICBpZiAoaXNJbnZpc2libGVOb2RlKGNoaWxkKSkge1xuICAgICAgZXh0ZW5kZWRDaGlsZC5wYXJlbnROb2RlID0gZXh0ZW5kZWRQYXJlbnQ7XG4gICAgfVxuXG4gICAgaWYgKCFpc0RldGFjaGVkRWxlbWVudChjaGlsZCkpIHtcbiAgICAgIGNvbnN0IG5leHRWaXN1YWwgPSB0aGlzLmZpbmROZXh0VmlzdWFsKG5leHQpO1xuICAgICAgdGhpcy5hZGRUb1Zpc3VhbFRyZWUoZXh0ZW5kZWRQYXJlbnQsIGV4dGVuZGVkQ2hpbGQsIG5leHRWaXN1YWwpO1xuICAgIH1cbiAgICAvLyBwcmludE5nVHJlZShleHRlbmRlZENoaWxkKTtcbiAgfVxuXG4gIHB1YmxpYyBpbnNlcnRCZWZvcmUocGFyZW50OiBWaWV3LCBjaGlsZDogVmlldywgcmVmQ2hpbGQ/OiBWaWV3IHwgTmdWaWV3KSB7XG4gICAgY29uc3QgZXh0ZW5kZWRSZWYgPSByZWZDaGlsZCA/IHRoaXMuZW5zdXJlTmdWaWV3RXh0ZW5zaW9ucyhyZWZDaGlsZCkgOiB1bmRlZmluZWQ7XG4gICAgdGhpcy5pbnNlcnRDaGlsZChwYXJlbnQsIGNoaWxkLCB1bmRlZmluZWQsIGV4dGVuZGVkUmVmKTtcbiAgfVxuICBwdWJsaWMgaW5zZXJ0QWZ0ZXIocGFyZW50OiBWaWV3LCBjaGlsZDogVmlldywgcmVmQ2hpbGQ/OiBWaWV3IHwgTmdWaWV3KSB7XG4gICAgY29uc3QgZXh0ZW5kZWRSZWYgPSByZWZDaGlsZCA/IHRoaXMuZW5zdXJlTmdWaWV3RXh0ZW5zaW9ucyhyZWZDaGlsZCkgOiB1bmRlZmluZWQ7XG4gICAgdGhpcy5pbnNlcnRDaGlsZChwYXJlbnQsIGNoaWxkLCBleHRlbmRlZFJlZik7XG4gIH1cblxuICBwdWJsaWMgYXBwZW5kQ2hpbGQocGFyZW50OiBWaWV3LCBjaGlsZDogVmlldykge1xuICAgIHRoaXMuaW5zZXJ0Q2hpbGQocGFyZW50LCBjaGlsZCk7XG4gIH1cblxuICAvKipcbiAgICogSW5zZXJ0cyBhIHZpZXcgaW50byB0aGUgcGFyZW50L3NpYmxpbmcgbGlua2VkIGxpc3RcbiAgICogIVdBUk5JTkc6IHRoaXMgbWV0aG9kIG1ha2VzIG5vIGNoZWNrcyB0byB2YWxpZGF0ZSB0aGUgaW50ZWdyaXR5IG9mIHByZXZpb3VzL25leHQgY2hpbGRyZW5cbiAgICogQHBhcmFtIHBhcmVudCBwYXJlbnQgdmlld1xuICAgKiBAcGFyYW0gY2hpbGQgY2hpbGQgdmlld1xuICAgKiBAcGFyYW0gcHJldmlvdXMgcHJldmlvdXMgZWxlbWVudC4gbnVsbC91bmRlZmluZWQgZm9yIGZpcnN0IGVsZW1lbnRcbiAgICogQHBhcmFtIG5leHQgbmV4dCBlbGVtZW50LiBudWxsL3VuZGVmaW5lZCBmb3IgbGFzdCBlbGVtZW50XG4gICAqL1xuICBwcml2YXRlIGluc2VydEluTGlzdChwYXJlbnQ6IE5nVmlldywgY2hpbGQ6IE5nVmlldywgcHJldmlvdXM6IE5nVmlldywgbmV4dDogTmdWaWV3KTogdm9pZCB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy52aWV3VXRpbExvZyhgVmlld1V0aWwuaW5zZXJ0SW5MaXN0IHBhcmVudDogJHtwYXJlbnR9LCB2aWV3OiAke2NoaWxkfSwgYCArIGBwcmV2aW91czogJHtwcmV2aW91c30sIG5leHQ6ICR7bmV4dH1gKTtcbiAgICB9XG5cbiAgICBpZiAocHJldmlvdXMpIHtcbiAgICAgIHByZXZpb3VzLm5leHRTaWJsaW5nID0gY2hpbGQ7XG4gICAgICBjaGlsZC5wcmV2aW91c1NpYmxpbmcgPSBwcmV2aW91cztcbiAgICB9IGVsc2Uge1xuICAgICAgcGFyZW50LmZpcnN0Q2hpbGQgPSBjaGlsZDtcbiAgICB9XG5cbiAgICBpZiAobmV4dCkge1xuICAgICAgY2hpbGQubmV4dFNpYmxpbmcgPSBuZXh0O1xuICAgICAgbmV4dC5wcmV2aW91c1NpYmxpbmcgPSBjaGlsZDtcbiAgICB9IGVsc2Uge1xuICAgICAgcGFyZW50Lmxhc3RDaGlsZCA9IGNoaWxkO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYWRkVG9WaXN1YWxUcmVlKHBhcmVudDogTmdWaWV3LCBjaGlsZDogTmdWaWV3LCBuZXh0OiBOZ1ZpZXcpOiB2b2lkIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnZpZXdVdGlsTG9nKGBWaWV3VXRpbC5hZGRUb1Zpc3VhbFRyZWUgcGFyZW50OiAke3BhcmVudH0sIHZpZXc6ICR7Y2hpbGR9LCBuZXh0OiAke25leHR9YCk7XG4gICAgfVxuXG4gICAgaWYgKHBhcmVudC5tZXRhICYmIHBhcmVudC5tZXRhLmluc2VydENoaWxkKSB7XG4gICAgICBwYXJlbnQubWV0YS5pbnNlcnRDaGlsZChwYXJlbnQsIGNoaWxkLCBuZXh0KTtcbiAgICB9IGVsc2UgaWYgKGlzTGF5b3V0KHBhcmVudCkpIHtcbiAgICAgIHRoaXMuaW5zZXJ0VG9MYXlvdXQocGFyZW50LCBjaGlsZCwgbmV4dCk7XG4gICAgfSBlbHNlIGlmIChpc0NvbnRlbnRWaWV3KHBhcmVudCkpIHtcbiAgICAgIHBhcmVudC5jb250ZW50ID0gY2hpbGQ7XG4gICAgfSBlbHNlIGlmIChwYXJlbnQgJiYgKDxhbnk+cGFyZW50KS5fYWRkQ2hpbGRGcm9tQnVpbGRlcikge1xuICAgICAgKDxhbnk+cGFyZW50KS5fYWRkQ2hpbGRGcm9tQnVpbGRlcihjaGlsZC5ub2RlTmFtZSwgY2hpbGQpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaW5zZXJ0VG9MYXlvdXQocGFyZW50OiBOZ0xheW91dEJhc2UsIGNoaWxkOiBOZ1ZpZXcsIG5leHQ6IE5nVmlldyk6IHZvaWQge1xuICAgIGlmIChjaGlsZC5wYXJlbnQgPT09IHBhcmVudCkge1xuICAgICAgdGhpcy5yZW1vdmVMYXlvdXRDaGlsZChwYXJlbnQsIGNoaWxkKTtcbiAgICB9XG5cbiAgICBjb25zdCBuZXh0VmlzdWFsID0gdGhpcy5maW5kTmV4dFZpc3VhbChuZXh0KTtcbiAgICBpZiAobmV4dFZpc3VhbCkge1xuICAgICAgY29uc3QgaW5kZXggPSBwYXJlbnQuZ2V0Q2hpbGRJbmRleChuZXh0VmlzdWFsKTtcbiAgICAgIHBhcmVudC5pbnNlcnRDaGlsZChjaGlsZCwgaW5kZXgpO1xuICAgIH0gZWxzZSB7XG4gICAgICBwYXJlbnQuYWRkQ2hpbGQoY2hpbGQpO1xuICAgIH1cbiAgICAvLyBwYXJlbnQuZWFjaENoaWxkKChjKSA9PiB7Y29uc29sZS5sb2coYyk7IHJldHVybiB0cnVlfSk7XG4gIH1cblxuICBwcml2YXRlIGZpbmROZXh0VmlzdWFsKHZpZXc6IE5nVmlldyk6IE5nVmlldyB7XG4gICAgbGV0IG5leHQgPSB2aWV3O1xuICAgIHdoaWxlIChuZXh0ICYmIGlzRGV0YWNoZWRFbGVtZW50KG5leHQpKSB7XG4gICAgICBuZXh0ID0gbmV4dC5uZXh0U2libGluZztcbiAgICB9XG5cbiAgICByZXR1cm4gbmV4dDtcbiAgfVxuXG4gIHB1YmxpYyByZW1vdmVDaGlsZChwYXJlbnQ6IFZpZXcsIGNoaWxkOiBWaWV3KSB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy52aWV3VXRpbExvZyhgVmlld1V0aWwucmVtb3ZlQ2hpbGQgcGFyZW50OiAke3BhcmVudH0gY2hpbGQ6ICR7Y2hpbGR9YCk7XG4gICAgfVxuXG4gICAgaWYgKCFwYXJlbnQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBleHRlbmRlZFBhcmVudCA9IHRoaXMuZW5zdXJlTmdWaWV3RXh0ZW5zaW9ucyhwYXJlbnQpO1xuICAgIGNvbnN0IGV4dGVuZGVkQ2hpbGQgPSB0aGlzLmVuc3VyZU5nVmlld0V4dGVuc2lvbnMoY2hpbGQpO1xuXG4gICAgdGhpcy5yZW1vdmVGcm9tTGlzdChleHRlbmRlZFBhcmVudCwgZXh0ZW5kZWRDaGlsZCk7XG4gICAgaWYgKCFpc0RldGFjaGVkRWxlbWVudChleHRlbmRlZENoaWxkKSkge1xuICAgICAgdGhpcy5yZW1vdmVGcm9tVmlzdWFsVHJlZShleHRlbmRlZFBhcmVudCwgZXh0ZW5kZWRDaGlsZCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmVGcm9tTGlzdChwYXJlbnQ6IE5nVmlldywgY2hpbGQ6IE5nVmlldykge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcudmlld1V0aWxMb2coYFZpZXdVdGlsLnJlbW92ZUZyb21MaXN0IHBhcmVudDogJHtwYXJlbnR9IGNoaWxkOiAke2NoaWxkfWApO1xuICAgIH1cblxuICAgIGlmIChwYXJlbnQuZmlyc3RDaGlsZCA9PT0gY2hpbGQgJiYgcGFyZW50Lmxhc3RDaGlsZCA9PT0gY2hpbGQpIHtcbiAgICAgIHBhcmVudC5maXJzdENoaWxkID0gbnVsbDtcbiAgICAgIHBhcmVudC5sYXN0Q2hpbGQgPSBudWxsO1xuICAgICAgY2hpbGQubmV4dFNpYmxpbmcgPSBudWxsO1xuICAgICAgY2hpbGQucHJldmlvdXNTaWJsaW5nID0gbnVsbDtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAocGFyZW50LmZpcnN0Q2hpbGQgPT09IGNoaWxkKSB7XG4gICAgICBwYXJlbnQuZmlyc3RDaGlsZCA9IGNoaWxkLm5leHRTaWJsaW5nO1xuICAgIH1cblxuICAgIGNvbnN0IHByZXZpb3VzID0gY2hpbGQucHJldmlvdXNTaWJsaW5nO1xuICAgIGlmIChwYXJlbnQubGFzdENoaWxkID09PSBjaGlsZCkge1xuICAgICAgcGFyZW50Lmxhc3RDaGlsZCA9IHByZXZpb3VzO1xuICAgIH1cblxuICAgIGlmIChwcmV2aW91cykge1xuICAgICAgcHJldmlvdXMubmV4dFNpYmxpbmcgPSBjaGlsZC5uZXh0U2libGluZztcbiAgICAgIGlmIChjaGlsZC5uZXh0U2libGluZykge1xuICAgICAgICBjaGlsZC5uZXh0U2libGluZy5wcmV2aW91c1NpYmxpbmcgPSBwcmV2aW91cztcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjaGlsZC5uZXh0U2libGluZyA9IG51bGw7XG4gICAgY2hpbGQucHJldmlvdXNTaWJsaW5nID0gbnVsbDtcbiAgfVxuXG4gIC8vIE5PVEU6IFRoaXMgb25lIGlzIE8obikgLSB1c2UgY2FyZWZ1bGx5XG4gIHByaXZhdGUgZmluZFByZXZpb3VzRWxlbWVudChwYXJlbnQ6IE5nVmlldywgY2hpbGQ6IE5nVmlldyk6IE5nVmlldyB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy52aWV3VXRpbExvZyhgVmlld1V0aWwuZmluZFByZXZpb3VzRWxlbWVudCBwYXJlbnQ6ICR7cGFyZW50fSBjaGlsZDogJHtjaGlsZH1gKTtcbiAgICB9XG5cbiAgICBsZXQgcHJldmlvdXNWaXN1YWw7XG4gICAgaWYgKGlzTGF5b3V0KHBhcmVudCkpIHtcbiAgICAgIHByZXZpb3VzVmlzdWFsID0gdGhpcy5nZXRQcmV2aW91c1Zpc3VhbEVsZW1lbnQocGFyZW50LCBjaGlsZCk7XG4gICAgfVxuXG4gICAgbGV0IHByZXZpb3VzID0gcHJldmlvdXNWaXN1YWwgfHwgcGFyZW50LmZpcnN0Q2hpbGQ7XG5cbiAgICAvLyBzaW5jZSBkZXRhY2hlZCBlbGVtZW50cyBhcmUgbm90IGFkZGVkIHRvIHRoZSB2aXN1YWwgdHJlZSxcbiAgICAvLyB3ZSBuZWVkIHRvIGZpbmQgdGhlIGFjdHVhbCBwcmV2aW91cyBzaWJsaW5nIG9mIHRoZSB2aWV3LFxuICAgIC8vIHdoaWNoIG1heSBhcyB3ZWxsIGJlIGFuIGludmlzaWJsZSBub2RlXG4gICAgd2hpbGUgKHByZXZpb3VzICYmIHByZXZpb3VzICE9PSBjaGlsZCAmJiBwcmV2aW91cy5uZXh0U2libGluZyAhPT0gY2hpbGQpIHtcbiAgICAgIHByZXZpb3VzID0gcHJldmlvdXMubmV4dFNpYmxpbmc7XG4gICAgfVxuXG4gICAgcmV0dXJuIHByZXZpb3VzO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRQcmV2aW91c1Zpc3VhbEVsZW1lbnQocGFyZW50OiBOZ0xheW91dEJhc2UsIGNoaWxkOiBOZ1ZpZXcpOiBOZ1ZpZXcge1xuICAgIGNvbnN0IGVsZW1lbnRJbmRleCA9IHBhcmVudC5nZXRDaGlsZEluZGV4KGNoaWxkKTtcblxuICAgIGlmIChlbGVtZW50SW5kZXggPiAwKSB7XG4gICAgICByZXR1cm4gcGFyZW50LmdldENoaWxkQXQoZWxlbWVudEluZGV4IC0gMSkgYXMgTmdWaWV3O1xuICAgIH1cbiAgfVxuXG4gIC8vIE5PVEU6IFRoaXMgb25lIGlzIE8obikgLSB1c2UgY2FyZWZ1bGx5XG4gIHB1YmxpYyBnZXRDaGlsZEluZGV4KHBhcmVudDogYW55LCBjaGlsZDogTmdWaWV3KSB7XG4gICAgaWYgKGlzTGF5b3V0KHBhcmVudCkpIHtcbiAgICAgIHJldHVybiBwYXJlbnQuZ2V0Q2hpbGRJbmRleChjaGlsZCk7XG4gICAgfSBlbHNlIGlmIChpc0NvbnRlbnRWaWV3KHBhcmVudCkpIHtcbiAgICAgIHJldHVybiBjaGlsZCA9PT0gcGFyZW50LmNvbnRlbnQgPyAwIDogLTE7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmVGcm9tVmlzdWFsVHJlZShwYXJlbnQ6IE5nVmlldywgY2hpbGQ6IE5nVmlldykge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcudmlld1V0aWxMb2coYFZpZXdVdGlsLnJlbW92ZUZyb21WaXN1YWxUcmVlIHBhcmVudDogJHtwYXJlbnR9IGNoaWxkOiAke2NoaWxkfWApO1xuICAgIH1cblxuICAgIGlmIChwYXJlbnQubWV0YSAmJiBwYXJlbnQubWV0YS5yZW1vdmVDaGlsZCkge1xuICAgICAgcGFyZW50Lm1ldGEucmVtb3ZlQ2hpbGQocGFyZW50LCBjaGlsZCk7XG4gICAgfSBlbHNlIGlmIChpc0xheW91dChwYXJlbnQpKSB7XG4gICAgICB0aGlzLnJlbW92ZUxheW91dENoaWxkKHBhcmVudCwgY2hpbGQpO1xuICAgIH0gZWxzZSBpZiAoaXNDb250ZW50VmlldyhwYXJlbnQpICYmIHBhcmVudC5jb250ZW50ID09PSBjaGlsZCkge1xuICAgICAgcGFyZW50LmNvbnRlbnQgPSBudWxsO1xuICAgIH0gZWxzZSBpZiAoaXNWaWV3KHBhcmVudCkpIHtcbiAgICAgIHBhcmVudC5fcmVtb3ZlVmlldyhjaGlsZCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmVMYXlvdXRDaGlsZChwYXJlbnQ6IE5nTGF5b3V0QmFzZSwgY2hpbGQ6IE5nVmlldyk6IHZvaWQge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcudmlld1V0aWxMb2coYFZpZXdVdGlsLnJlbW92ZUxheW91dENoaWxkIHBhcmVudDogJHtwYXJlbnR9IGNoaWxkOiAke2NoaWxkfWApO1xuICAgIH1cblxuICAgIGNvbnN0IGluZGV4ID0gcGFyZW50LmdldENoaWxkSW5kZXgoY2hpbGQpO1xuXG4gICAgaWYgKGluZGV4ICE9PSAtMSkge1xuICAgICAgcGFyZW50LnJlbW92ZUNoaWxkKGNoaWxkKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgY3JlYXRlQ29tbWVudCh2YWx1ZTogc3RyaW5nKTogQ29tbWVudE5vZGUge1xuICAgIHJldHVybiBuZXcgQ29tbWVudE5vZGUodmFsdWUpO1xuICB9XG5cbiAgcHVibGljIGNyZWF0ZVRleHQodmFsdWU6IHN0cmluZyk6IFRleHROb2RlIHtcbiAgICByZXR1cm4gbmV3IFRleHROb2RlKHZhbHVlKTtcbiAgfVxuXG4gIHB1YmxpYyBjcmVhdGVWaWV3KG5hbWU6IHN0cmluZyk6IE5nVmlldyB7XG4gICAgY29uc3Qgb3JpZ2luYWxOYW1lID0gbmFtZTtcbiAgICBpZiAoIWlzS25vd25WaWV3KG5hbWUpKSB7XG4gICAgICBuYW1lID0gJ1Byb3h5Vmlld0NvbnRhaW5lcic7XG4gICAgfVxuXG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy52aWV3VXRpbExvZyhgQ3JlYXRpbmcgdmlldzogJHtvcmlnaW5hbE5hbWV9ICR7bmFtZX1gKTtcbiAgICB9XG5cbiAgICBjb25zdCB2aWV3Q2xhc3MgPSBnZXRWaWV3Q2xhc3MobmFtZSk7XG4gICAgY29uc3QgdmlldyA9IDxOZ1ZpZXc+bmV3IHZpZXdDbGFzcygpO1xuICAgIGNvbnN0IG5nVmlldyA9IHRoaXMuc2V0TmdWaWV3RXh0ZW5zaW9ucyh2aWV3LCBuYW1lKTtcbiAgICBuZ1ZpZXcucmV1c2FibGUgPSAhIXRoaXMucmV1c2VWaWV3cztcblxuICAgIHJldHVybiBuZ1ZpZXc7XG4gIH1cblxuICBwcml2YXRlIGVuc3VyZU5nVmlld0V4dGVuc2lvbnModmlldzogVmlldyk6IE5nVmlldyB7XG4gICAgaWYgKHZpZXcuaGFzT3duUHJvcGVydHkoJ21ldGEnKSkge1xuICAgICAgcmV0dXJuIHZpZXcgYXMgTmdWaWV3O1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBuYW1lID0gdmlldy5jc3NUeXBlO1xuICAgICAgY29uc3QgbmdWaWV3ID0gdGhpcy5zZXROZ1ZpZXdFeHRlbnNpb25zKHZpZXcsIG5hbWUpO1xuXG4gICAgICByZXR1cm4gbmdWaWV3O1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc2V0TmdWaWV3RXh0ZW5zaW9ucyh2aWV3OiBWaWV3LCBuYW1lOiBzdHJpbmcpOiBOZ1ZpZXcge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcudmlld1V0aWxMb2coYE1ha2UgaW50byBhIE5nVmlldyB2aWV3OiAke3ZpZXd9IG5hbWU6IFwiJHtuYW1lfVwiYCk7XG4gICAgfVxuXG4gICAgY29uc3QgbmdWaWV3ID0gdmlldyBhcyBOZ1ZpZXc7XG4gICAgbmdWaWV3Lm5vZGVOYW1lID0gbmFtZTtcbiAgICBuZ1ZpZXcubWV0YSA9IGdldFZpZXdNZXRhKG5hbWUpO1xuXG4gICAgLy8gd2UncmUgc2V0dGluZyB0aGUgbm9kZSB0eXBlIG9mIHRoZSB2aWV3XG4gICAgLy8gdG8gJ2VsZW1lbnQnIGJlY2F1c2Ugb2YgY2hlY2tzIGRvbmUgaW4gdGhlXG4gICAgLy8gZG9tIGFuaW1hdGlvbiBlbmdpbmVcbiAgICBuZ1ZpZXcubm9kZVR5cGUgPSBFTEVNRU5UX05PREVfVFlQRTtcblxuICAgIHJldHVybiBuZ1ZpZXc7XG4gIH1cblxuICBwdWJsaWMgc2V0UHJvcGVydHkodmlldzogTmdWaWV3LCBhdHRyaWJ1dGVOYW1lOiBzdHJpbmcsIHZhbHVlOiBhbnksIG5hbWVzcGFjZT86IHN0cmluZyk6IHZvaWQge1xuICAgIGlmICghdmlldyB8fCAobmFtZXNwYWNlICYmICF0aGlzLnJ1bnNJbihuYW1lc3BhY2UpKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChhdHRyaWJ1dGVOYW1lLmluZGV4T2YoJy4nKSAhPT0gLTEpIHtcbiAgICAgIC8vIEhhbmRsZSBuZXN0ZWQgcHJvcGVydGllc1xuICAgICAgY29uc3QgcHJvcGVydGllcyA9IGF0dHJpYnV0ZU5hbWUuc3BsaXQoJy4nKTtcbiAgICAgIGF0dHJpYnV0ZU5hbWUgPSBwcm9wZXJ0aWVzW3Byb3BlcnRpZXMubGVuZ3RoIC0gMV07XG5cbiAgICAgIGxldCBwcm9wTWFwID0gdGhpcy5nZXRQcm9wZXJ0aWVzKHZpZXcpO1xuICAgICAgbGV0IGkgPSAwO1xuICAgICAgd2hpbGUgKGkgPCBwcm9wZXJ0aWVzLmxlbmd0aCAtIDEgJiYgdHlwZW9mIHZpZXcgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgIGxldCBwcm9wID0gcHJvcGVydGllc1tpXTtcbiAgICAgICAgaWYgKHByb3BNYXAuaGFzKHByb3ApKSB7XG4gICAgICAgICAgcHJvcCA9IHByb3BNYXAuZ2V0KHByb3ApO1xuICAgICAgICB9XG5cbiAgICAgICAgdmlldyA9IHZpZXdbcHJvcF07XG4gICAgICAgIHByb3BNYXAgPSB0aGlzLmdldFByb3BlcnRpZXModmlldyk7XG4gICAgICAgIGkrKztcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIHZpZXcgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICB0aGlzLnNldFByb3BlcnR5SW50ZXJuYWwodmlldywgYXR0cmlidXRlTmFtZSwgdmFsdWUpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcnVuc0luKHBsYXRmb3JtOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICBsZXQgcnVucyA9IHRydWU7XG4gICAgY29uc3QgbGFzdCA9ICgpID0+IHRydWU7XG4gICAgaWYgKHRoaXMubmFtZXNwYWNlRmlsdGVycykge1xuICAgICAgbGV0IGNoYWluID0gKHA6IHN0cmluZykgPT4gdHJ1ZTtcbiAgICAgIGZvciAobGV0IGkgPSB0aGlzLm5hbWVzcGFjZUZpbHRlcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcbiAgICAgICAgY29uc3QgY3VycmVudENoYWluID0gY2hhaW47XG4gICAgICAgIGNoYWluID0gKHApID0+IHRoaXMubmFtZXNwYWNlRmlsdGVyc1tpXS5ydW5zSW4ocCwgY3VycmVudENoYWluKTtcbiAgICAgIH1cbiAgICAgIHJ1bnMgPSBjaGFpbihwbGF0Zm9ybSk7XG4gICAgICBydW5zID0gcnVucyAhPT0gZmFsc2UgPyB0cnVlIDogZmFsc2U7IC8vIHVuZGVmaW5lZCBtZWFucyB0cnVlXG4gICAgICAvLyB0aGlzLm5hbWVzcGFjZUZpbHRlcnMuc29tZSgoZmlsdGVyKSA9PiB7XG4gICAgICAvLyBcdGNvbnN0IHJ1bnNJbkZpbHRlciA9IGZpbHRlci5ydW5zSW4ocGxhdGZvcm0pO1xuICAgICAgLy8gXHRpZiAocnVuc0luRmlsdGVyICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIC8vIFx0XHRydW5zID0gcnVuc0luRmlsdGVyO1xuICAgICAgLy8gXHRcdHJldHVybiB0cnVlO1xuICAgICAgLy8gXHR9XG4gICAgICAvLyB9KTtcbiAgICB9XG4gICAgcmV0dXJuIHJ1bnM7XG4gIH1cblxuICBwcml2YXRlIHNldFByb3BlcnR5SW50ZXJuYWwodmlldzogTmdWaWV3LCBhdHRyaWJ1dGVOYW1lOiBzdHJpbmcsIHZhbHVlOiBhbnkpOiB2b2lkIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnZpZXdVdGlsTG9nKGBTZXR0aW5nIGF0dHJpYnV0ZTogJHthdHRyaWJ1dGVOYW1lfT0ke3ZhbHVlfSB0byAke3ZpZXd9YCk7XG4gICAgfVxuXG4gICAgaWYgKGF0dHJpYnV0ZU5hbWUgPT09ICdjbGFzcycpIHtcbiAgICAgIHRoaXMuc2V0Q2xhc3Nlcyh2aWV3LCB2YWx1ZSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKFhNTF9BVFRSSUJVVEVTLmluZGV4T2YoYXR0cmlidXRlTmFtZSkgIT09IC0xKSB7XG4gICAgICB2aWV3W2F0dHJpYnV0ZU5hbWVdID0gdmFsdWU7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgcHJvcE1hcCA9IHRoaXMuZ2V0UHJvcGVydGllcyh2aWV3KTtcbiAgICBjb25zdCBwcm9wZXJ0eU5hbWUgPSBwcm9wTWFwLmdldChhdHRyaWJ1dGVOYW1lKTtcblxuICAgIC8vIEVuc3VyZSB0aGUgY2hpbGRyZW4gb2YgYSBjb2xsZWN0aW9uIGN1cnJlbnRseSBoYXZlIG5vIHBhcmVudCBzZXQuXG4gICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7XG4gICAgICB0aGlzLnJlbW92ZVBhcmVudFJlZmVyZW5jZXNGcm9tSXRlbXModmFsdWUpO1xuICAgIH1cblxuICAgIGlmIChwcm9wZXJ0eU5hbWUpIHtcbiAgICAgIC8vIFdlIGhhdmUgYSBsb3dlci11cHBlciBjYXNlIG1hcHBlZCBwcm9wZXJ0eS5cbiAgICAgIHZpZXdbcHJvcGVydHlOYW1lXSA9IHZhbHVlO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIFVua25vd24gYXR0cmlidXRlIHZhbHVlIC0tIGp1c3Qgc2V0IGl0IHRvIG91ciBvYmplY3QgYXMgaXMuXG4gICAgdmlld1thdHRyaWJ1dGVOYW1lXSA9IHZhbHVlO1xuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmVQYXJlbnRSZWZlcmVuY2VzRnJvbUl0ZW1zKGl0ZW1zOiBhbnlbXSk6IHZvaWQge1xuICAgIGZvciAoY29uc3QgaXRlbSBvZiBpdGVtcykge1xuICAgICAgaWYgKGl0ZW0ucGFyZW50ICYmIGl0ZW0ucGFyZW50Tm9kZSkge1xuICAgICAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgICAgICBOYXRpdmVTY3JpcHREZWJ1Zy52aWV3VXRpbExvZyhgVW5hc3NpZ25pbmcgcGFyZW50ICR7aXRlbS5wYXJlbnROb2RlfSBvbiB2YWx1ZTogJHtpdGVtfWApO1xuICAgICAgICB9XG4gICAgICAgIGl0ZW0ucGFyZW50ID0gdW5kZWZpbmVkO1xuICAgICAgICBpdGVtLnBhcmVudE5vZGUgPSB1bmRlZmluZWQ7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRQcm9wZXJ0aWVzKGluc3RhbmNlOiBhbnkpOiBNYXA8c3RyaW5nLCBzdHJpbmc+IHtcbiAgICBjb25zdCB0eXBlID0gaW5zdGFuY2UgJiYgaW5zdGFuY2UuY29uc3RydWN0b3I7XG4gICAgaWYgKCF0eXBlKSB7XG4gICAgICByZXR1cm4gbmV3IE1hcDxzdHJpbmcsIHN0cmluZz4oKTtcbiAgICB9XG5cbiAgICBpZiAoIXByb3BlcnR5TWFwcy5oYXModHlwZSkpIHtcbiAgICAgIGxldCBwcm9wTWFwID0gbmV3IE1hcDxzdHJpbmcsIHN0cmluZz4oKTtcbiAgICAgIGZvciAobGV0IHByb3BOYW1lIGluIGluc3RhbmNlKSB7XG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlOmZvcmluXG4gICAgICAgIHByb3BNYXAuc2V0KHByb3BOYW1lLnRvTG93ZXJDYXNlKCksIHByb3BOYW1lKTtcbiAgICAgIH1cbiAgICAgIHByb3BlcnR5TWFwcy5zZXQodHlwZSwgcHJvcE1hcCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHByb3BlcnR5TWFwcy5nZXQodHlwZSk7XG4gIH1cblxuICBwcml2YXRlIGNzc0NsYXNzZXModmlldzogTmdWaWV3KSB7XG4gICAgaWYgKCF2aWV3Lm5nQ3NzQ2xhc3Nlcykge1xuICAgICAgdmlldy5uZ0Nzc0NsYXNzZXMgPSBuZXcgTWFwPHN0cmluZywgYm9vbGVhbj4oKTtcbiAgICB9XG4gICAgcmV0dXJuIHZpZXcubmdDc3NDbGFzc2VzO1xuICB9XG5cbiAgcHVibGljIGFkZENsYXNzKHZpZXc6IFZpZXcgfCBOZ1ZpZXcsIGNsYXNzTmFtZTogc3RyaW5nKTogdm9pZCB7XG4gICAgY29uc3QgZXh0ZW5kZWRWaWV3ID0gdGhpcy5lbnN1cmVOZ1ZpZXdFeHRlbnNpb25zKHZpZXcpO1xuICAgIHRoaXMuY3NzQ2xhc3NlcyhleHRlbmRlZFZpZXcpLnNldChjbGFzc05hbWUsIHRydWUpO1xuICAgIHRoaXMuc3luY0NsYXNzZXMoZXh0ZW5kZWRWaWV3KTtcbiAgfVxuXG4gIHB1YmxpYyByZW1vdmVDbGFzcyh2aWV3OiBWaWV3LCBjbGFzc05hbWU6IHN0cmluZyk6IHZvaWQge1xuICAgIGNvbnN0IGV4dGVuZGVkVmlldyA9IHRoaXMuZW5zdXJlTmdWaWV3RXh0ZW5zaW9ucyh2aWV3KTtcbiAgICB0aGlzLmNzc0NsYXNzZXMoZXh0ZW5kZWRWaWV3KS5kZWxldGUoY2xhc3NOYW1lKTtcbiAgICB0aGlzLnN5bmNDbGFzc2VzKGV4dGVuZGVkVmlldyk7XG4gIH1cblxuICBwcml2YXRlIHNldENsYXNzZXModmlldzogTmdWaWV3LCBjbGFzc2VzVmFsdWU6IHN0cmluZyk6IHZvaWQge1xuICAgIGxldCBjbGFzc2VzID0gY2xhc3Nlc1ZhbHVlLnNwbGl0KHdoaXRlU3BhY2VTcGxpdHRlcik7XG4gICAgdGhpcy5jc3NDbGFzc2VzKHZpZXcpLmNsZWFyKCk7XG4gICAgY2xhc3Nlcy5mb3JFYWNoKChjbGFzc05hbWUpID0+IHRoaXMuY3NzQ2xhc3Nlcyh2aWV3KS5zZXQoY2xhc3NOYW1lLCB0cnVlKSk7XG4gICAgdGhpcy5zeW5jQ2xhc3Nlcyh2aWV3KTtcbiAgfVxuXG4gIHByaXZhdGUgc3luY0NsYXNzZXModmlldzogTmdWaWV3KTogdm9pZCB7XG4gICAgbGV0IGNsYXNzVmFsdWUgPSAoPGFueT5BcnJheSkuZnJvbSh0aGlzLmNzc0NsYXNzZXModmlldykua2V5cygpKS5qb2luKCcgJyk7XG4gICAgdmlldy5jbGFzc05hbWUgPSBjbGFzc1ZhbHVlO1xuICB9XG5cbiAgcHVibGljIHNldFN0eWxlKHZpZXc6IFZpZXcsIHN0eWxlTmFtZTogc3RyaW5nLCB2YWx1ZTogYW55KSB7XG4gICAgdmlldy5zdHlsZVtzdHlsZU5hbWVdID0gdmFsdWU7XG4gIH1cblxuICBwdWJsaWMgcmVtb3ZlU3R5bGUodmlldzogVmlldywgc3R5bGVOYW1lOiBzdHJpbmcpIHtcbiAgICB2aWV3LnN0eWxlW3N0eWxlTmFtZV0gPSB1bnNldFZhbHVlO1xuICB9XG59XG4iXX0=