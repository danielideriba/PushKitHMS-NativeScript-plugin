import { ViewContainerRef, Component, ComponentFactoryResolver, ChangeDetectorRef, ApplicationRef, ViewChild } from '@angular/core';
import { ProxyViewContainer, Trace } from '@nativescript/core';
import { ComponentPortal, TemplatePortal } from './portal';
import { registerElement } from '../element-registry';
registerElement('DetachedContainer', () => ProxyViewContainer, {
    skipAddToDom: true,
});
/**
 * Wrapper component used for loading components when navigating
 * It uses DetachedContainer as selector so that it is containerRef is not attached to
 * the visual tree.
 */
// eslint-disable-next-line @angular-eslint/component-class-suffix
export class DetachedLoader {
    // tslint:disable-line:component-class-suffix
    constructor(resolver, changeDetector, containerRef, appRef) {
        this.resolver = resolver;
        this.changeDetector = changeDetector;
        this.containerRef = containerRef;
        this.appRef = appRef;
        this.disposeFunctions = [];
    }
    createComponentPortal(componentType, customInjector) {
        return new ComponentPortal(componentType, this.vc, customInjector || this.vc.injector);
    }
    createTemplatePortal(templateRef, context) {
        return new TemplatePortal(templateRef, this.vc, context);
    }
    loadInLocation(componentType) {
        const factory = this.resolver.resolveComponentFactory(componentType);
        const componentRef = factory.create(this.containerRef.injector);
        this.appRef.attachView(componentRef.hostView);
        this.disposeFunctions.push(() => {
            this.appRef.detachView(componentRef.hostView);
            componentRef.destroy();
        });
        // Component is created, built may not be checked if we are loading
        // inside component with OnPush CD strategy. Mark us for check to be sure CD will reach us.
        // We are inside a promise here so no need for setTimeout - CD should trigger
        // after the promise.
        Trace.write('DetachedLoader.loadInLocation component loaded -> markForCheck', 'detached-loader');
        return componentRef;
    }
    ngOnDestroy() {
        this.disposeFunctions.forEach((fn) => fn());
    }
    detectChanges() {
        this.changeDetector.markForCheck();
    }
    /**
     * @deprecated use Portals
     */
    loadComponent(componentType) {
        Trace.write('DetachedLoader.loadComponent', 'detached-loader');
        return Promise.resolve(this.loadInLocation(componentType));
    }
    /**
     * @deprecated use Portals
     */
    loadComponentSync(componentType) {
        Trace.write('DetachedLoader.loadComponent', 'detached-loader');
        return this.loadInLocation(componentType);
    }
    /**
     * @deprecated use Portals
     */
    loadWithFactory(factory) {
        const componentRef = factory.create(this.containerRef.injector);
        this.appRef.attachView(componentRef.hostView);
        this.disposeFunctions.push(() => {
            this.appRef.detachView(componentRef.hostView);
            componentRef.destroy();
        });
        return componentRef;
    }
}
DetachedLoader.decorators = [
    { type: Component, args: [{
                // eslint-disable-next-line @angular-eslint/component-selector
                selector: 'DetachedContainer',
                template: `<Placeholder #loader></Placeholder><ng-container #vc></ng-container><ng-content></ng-content>`
            },] }
];
DetachedLoader.ctorParameters = () => [
    { type: ComponentFactoryResolver },
    { type: ChangeDetectorRef },
    { type: ViewContainerRef },
    { type: ApplicationRef }
];
DetachedLoader.propDecorators = {
    vc: [{ type: ViewChild, args: ['vc', { read: ViewContainerRef, static: true },] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV0YWNoZWQtbG9hZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2xpYi9jZGsvZGV0YWNoZWQtbG9hZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBa0MsZ0JBQWdCLEVBQUUsU0FBUyxFQUFRLHdCQUF3QixFQUFFLGlCQUFpQixFQUFFLGNBQWMsRUFBMEIsU0FBUyxFQUFZLE1BQU0sZUFBZSxDQUFDO0FBQzVNLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxLQUFLLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUMvRCxPQUFPLEVBQUUsZUFBZSxFQUFFLGNBQWMsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUUzRCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFdEQsZUFBZSxDQUFDLG1CQUFtQixFQUFFLEdBQUcsRUFBRSxDQUFDLGtCQUFrQixFQUFFO0lBQzdELFlBQVksRUFBRSxJQUFJO0NBQ25CLENBQUMsQ0FBQztBQUVIOzs7O0dBSUc7QUFNSCxrRUFBa0U7QUFDbEUsTUFBTSxPQUFPLGNBQWM7SUFHekIsNkNBQTZDO0lBQzdDLFlBQW9CLFFBQWtDLEVBQVUsY0FBaUMsRUFBVSxZQUE4QixFQUFVLE1BQXNCO1FBQXJKLGFBQVEsR0FBUixRQUFRLENBQTBCO1FBQVUsbUJBQWMsR0FBZCxjQUFjLENBQW1CO1FBQVUsaUJBQVksR0FBWixZQUFZLENBQWtCO1FBQVUsV0FBTSxHQUFOLE1BQU0sQ0FBZ0I7UUFGaksscUJBQWdCLEdBQXNCLEVBQUUsQ0FBQztJQUUySCxDQUFDO0lBRXRLLHFCQUFxQixDQUFJLGFBQStCLEVBQUUsY0FBeUI7UUFDeEYsT0FBTyxJQUFJLGVBQWUsQ0FBQyxhQUFhLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxjQUFjLElBQUksSUFBSSxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUN6RixDQUFDO0lBRU0sb0JBQW9CLENBQUksV0FBMkIsRUFBRSxPQUFXO1FBQ3JFLE9BQU8sSUFBSSxjQUFjLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDM0QsQ0FBQztJQUVPLGNBQWMsQ0FBQyxhQUF3QjtRQUM3QyxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLHVCQUF1QixDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ3JFLE1BQU0sWUFBWSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNoRSxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLENBQUM7UUFFOUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUU7WUFDOUIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQzlDLFlBQVksQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUN6QixDQUFDLENBQUMsQ0FBQztRQUVILG1FQUFtRTtRQUNuRSwyRkFBMkY7UUFDM0YsNkVBQTZFO1FBQzdFLHFCQUFxQjtRQUNyQixLQUFLLENBQUMsS0FBSyxDQUFDLGdFQUFnRSxFQUFFLGlCQUFpQixDQUFDLENBQUM7UUFFakcsT0FBTyxZQUFZLENBQUM7SUFDdEIsQ0FBQztJQUVNLFdBQVc7UUFDaEIsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUM5QyxDQUFDO0lBRU0sYUFBYTtRQUNsQixJQUFJLENBQUMsY0FBYyxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQ3JDLENBQUM7SUFFRDs7T0FFRztJQUNJLGFBQWEsQ0FBQyxhQUF3QjtRQUMzQyxLQUFLLENBQUMsS0FBSyxDQUFDLDhCQUE4QixFQUFFLGlCQUFpQixDQUFDLENBQUM7UUFDL0QsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztJQUM3RCxDQUFDO0lBRUQ7O09BRUc7SUFDSSxpQkFBaUIsQ0FBQyxhQUF3QjtRQUMvQyxLQUFLLENBQUMsS0FBSyxDQUFDLDhCQUE4QixFQUFFLGlCQUFpQixDQUFDLENBQUM7UUFDL0QsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQzVDLENBQUM7SUFFRDs7T0FFRztJQUNJLGVBQWUsQ0FBSSxPQUE0QjtRQUNwRCxNQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDaEUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBRTlDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFO1lBQzlCLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUM5QyxZQUFZLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDekIsQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPLFlBQVksQ0FBQztJQUN0QixDQUFDOzs7WUEzRUYsU0FBUyxTQUFDO2dCQUNULDhEQUE4RDtnQkFDOUQsUUFBUSxFQUFFLG1CQUFtQjtnQkFDN0IsUUFBUSxFQUFFLCtGQUErRjthQUMxRzs7O1lBbkIyRSx3QkFBd0I7WUFBRSxpQkFBaUI7WUFBOUUsZ0JBQWdCO1lBQWdFLGNBQWM7OztpQkFzQnBJLFNBQVMsU0FBQyxJQUFJLEVBQUUsRUFBRSxJQUFJLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudFJlZiwgQ29tcG9uZW50RmFjdG9yeSwgVmlld0NvbnRhaW5lclJlZiwgQ29tcG9uZW50LCBUeXBlLCBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsIENoYW5nZURldGVjdG9yUmVmLCBBcHBsaWNhdGlvblJlZiwgT25EZXN0cm95LCBUZW1wbGF0ZVJlZiwgVmlld0NoaWxkLCBJbmplY3RvciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgUHJveHlWaWV3Q29udGFpbmVyLCBUcmFjZSB9IGZyb20gJ0BuYXRpdmVzY3JpcHQvY29yZSc7XG5pbXBvcnQgeyBDb21wb25lbnRQb3J0YWwsIFRlbXBsYXRlUG9ydGFsIH0gZnJvbSAnLi9wb3J0YWwnO1xuaW1wb3J0IHR5cGUgeyBDb21wb25lbnRUeXBlIH0gZnJvbSAnLi4vdXRpbHMvZ2VuZXJhbCc7XG5pbXBvcnQgeyByZWdpc3RlckVsZW1lbnQgfSBmcm9tICcuLi9lbGVtZW50LXJlZ2lzdHJ5JztcblxucmVnaXN0ZXJFbGVtZW50KCdEZXRhY2hlZENvbnRhaW5lcicsICgpID0+IFByb3h5Vmlld0NvbnRhaW5lciwge1xuICBza2lwQWRkVG9Eb206IHRydWUsXG59KTtcblxuLyoqXG4gKiBXcmFwcGVyIGNvbXBvbmVudCB1c2VkIGZvciBsb2FkaW5nIGNvbXBvbmVudHMgd2hlbiBuYXZpZ2F0aW5nXG4gKiBJdCB1c2VzIERldGFjaGVkQ29udGFpbmVyIGFzIHNlbGVjdG9yIHNvIHRoYXQgaXQgaXMgY29udGFpbmVyUmVmIGlzIG5vdCBhdHRhY2hlZCB0b1xuICogdGhlIHZpc3VhbCB0cmVlLlxuICovXG5AQ29tcG9uZW50KHtcbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEBhbmd1bGFyLWVzbGludC9jb21wb25lbnQtc2VsZWN0b3JcbiAgc2VsZWN0b3I6ICdEZXRhY2hlZENvbnRhaW5lcicsXG4gIHRlbXBsYXRlOiBgPFBsYWNlaG9sZGVyICNsb2FkZXI+PC9QbGFjZWhvbGRlcj48bmctY29udGFpbmVyICN2Yz48L25nLWNvbnRhaW5lcj48bmctY29udGVudD48L25nLWNvbnRlbnQ+YCxcbn0pXG4vLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQGFuZ3VsYXItZXNsaW50L2NvbXBvbmVudC1jbGFzcy1zdWZmaXhcbmV4cG9ydCBjbGFzcyBEZXRhY2hlZExvYWRlciBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XG4gIEBWaWV3Q2hpbGQoJ3ZjJywgeyByZWFkOiBWaWV3Q29udGFpbmVyUmVmLCBzdGF0aWM6IHRydWUgfSkgdmM6IFZpZXdDb250YWluZXJSZWY7XG4gIHByaXZhdGUgZGlzcG9zZUZ1bmN0aW9uczogQXJyYXk8KCkgPT4gdm9pZD4gPSBbXTtcbiAgLy8gdHNsaW50OmRpc2FibGUtbGluZTpjb21wb25lbnQtY2xhc3Mtc3VmZml4XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVzb2x2ZXI6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciwgcHJpdmF0ZSBjaGFuZ2VEZXRlY3RvcjogQ2hhbmdlRGV0ZWN0b3JSZWYsIHByaXZhdGUgY29udGFpbmVyUmVmOiBWaWV3Q29udGFpbmVyUmVmLCBwcml2YXRlIGFwcFJlZjogQXBwbGljYXRpb25SZWYpIHt9XG5cbiAgcHVibGljIGNyZWF0ZUNvbXBvbmVudFBvcnRhbDxUPihjb21wb25lbnRUeXBlOiBDb21wb25lbnRUeXBlPFQ+LCBjdXN0b21JbmplY3Rvcj86IEluamVjdG9yKSB7XG4gICAgcmV0dXJuIG5ldyBDb21wb25lbnRQb3J0YWwoY29tcG9uZW50VHlwZSwgdGhpcy52YywgY3VzdG9tSW5qZWN0b3IgfHwgdGhpcy52Yy5pbmplY3Rvcik7XG4gIH1cblxuICBwdWJsaWMgY3JlYXRlVGVtcGxhdGVQb3J0YWw8VD4odGVtcGxhdGVSZWY6IFRlbXBsYXRlUmVmPFQ+LCBjb250ZXh0PzogVCkge1xuICAgIHJldHVybiBuZXcgVGVtcGxhdGVQb3J0YWwodGVtcGxhdGVSZWYsIHRoaXMudmMsIGNvbnRleHQpO1xuICB9XG5cbiAgcHJpdmF0ZSBsb2FkSW5Mb2NhdGlvbihjb21wb25lbnRUeXBlOiBUeXBlPGFueT4pOiBDb21wb25lbnRSZWY8YW55PiB7XG4gICAgY29uc3QgZmFjdG9yeSA9IHRoaXMucmVzb2x2ZXIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoY29tcG9uZW50VHlwZSk7XG4gICAgY29uc3QgY29tcG9uZW50UmVmID0gZmFjdG9yeS5jcmVhdGUodGhpcy5jb250YWluZXJSZWYuaW5qZWN0b3IpO1xuICAgIHRoaXMuYXBwUmVmLmF0dGFjaFZpZXcoY29tcG9uZW50UmVmLmhvc3RWaWV3KTtcblxuICAgIHRoaXMuZGlzcG9zZUZ1bmN0aW9ucy5wdXNoKCgpID0+IHtcbiAgICAgIHRoaXMuYXBwUmVmLmRldGFjaFZpZXcoY29tcG9uZW50UmVmLmhvc3RWaWV3KTtcbiAgICAgIGNvbXBvbmVudFJlZi5kZXN0cm95KCk7XG4gICAgfSk7XG5cbiAgICAvLyBDb21wb25lbnQgaXMgY3JlYXRlZCwgYnVpbHQgbWF5IG5vdCBiZSBjaGVja2VkIGlmIHdlIGFyZSBsb2FkaW5nXG4gICAgLy8gaW5zaWRlIGNvbXBvbmVudCB3aXRoIE9uUHVzaCBDRCBzdHJhdGVneS4gTWFyayB1cyBmb3IgY2hlY2sgdG8gYmUgc3VyZSBDRCB3aWxsIHJlYWNoIHVzLlxuICAgIC8vIFdlIGFyZSBpbnNpZGUgYSBwcm9taXNlIGhlcmUgc28gbm8gbmVlZCBmb3Igc2V0VGltZW91dCAtIENEIHNob3VsZCB0cmlnZ2VyXG4gICAgLy8gYWZ0ZXIgdGhlIHByb21pc2UuXG4gICAgVHJhY2Uud3JpdGUoJ0RldGFjaGVkTG9hZGVyLmxvYWRJbkxvY2F0aW9uIGNvbXBvbmVudCBsb2FkZWQgLT4gbWFya0ZvckNoZWNrJywgJ2RldGFjaGVkLWxvYWRlcicpO1xuXG4gICAgcmV0dXJuIGNvbXBvbmVudFJlZjtcbiAgfVxuXG4gIHB1YmxpYyBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLmRpc3Bvc2VGdW5jdGlvbnMuZm9yRWFjaCgoZm4pID0+IGZuKCkpO1xuICB9XG5cbiAgcHVibGljIGRldGVjdENoYW5nZXMoKSB7XG4gICAgdGhpcy5jaGFuZ2VEZXRlY3Rvci5tYXJrRm9yQ2hlY2soKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAZGVwcmVjYXRlZCB1c2UgUG9ydGFsc1xuICAgKi9cbiAgcHVibGljIGxvYWRDb21wb25lbnQoY29tcG9uZW50VHlwZTogVHlwZTxhbnk+KTogUHJvbWlzZTxDb21wb25lbnRSZWY8YW55Pj4ge1xuICAgIFRyYWNlLndyaXRlKCdEZXRhY2hlZExvYWRlci5sb2FkQ29tcG9uZW50JywgJ2RldGFjaGVkLWxvYWRlcicpO1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUodGhpcy5sb2FkSW5Mb2NhdGlvbihjb21wb25lbnRUeXBlKSk7XG4gIH1cblxuICAvKipcbiAgICogQGRlcHJlY2F0ZWQgdXNlIFBvcnRhbHNcbiAgICovXG4gIHB1YmxpYyBsb2FkQ29tcG9uZW50U3luYyhjb21wb25lbnRUeXBlOiBUeXBlPGFueT4pOiBDb21wb25lbnRSZWY8YW55PiB7XG4gICAgVHJhY2Uud3JpdGUoJ0RldGFjaGVkTG9hZGVyLmxvYWRDb21wb25lbnQnLCAnZGV0YWNoZWQtbG9hZGVyJyk7XG4gICAgcmV0dXJuIHRoaXMubG9hZEluTG9jYXRpb24oY29tcG9uZW50VHlwZSk7XG4gIH1cblxuICAvKipcbiAgICogQGRlcHJlY2F0ZWQgdXNlIFBvcnRhbHNcbiAgICovXG4gIHB1YmxpYyBsb2FkV2l0aEZhY3Rvcnk8VD4oZmFjdG9yeTogQ29tcG9uZW50RmFjdG9yeTxUPik6IENvbXBvbmVudFJlZjxUPiB7XG4gICAgY29uc3QgY29tcG9uZW50UmVmID0gZmFjdG9yeS5jcmVhdGUodGhpcy5jb250YWluZXJSZWYuaW5qZWN0b3IpO1xuICAgIHRoaXMuYXBwUmVmLmF0dGFjaFZpZXcoY29tcG9uZW50UmVmLmhvc3RWaWV3KTtcblxuICAgIHRoaXMuZGlzcG9zZUZ1bmN0aW9ucy5wdXNoKCgpID0+IHtcbiAgICAgIHRoaXMuYXBwUmVmLmRldGFjaFZpZXcoY29tcG9uZW50UmVmLmhvc3RWaWV3KTtcbiAgICAgIGNvbXBvbmVudFJlZi5kZXN0cm95KCk7XG4gICAgfSk7XG4gICAgcmV0dXJuIGNvbXBvbmVudFJlZjtcbiAgfVxufVxuIl19