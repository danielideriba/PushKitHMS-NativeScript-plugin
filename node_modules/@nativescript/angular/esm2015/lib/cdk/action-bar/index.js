import { Directive, Component, ElementRef, Optional } from '@angular/core';
import { ActionBar, ActionItem, NavigationButton, Page } from '@nativescript/core';
import { isBlank } from '../../utils/lang-facade';
import { isInvisibleNode, isView } from '../../views/utils';
import { registerElement } from '../../element-registry';
export function isActionItem(view) {
    return view instanceof ActionItem;
}
export function isNavigationButton(view) {
    return view instanceof NavigationButton;
}
const ɵ0 = (parent, child, next) => {
    if (isInvisibleNode(child)) {
        return;
    }
    else if (isNavigationButton(child)) {
        parent.navigationButton = child;
        child.parentNode = parent;
    }
    else if (isActionItem(child)) {
        addActionItem(parent, child, next);
        child.parentNode = parent;
    }
    else if (isView(child)) {
        parent.titleView = child;
    }
}, ɵ1 = (parent, child) => {
    if (isInvisibleNode(child)) {
        return;
    }
    else if (isNavigationButton(child)) {
        if (parent.navigationButton === child) {
            parent.navigationButton = null;
        }
        child.parentNode = null;
    }
    else if (isActionItem(child)) {
        parent.actionItems.removeItem(child);
        child.parentNode = null;
    }
    else if (isView(child) && parent.titleView && parent.titleView === child) {
        parent.titleView = null;
    }
};
export const actionBarMeta = {
    skipAddToDom: true,
    insertChild: ɵ0,
    removeChild: ɵ1,
};
registerElement('ActionBar', () => ActionBar, actionBarMeta);
registerElement('ActionItem', () => ActionItem);
registerElement('NavigationButton', () => NavigationButton);
const addActionItem = (bar, item, next) => {
    if (next) {
        insertActionItemBefore(bar, item, next);
    }
    else {
        appendActionItem(bar, item);
    }
};
const ɵ2 = addActionItem;
const insertActionItemBefore = (bar, item, next) => {
    const actionItems = bar.actionItems;
    const actionItemsCollection = actionItems.getItems();
    const indexToInsert = actionItemsCollection.indexOf(next);
    actionItemsCollection.splice(indexToInsert, 0, item);
    actionItems.setItems(actionItemsCollection);
};
const ɵ3 = insertActionItemBefore;
const appendActionItem = (bar, item) => {
    bar.actionItems.addItem(item);
};
const ɵ4 = appendActionItem;
export class ActionBarComponent {
    constructor(element, page) {
        this.element = element;
        this.page = page;
        if (!this.page) {
            throw new Error('Inside ActionBarComponent but no Page found in DI.');
        }
        if (isBlank(this.page.actionBarHidden)) {
            this.page.actionBarHidden = false;
        }
        this.page.actionBar = this.element.nativeElement;
        this.page.actionBar.update();
    }
}
ActionBarComponent.decorators = [
    { type: Component, args: [{
                selector: 'ActionBar',
                template: '<ng-content></ng-content>'
            },] }
];
ActionBarComponent.ctorParameters = () => [
    { type: ElementRef },
    { type: Page }
];
export class ActionBarScope {
    // tslint:disable-line:component-class-suffix
    constructor(page) {
        this.page = page;
        if (!this.page) {
            throw new Error('Inside ActionBarScope but no Page found in DI.');
        }
    }
    onNavButtonInit(navBtn) {
        this.page.actionBar.navigationButton = navBtn.element.nativeElement;
    }
    onNavButtonDestroy(navBtn) {
        const nav = navBtn.element.nativeElement;
        if (nav && this.page.actionBar.navigationButton === nav) {
            this.page.actionBar.navigationButton = null;
        }
    }
    onActionInit(item) {
        this.page.actionBar.actionItems.addItem(item.element.nativeElement);
    }
    onActionDestroy(item) {
        if (item.element.nativeElement.actionBar) {
            this.page.actionBar.actionItems.removeItem(item.element.nativeElement);
        }
    }
}
ActionBarScope.decorators = [
    { type: Component, args: [{
                selector: 'ActionBarExtension',
                template: ''
            },] }
];
ActionBarScope.ctorParameters = () => [
    { type: Page }
];
export class ActionItemDirective {
    constructor(element, ownerScope) {
        this.element = element;
        this.ownerScope = ownerScope;
        if (this.ownerScope) {
            this.ownerScope.onActionInit(this);
        }
    }
    ngOnDestroy() {
        if (this.ownerScope) {
            this.ownerScope.onActionDestroy(this);
        }
    }
}
ActionItemDirective.decorators = [
    { type: Directive, args: [{
                selector: 'ActionItem', // tslint:disable-line:directive-selector
            },] }
];
ActionItemDirective.ctorParameters = () => [
    { type: ElementRef },
    { type: ActionBarScope, decorators: [{ type: Optional }] }
];
export class NavigationButtonDirective {
    constructor(element, ownerScope) {
        this.element = element;
        this.ownerScope = ownerScope;
        if (this.ownerScope) {
            this.ownerScope.onNavButtonInit(this);
        }
    }
    ngOnDestroy() {
        if (this.ownerScope) {
            this.ownerScope.onNavButtonDestroy(this);
        }
    }
}
NavigationButtonDirective.decorators = [
    { type: Directive, args: [{
                selector: 'NavigationButton', // tslint:disable-line:directive-selector
            },] }
];
NavigationButtonDirective.ctorParameters = () => [
    { type: ElementRef },
    { type: ActionBarScope, decorators: [{ type: Optional }] }
];
export { ɵ0, ɵ1, ɵ2, ɵ3, ɵ4 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvbGliL2Nkay9hY3Rpb24tYmFyL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQWEsTUFBTSxlQUFlLENBQUM7QUFDdEYsT0FBTyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQWUsZ0JBQWdCLEVBQUUsSUFBSSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFFaEcsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBRWxELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDNUQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBRXpELE1BQU0sVUFBVSxZQUFZLENBQUMsSUFBUztJQUNwQyxPQUFPLElBQUksWUFBWSxVQUFVLENBQUM7QUFDcEMsQ0FBQztBQUVELE1BQU0sVUFBVSxrQkFBa0IsQ0FBQyxJQUFTO0lBQzFDLE9BQU8sSUFBSSxZQUFZLGdCQUFnQixDQUFDO0FBQzFDLENBQUM7V0FNYyxDQUFDLE1BQW1CLEVBQUUsS0FBYSxFQUFFLElBQVMsRUFBRSxFQUFFO0lBQzdELElBQUksZUFBZSxDQUFDLEtBQUssQ0FBQyxFQUFFO1FBQzFCLE9BQU87S0FDUjtTQUFNLElBQUksa0JBQWtCLENBQUMsS0FBSyxDQUFDLEVBQUU7UUFDcEMsTUFBTSxDQUFDLGdCQUFnQixHQUFHLEtBQUssQ0FBQztRQUNoQyxLQUFLLENBQUMsVUFBVSxHQUFHLE1BQU0sQ0FBQztLQUMzQjtTQUFNLElBQUksWUFBWSxDQUFDLEtBQUssQ0FBQyxFQUFFO1FBQzlCLGFBQWEsQ0FBQyxNQUFNLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ25DLEtBQUssQ0FBQyxVQUFVLEdBQUcsTUFBTSxDQUFD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LFVBQVUsRUFBRTtZQUNuQixJQUFJLENBQUMsVUFBVSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxDQUFDO1NBQzFDO0lBQ0gsQ0FBQzs7O1lBZEYsU0FBUyxTQUFDO2dCQUNULFFBQVEsRUFBRSxrQkFBa0IsRUFBRSx5Q0FBeUM7YUFDeEU7OztZQXBKOEIsVUFBVTtZQXNKaUMsY0FBYyx1QkFBN0MsUUFBUSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERpcmVjdGl2ZSwgQ29tcG9uZW50LCBFbGVtZW50UmVmLCBPcHRpb25hbCwgT25EZXN0cm95IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBY3Rpb25CYXIsIEFjdGlvbkl0ZW0sIEFjdGlvbkl0ZW1zLCBOYXZpZ2F0aW9uQnV0dG9uLCBQYWdlIH0gZnJvbSAnQG5hdGl2ZXNjcmlwdC9jb3JlJztcblxuaW1wb3J0IHsgaXNCbGFuayB9IGZyb20gJy4uLy4uL3V0aWxzL2xhbmctZmFjYWRlJztcbmltcG9ydCB7IE5nVmlldywgVmlld0NsYXNzTWV0YSwgVmlld0V4dGVuc2lvbnMgfSBmcm9tICcuLi8uLi92aWV3cy92aWV3LXR5cGVzJztcbmltcG9ydCB7IGlzSW52aXNpYmxlTm9kZSwgaXNWaWV3IH0gZnJvbSAnLi4vLi4vdmlld3MvdXRpbHMnO1xuaW1wb3J0IHsgcmVnaXN0ZXJFbGVtZW50IH0gZnJvbSAnLi4vLi4vZWxlbWVudC1yZWdpc3RyeSc7XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0FjdGlvbkl0ZW0odmlldzogYW55KTogdmlldyBpcyBBY3Rpb25JdGVtIHtcbiAgcmV0dXJuIHZpZXcgaW5zdGFuY2VvZiBBY3Rpb25JdGVtO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNOYXZpZ2F0aW9uQnV0dG9uKHZpZXc6IGFueSk6IHZpZXcgaXMgTmF2aWdhdGlvbkJ1dHRvbiB7XG4gIHJldHVybiB2aWV3IGluc3RhbmNlb2YgTmF2aWdhdGlvbkJ1dHRvbjtcbn1cblxudHlwZSBOZ0FjdGlvbkJhciA9IEFjdGlvbkJhciAmIFZpZXdFeHRlbnNpb25zO1xuXG5leHBvcnQgY29uc3QgYWN0aW9uQmFyTWV0YTogVmlld0NsYXNzTWV0YSA9IHtcbiAgc2tpcEFkZFRvRG9tOiB0cnVlLFxuICBpbnNlcnRDaGlsZDogKHBhcmVudDogTmdBY3Rpb25CYXIsIGNoaWxkOiBOZ1ZpZXcsIG5leHQ6IGFueSkgPT4ge1xuICAgIGlmIChpc0ludmlzaWJsZU5vZGUoY2hpbGQpKSB7XG4gICAgICByZXR1cm47XG4gICAgfSBlbHNlIGlmIChpc05hdmlnYXRpb25CdXR0b24oY2hpbGQpKSB7XG4gICAgICBwYXJlbnQubmF2aWdhdGlvbkJ1dHRvbiA9IGNoaWxkO1xuICAgICAgY2hpbGQucGFyZW50Tm9kZSA9IHBhcmVudDtcbiAgICB9IGVsc2UgaWYgKGlzQWN0aW9uSXRlbShjaGlsZCkpIHtcbiAgICAgIGFkZEFjdGlvbkl0ZW0ocGFyZW50LCBjaGlsZCwgbmV4dCk7XG4gICAgICBjaGlsZC5wYXJlbnROb2RlID0gcGFyZW50O1xuICAgIH0gZWxzZSBpZiAoaXNWaWV3KGNoaWxkKSkge1xuICAgICAgcGFyZW50LnRpdGxlVmlldyA9IGNoaWxkO1xuICAgIH1cbiAgfSxcbiAgcmVtb3ZlQ2hpbGQ6IChwYXJlbnQ6IE5nQWN0aW9uQmFyLCBjaGlsZDogTmdWaWV3KSA9PiB7XG4gICAgaWYgKGlzSW52aXNpYmxlTm9kZShjaGlsZCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9IGVsc2UgaWYgKGlzTmF2aWdhdGlvbkJ1dHRvbihjaGlsZCkpIHtcbiAgICAgIGlmIChwYXJlbnQubmF2aWdhdGlvbkJ1dHRvbiA9PT0gY2hpbGQpIHtcbiAgICAgICAgcGFyZW50Lm5hdmlnYXRpb25CdXR0b24gPSBudWxsO1xuICAgICAgfVxuXG4gICAgICBjaGlsZC5wYXJlbnROb2RlID0gbnVsbDtcbiAgICB9IGVsc2UgaWYgKGlzQWN0aW9uSXRlbShjaGlsZCkpIHtcbiAgICAgIHBhcmVudC5hY3Rpb25JdGVtcy5yZW1vdmVJdGVtKGNoaWxkKTtcbiAgICAgIGNoaWxkLnBhcmVudE5vZGUgPSBudWxsO1xuICAgIH0gZWxzZSBpZiAoaXNWaWV3KGNoaWxkKSAmJiBwYXJlbnQudGl0bGVWaWV3ICYmIHBhcmVudC50aXRsZVZpZXcgPT09IGNoaWxkKSB7XG4gICAgICBwYXJlbnQudGl0bGVWaWV3ID0gbnVsbDtcbiAgICB9XG4gIH0sXG59O1xuXG5yZWdpc3RlckVsZW1lbnQoJ0FjdGlvbkJhcicsICgpID0+IEFjdGlvbkJhciwgYWN0aW9uQmFyTWV0YSk7XG5yZWdpc3RlckVsZW1lbnQoJ0FjdGlvbkl0ZW0nLCAoKSA9PiA8YW55PkFjdGlvbkl0ZW0pO1xucmVnaXN0ZXJFbGVtZW50KCdOYXZpZ2F0aW9uQnV0dG9uJywgKCkgPT4gPGFueT5OYXZpZ2F0aW9uQnV0dG9uKTtcblxuY29uc3QgYWRkQWN0aW9uSXRlbSA9IChiYXI6IE5nQWN0aW9uQmFyLCBpdGVtOiBBY3Rpb25JdGVtLCBuZXh0OiBBY3Rpb25JdGVtKSA9PiB7XG4gIGlmIChuZXh0KSB7XG4gICAgaW5zZXJ0QWN0aW9uSXRlbUJlZm9yZShiYXIsIGl0ZW0sIG5leHQpO1xuICB9IGVsc2Uge1xuICAgIGFwcGVuZEFjdGlvbkl0ZW0oYmFyLCBpdGVtKTtcbiAgfVxufTtcblxuY29uc3QgaW5zZXJ0QWN0aW9uSXRlbUJlZm9yZSA9IChiYXI6IE5nQWN0aW9uQmFyLCBpdGVtOiBBY3Rpb25JdGVtLCBuZXh0OiBBY3Rpb25JdGVtKSA9PiB7XG4gIGNvbnN0IGFjdGlvbkl0ZW1zOiBBY3Rpb25JdGVtcyA9IGJhci5hY3Rpb25JdGVtcztcbiAgY29uc3QgYWN0aW9uSXRlbXNDb2xsZWN0aW9uOiBBY3Rpb25JdGVtW10gPSBhY3Rpb25JdGVtcy5nZXRJdGVtcygpO1xuXG4gIGNvbnN0IGluZGV4VG9JbnNlcnQgPSBhY3Rpb25JdGVtc0NvbGxlY3Rpb24uaW5kZXhPZihuZXh0KTtcbiAgYWN0aW9uSXRlbXNDb2xsZWN0aW9uLnNwbGljZShpbmRleFRvSW5zZXJ0LCAwLCBpdGVtKTtcblxuICAoPGFueT5hY3Rpb25JdGVtcykuc2V0SXRlbXMoYWN0aW9uSXRlbXNDb2xsZWN0aW9uKTtcbn07XG5cbmNvbnN0IGFwcGVuZEFjdGlvbkl0ZW0gPSAoYmFyOiBOZ0FjdGlvbkJhciwgaXRlbTogQWN0aW9uSXRlbSkgPT4ge1xuICBiYXIuYWN0aW9uSXRlbXMuYWRkSXRlbShpdGVtKTtcbn07XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ0FjdGlvbkJhcicsXG4gIHRlbXBsYXRlOiAnPG5nLWNvbnRlbnQ+PC9uZy1jb250ZW50PicsXG59KVxuZXhwb3J0IGNsYXNzIEFjdGlvbkJhckNvbXBvbmVudCB7XG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBlbGVtZW50OiBFbGVtZW50UmVmLCBwcml2YXRlIHBhZ2U6IFBhZ2UpIHtcbiAgICBpZiAoIXRoaXMucGFnZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnNpZGUgQWN0aW9uQmFyQ29tcG9uZW50IGJ1dCBubyBQYWdlIGZvdW5kIGluIERJLicpO1xuICAgIH1cblxuICAgIGlmIChpc0JsYW5rKHRoaXMucGFnZS5hY3Rpb25CYXJIaWRkZW4pKSB7XG4gICAgICB0aGlzLnBhZ2UuYWN0aW9uQmFySGlkZGVuID0gZmFsc2U7XG4gICAgfVxuICAgIHRoaXMucGFnZS5hY3Rpb25CYXIgPSB0aGlzLmVsZW1lbnQubmF0aXZlRWxlbWVudDtcbiAgICB0aGlzLnBhZ2UuYWN0aW9uQmFyLnVwZGF0ZSgpO1xuICB9XG59XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ0FjdGlvbkJhckV4dGVuc2lvbicsXG4gIHRlbXBsYXRlOiAnJyxcbn0pXG5leHBvcnQgY2xhc3MgQWN0aW9uQmFyU2NvcGUge1xuICAvLyB0c2xpbnQ6ZGlzYWJsZS1saW5lOmNvbXBvbmVudC1jbGFzcy1zdWZmaXhcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBwYWdlOiBQYWdlKSB7XG4gICAgaWYgKCF0aGlzLnBhZ2UpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignSW5zaWRlIEFjdGlvbkJhclNjb3BlIGJ1dCBubyBQYWdlIGZvdW5kIGluIERJLicpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBvbk5hdkJ1dHRvbkluaXQobmF2QnRuOiBOYXZpZ2F0aW9uQnV0dG9uRGlyZWN0aXZlKSB7XG4gICAgdGhpcy5wYWdlLmFjdGlvbkJhci5uYXZpZ2F0aW9uQnV0dG9uID0gbmF2QnRuLmVsZW1lbnQubmF0aXZlRWxlbWVudDtcbiAgfVxuXG4gIHB1YmxpYyBvbk5hdkJ1dHRvbkRlc3Ryb3kobmF2QnRuOiBOYXZpZ2F0aW9uQnV0dG9uRGlyZWN0aXZlKSB7XG4gICAgY29uc3QgbmF2ID0gPE5hdmlnYXRpb25CdXR0b24+bmF2QnRuLmVsZW1lbnQubmF0aXZlRWxlbWVudDtcbiAgICBpZiAobmF2ICYmIHRoaXMucGFnZS5hY3Rpb25CYXIubmF2aWdhdGlvbkJ1dHRvbiA9PT0gbmF2KSB7XG4gICAgICB0aGlzLnBhZ2UuYWN0aW9uQmFyLm5hdmlnYXRpb25CdXR0b24gPSBudWxsO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBvbkFjdGlvbkluaXQoaXRlbTogQWN0aW9uSXRlbURpcmVjdGl2ZSkge1xuICAgIHRoaXMucGFnZS5hY3Rpb25CYXIuYWN0aW9uSXRlbXMuYWRkSXRlbShpdGVtLmVsZW1lbnQubmF0aXZlRWxlbWVudCk7XG4gIH1cblxuICBwdWJsaWMgb25BY3Rpb25EZXN0cm95KGl0ZW06IEFjdGlvbkl0ZW1EaXJlY3RpdmUpIHtcbiAgICBpZiAoaXRlbS5lbGVtZW50Lm5hdGl2ZUVsZW1lbnQuYWN0aW9uQmFyKSB7XG4gICAgICB0aGlzLnBhZ2UuYWN0aW9uQmFyLmFjdGlvbkl0ZW1zLnJlbW92ZUl0ZW0oaXRlbS5lbGVtZW50Lm5hdGl2ZUVsZW1lbnQpO1xuICAgIH1cbiAgfVxufVxuXG5ARGlyZWN0aXZlKHtcbiAgc2VsZWN0b3I6ICdBY3Rpb25JdGVtJywgLy8gdHNsaW50OmRpc2FibGUtbGluZTpkaXJlY3RpdmUtc2VsZWN0b3Jcbn0pXG5leHBvcnQgY2xhc3MgQWN0aW9uSXRlbURpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBlbGVtZW50OiBFbGVtZW50UmVmLCBAT3B0aW9uYWwoKSBwcml2YXRlIG93bmVyU2NvcGU6IEFjdGlvbkJhclNjb3BlKSB7XG4gICAgaWYgKHRoaXMub3duZXJTY29wZSkge1xuICAgICAgdGhpcy5vd25lclNjb3BlLm9uQWN0aW9uSW5pdCh0aGlzKTtcbiAgICB9XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICBpZiAodGhpcy5vd25lclNjb3BlKSB7XG4gICAgICB0aGlzLm93bmVyU2NvcGUub25BY3Rpb25EZXN0cm95KHRoaXMpO1xuICAgIH1cbiAgfVxufVxuXG5ARGlyZWN0aXZlKHtcbiAgc2VsZWN0b3I6ICdOYXZpZ2F0aW9uQnV0dG9uJywgLy8gdHNsaW50OmRpc2FibGUtbGluZTpkaXJlY3RpdmUtc2VsZWN0b3Jcbn0pXG5leHBvcnQgY2xhc3MgTmF2aWdhdGlvbkJ1dHRvbkRpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBlbGVtZW50OiBFbGVtZW50UmVmLCBAT3B0aW9uYWwoKSBwcml2YXRlIG93bmVyU2NvcGU6IEFjdGlvbkJhclNjb3BlKSB7XG4gICAgaWYgKHRoaXMub3duZXJTY29wZSkge1xuICAgICAgdGhpcy5vd25lclNjb3BlLm9uTmF2QnV0dG9uSW5pdCh0aGlzKTtcbiAgICB9XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICBpZiAodGhpcy5vd25lclNjb3BlKSB7XG4gICAgICB0aGlzLm93bmVyU2NvcGUub25OYXZCdXR0b25EZXN0cm95KHRoaXMpO1xuICAgIH1cbiAgfVxufVxuIl19