import { __decorate } from "tslib";
import { Attribute, ChangeDetectorRef, ComponentFactoryResolver, Directive, Inject, Injector, EventEmitter, Output, ViewContainerRef, ElementRef, NgZone } from '@angular/core';
import { ActivatedRoute, ChildrenOutletContexts, PRIMARY_OUTLET } from '@angular/router';
import { Frame, Page, profile } from '@nativescript/core';
import { BehaviorSubject } from 'rxjs';
import { PAGE_FACTORY } from '../../tokens';
import { NativeScriptDebug } from '../../trace';
import { DetachedLoader } from '../../cdk/detached-loader';
import { ViewUtil } from '../../view-util';
import { NSLocationStrategy } from './ns-location-strategy';
import { NSRouteReuseStrategy } from './ns-route-reuse-strategy';
import { findTopActivatedRouteNodeForOutlet, pageRouterActivatedSymbol, loaderRefSymbol, destroyComponentRef } from './page-router-outlet-utils';
import { registerElement } from '../../element-registry';
import { PageService } from '../../cdk/frame-page/page.service';
export class PageRoute {
    constructor(startRoute) {
        this.activatedRoute = new BehaviorSubject(startRoute);
    }
}
export class DestructibleInjector {
    constructor(destructableProviders, parent) {
        this.destructableProviders = destructableProviders;
        this.parent = parent;
        this.refs = new Set();
    }
    get(token, notFoundValue, flags) {
        const ref = this.parent.get(token, notFoundValue, flags);
        if (this.destructableProviders.has(token)) {
            this.refs.add(ref);
        }
        return ref;
    }
    destroy() {
        this.refs.forEach((ref) => {
            if (ref.ngOnDestroy instanceof Function) {
                ref.ngOnDestroy();
            }
        });
        this.refs.clear();
    }
}
const routeToString = function (activatedRoute) {
    return activatedRoute.pathFromRoot.join('->');
};
const Éµ0 = routeToString;
registerElement('page-router-outlet', () => Frame);
// eslint-disable-next-line @angular-eslint/directive-selector
// eslint-disable-next-line @angular-eslint/directive-class-suffix
export class PageRouterOutlet {
    constructor(parentContexts, location, name, actionBarVisibility, isEmptyOutlet, locationStrategy, componentFactoryResolver, resolver, changeDetector, pageFactory, routeReuseStrategy, ngZone, elRef, viewUtil) {
        this.parentContexts = parentContexts;
        this.location = location;
        this.locationStrategy = locationStrategy;
        this.componentFactoryResolver = componentFactoryResolver;
        this.resolver = resolver;
        this.changeDetector = changeDetector;
        this.pageFactory = pageFactory;
        this.routeReuseStrategy = routeReuseStrategy;
        this.ngZone = ngZone;
        // tslint:disable-line:directive-class-suffix
        this.activated = null;
        this._activatedRoute = null;
        // eslint-disable-next-line @angular-eslint/no-output-rename
        this.activateEvents = new EventEmitter(); // tslint:disable-line:no-output-rename
        // eslint-disable-next-line @angular-eslint/no-output-rename
        this.deactivateEvents = new EventEmitter(); // tslint:disable-line:no-output-rename
        this.isEmptyOutlet = isEmptyOutlet;
        this.frame = elRef.nativeElement;
        this.setActionBarVisibility(actionBarVisibility);
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog(`PageRouterOutlet.constructor frame: ${this.frame}`);
        }
        this.name = name || PRIMARY_OUTLET;
        parentContexts.onChildOutletCreated(this.name, this);
        this.viewUtil = viewUtil;
        this.detachedLoaderFactory = resolver.resolveComponentFactory(DetachedLoader);
    }
    /** @deprecated from Angular since v4 */
    get locationInjector() {
        return this.location.injector;
    }
    /** @deprecated from Angular since v4 */
    get locationFactoryResolver() {
        return this.resolver;
    }
    get isActivated() {
        return !!this.activated;
    }
    get component() {
        if (!this.activated) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerLog('Outlet is not activated');
            }
            return;
        }
        return this.activated.instance;
    }
    get activatedRoute() {
        if (!this.activated) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerLog('Outlet is not activated');
            }
            return;
        }
        return this._activatedRoute;
    }
    setActionBarVisibility(actionBarVisibility) {
        switch (actionBarVisibility) {
            case 'always':
            case 'never':
                this.frame.actionBarVisibility = actionBarVisibility;
                return;
            default:
                this.frame.actionBarVisibility = 'auto';
        }
    }
    ngOnDestroy() {
        // Clear accumulated modal view page cache when page-router-outlet
        // destroyed on modal view closing
        this.parentContexts.onChildOutletDestroyed(this.name);
        if (this.outlet) {
            this.outlet.outletKeys.forEach((key) => {
                this.routeReuseStrategy.clearModalCache(key);
            });
            this.locationStrategy.clearOutlet(this.frame);
        }
        else {
            NativeScriptDebug.routerLog('PageRouterOutlet.ngOnDestroy: no outlet available for page-router-outlet');
        }
        if (this.isActivated) {
            const c = this.activated.instance;
            this.activated.hostView.detach();
            destroyComponentRef(this.activated);
            this.deactivateEvents.emit(c);
            this.activated = null;
        }
    }
    deactivate() {
        if (!this.outlet || !this.outlet.isPageNavigationBack) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerLog('Currently not in page back navigation - component should be detached instead of deactivated.');
            }
            return;
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('PageRouterOutlet.deactivate() while going back - should destroy');
        }
        if (!this.isActivated) {
            return;
        }
        const c = this.activated.instance;
        destroyComponentRef(this.activated);
        this.activated = null;
        this._activatedRoute = null;
        this.deactivateEvents.emit(c);
    }
    /**
     * Called when the `RouteReuseStrategy` instructs to detach the subtree
     */
    detach() {
        if (!this.isActivated) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerLog('Outlet is not activated');
            }
            return;
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog(`PageRouterOutlet.detach() - ${routeToString(this._activatedRoute)}`);
        }
        // Detach from ChangeDetection
        this.activated.hostView.detach();
        const component = this.activated;
        this.activated = null;
        this._activatedRoute = null;
        return component;
    }
    /**
     * Called when the `RouteReuseStrategy` instructs to re-attach a previously detached subtree
     */
    attach(ref, activatedRoute) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog(`PageRouterOutlet.attach() - ${routeToString(activatedRoute)}`);
        }
        this.activated = ref;
        // reattach to ChangeDetection
        this.activated.hostView.markForCheck();
        this.activated.hostView.reattach();
        this._activatedRoute = activatedRoute;
        this.markActivatedRoute(activatedRoute);
        this.locationStrategy._finishBackPageNavigation(this.frame);
    }
    /**
     * Called by the Router to instantiate a new component during the commit phase of a navigation.
     * This method in turn is responsible for calling the `routerOnActivate` hook of its child.
     */
    activateWith(activatedRoute, resolver) {
        this.outlet = this.outlet || this.getOutlet(activatedRoute.snapshot);
        if (!this.outlet) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerError('No outlet found relative to activated route');
            }
            return;
        }
        this.outlet.isNSEmptyOutlet = this.isEmptyOutlet;
        this.locationStrategy.updateOutletFrame(this.outlet, this.frame, this.isEmptyOutlet);
        if (this.outlet && this.outlet.isPageNavigationBack) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.routerLog('Currently in page back navigation - component should be reattached instead of activated.');
            }
            this.locationStrategy._finishBackPageNavigation(this.frame);
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog(`PageRouterOutlet.activateWith() - ${routeToString(activatedRoute)}`);
        }
        this._activatedRoute = activatedRoute;
        this.markActivatedRoute(activatedRoute);
        resolver = resolver || this.resolver;
        this.activateOnGoForward(activatedRoute, resolver);
        this.activateEvents.emit(this.activated.instance);
    }
    activateOnGoForward(activatedRoute, loadedResolver) {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routerLog('PageRouterOutlet.activate() forward navigation - ' + 'create detached loader in the loader container');
        }
        const factory = this.getComponentFactory(activatedRoute, loadedResolver);
        const page = this.pageFactory({
            isNavigation: true,
            componentType: factory.componentType,
        });
        const destructables = new Set([]);
        const injector = Injector.create({
            providers: [
                { provide: Page, useValue: page },
                { provide: Frame, useValue: this.frame },
                { provide: PageRoute, useValue: new PageRoute(activatedRoute) },
                { provide: ActivatedRoute, useValue: activatedRoute },
                { provide: ChildrenOutletContexts, useValue: this.parentContexts.getOrCreateContext(this.name).children },
                { provide: PageService, useClass: PageService },
            ],
            parent: this.location.injector,
        });
        const childInjector = new DestructibleInjector(destructables, injector);
        const loaderRef = this.location.createComponent(this.detachedLoaderFactory, this.location.length, childInjector, []);
        loaderRef.onDestroy(() => childInjector.destroy());
        this.changeDetector.markForCheck();
        this.activated = loaderRef.instance.loadWithFactory(factory);
        this.activated.changeDetectorRef.detectChanges();
        this.loadComponentInPage(page, this.activated, { activatedRoute });
        this.activated[loaderRefSymbol] = loaderRef;
    }
    loadComponentInPage(page, componentRef, navigationContext) {
        // Component loaded. Find its root native view.
        const componentView = componentRef.location.nativeElement;
        // Remove it from original native parent.
        this.viewUtil.removeChild(componentView.parent, componentView);
        // Add it to the new page
        this.viewUtil.appendChild(page, componentView);
        const navigatedFromCallback = global.Zone.current.wrap((args) => {
            if (args.isBackNavigation) {
                this.locationStrategy._beginBackPageNavigation(this.frame);
                this.locationStrategy.back(null, this.frame);
            }
        });
        // TODO: experiment with using NgZone instead of global above
        // const navigatedFromCallback = (args: NavigatedData) => {
        // 	if (args.isBackNavigation) {
        //     this.ngZone.run(() => {
        //       this.locationStrategy._beginBackPageNavigation(this.frame);
        //       this.locationStrategy.back(null, this.frame);
        //     });
        // 	}
        // };
        page.on(Page.navigatedFromEvent, navigatedFromCallback);
        componentRef.onDestroy(() => {
            if (page) {
                page.off(Page.navigatedFromEvent, navigatedFromCallback);
                page = null;
            }
        });
        const navOptions = this.locationStrategy._beginPageNavigation(this.frame);
        // Clear refCache if navigation with clearHistory
        if (navOptions.clearHistory) {
            const clearCallback = () => setTimeout(() => {
                if (this.outlet) {
                    this.routeReuseStrategy.clearCache(this.outlet.outletKeys[0]);
                }
            });
            page.once(Page.navigatedToEvent, clearCallback);
        }
        this.frame.navigate({
            create() {
                return page;
            },
            context: navigationContext,
            clearHistory: navOptions.clearHistory,
            animated: navOptions.animated,
            transition: navOptions.transition,
        });
    }
    // Find and mark the top activated route as an activated one.
    // In ns-location-strategy we are reusing components only if their corresponing routes
    // are marked as activated from this method.
    markActivatedRoute(activatedRoute) {
        const queue = [];
        queue.push(activatedRoute.snapshot);
        let currentRoute = queue.shift();
        while (currentRoute) {
            currentRoute.children.forEach((childRoute) => {
                queue.push(childRoute);
            });
            const topActivatedRoute = findTopActivatedRouteNodeForOutlet(currentRoute);
            const outletKey = this.locationStrategy.getRouteFullPath(topActivatedRoute);
            const outlet = this.locationStrategy.findOutlet(outletKey, topActivatedRoute);
            if (outlet && outlet.frames.length) {
                topActivatedRoute[pageRouterActivatedSymbol] = true;
                if (NativeScriptDebug.isLogEnabled()) {
                    NativeScriptDebug.routerLog('Activated route marked as page: ' + routeToString(topActivatedRoute));
                }
            }
            currentRoute = queue.shift();
        }
    }
    getComponentFactory(activatedRoute, loadedResolver) {
        const { component } = activatedRoute.routeConfig;
        return loadedResolver ? loadedResolver.resolveComponentFactory(component) : this.componentFactoryResolver.resolveComponentFactory(component);
    }
    getOutlet(activatedRouteSnapshot) {
        const topActivatedRoute = findTopActivatedRouteNodeForOutlet(activatedRouteSnapshot);
        const outletKey = this.locationStrategy.getRouteFullPath(topActivatedRoute);
        let outlet = this.locationStrategy.findOutlet(outletKey, topActivatedRoute);
        // Named lazy loaded outlet.
        if (!outlet && this.isEmptyOutlet) {
            const parentOutletKey = this.locationStrategy.getRouteFullPath(topActivatedRoute.parent);
            outlet = this.locationStrategy.findOutlet(parentOutletKey, topActivatedRoute.parent);
            if (outlet) {
                outlet.outletKeys.push(outletKey);
            }
        }
        return outlet;
    }
}
PageRouterOutlet.decorators = [
    { type: Directive, args: [{ selector: 'page-router-outlet' }, // tslint:disable-line:directive-selector
        ] }
];
PageRouterOutlet.ctorParameters = () => [
    { type: ChildrenOutletContexts },
    { type: ViewContainerRef },
    { type: String, decorators: [{ type: Attribute, args: ['name',] }] },
    { type: String, decorators: [{ type: Attribute, args: ['actionBarVisibility',] }] },
    { type: Boolean, decorators: [{ type: Attribute, args: ['isEmptyOutlet',] }] },
    { type: NSLocationStrategy },
    { type: ComponentFactoryResolver },
    { type: ComponentFactoryResolver },
    { type: ChangeDetectorRef },
    { type: undefined, decorators: [{ type: Inject, args: [PAGE_FACTORY,] }] },
    { type: NSRouteReuseStrategy },
    { type: NgZone },
    { type: ElementRef },
    { type: ViewUtil }
];
PageRouterOutlet.propDecorators = {
    activateEvents: [{ type: Output, args: ['activate',] }],
    deactivateEvents: [{ type: Output, args: ['deactivate',] }]
};
__decorate([
    profile
], PageRouterOutlet.prototype, "activateWith", null);
__decorate([
    profile
], PageRouterOutlet.prototype, "loadComponentInPage", null);
export { Éµ0 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFnZS1yb3V0ZXItb3V0bGV0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL2xpYi9sZWdhY3kvcm91dGVyL3BhZ2Utcm91dGVyLW91dGxldC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxpQkFBaUIsRUFBb0Isd0JBQXdCLEVBQWdCLFNBQVMsRUFBRSxNQUFNLEVBQWtCLFFBQVEsRUFBYSxZQUFZLEVBQUUsTUFBTSxFQUFRLGdCQUFnQixFQUFFLFVBQVUsRUFBZSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDOVAsT0FBTyxFQUFFLGNBQWMsRUFBMEIsc0JBQXNCLEVBQUUsY0FBYyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFakgsT0FBTyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQWlCLE9BQU8sRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBRXpFLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFdkMsT0FBTyxFQUFFLFlBQVksRUFBZSxNQUFNLGNBQWMsQ0FBQztBQUN6RCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDaEQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQzNELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMzQyxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUU1RCxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUNqRSxPQUFPLEVBQUUsa0NBQWtDLEVBQUUseUJBQXlCLEVBQUUsZUFBZSxFQUFFLG1CQUFtQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDakosT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ3pELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxtQ0FBbUMsQ0FB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LFNBQVMsU0FBQyxlQUFlO1lBckdyQixrQkFBa0I7WUFYOEIsd0JBQXdCO1lBQXhCLHdCQUF3QjtZQUE3RCxpQkFBaUI7NENBcUhoQyxNQUFNLFNBQUMsWUFBWTtZQXhHZixvQkFBb0I7WUFibU0sTUFBTTtZQUEvQixVQUFVO1lBVXhNLFFBQVE7Ozs2QkEyRGQsTUFBTSxTQUFDLFVBQVU7K0JBRWpCLE1BQU0sU0FBQyxZQUFZOztBQStLcEI7SUFEQyxPQUFPO29EQWdDUDtBQXVDRDtJQURDLE9BQU87MkRBd0RQIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXR0cmlidXRlLCBDaGFuZ2VEZXRlY3RvclJlZiwgQ29tcG9uZW50RmFjdG9yeSwgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLCBDb21wb25lbnRSZWYsIERpcmVjdGl2ZSwgSW5qZWN0LCBJbmplY3Rpb25Ub2tlbiwgSW5qZWN0b3IsIE9uRGVzdHJveSwgRXZlbnRFbWl0dGVyLCBPdXRwdXQsIFR5cGUsIFZpZXdDb250YWluZXJSZWYsIEVsZW1lbnRSZWYsIEluamVjdEZsYWdzLCBOZ1pvbmUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFjdGl2YXRlZFJvdXRlLCBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90LCBDaGlsZHJlbk91dGxldENvbnRleHRzLCBQUklNQVJZX09VVExFVCB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5cbmltcG9ydCB7IEZyYW1lLCBQYWdlLCBOYXZpZ2F0ZWREYXRhLCBwcm9maWxlIH0gZnJvbSAnQG5hdGl2ZXNjcmlwdC9jb3JlJztcblxuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5cbmltcG9ydCB7IFBBR0VfRkFDVE9SWSwgUGFnZUZhY3RvcnkgfSBmcm9tICcuLi8uLi90b2tlbnMnO1xuaW1wb3J0IHsgTmF0aXZlU2NyaXB0RGVidWcgfSBmcm9tICcuLi8uLi90cmFjZSc7XG5pbXBvcnQgeyBEZXRhY2hlZExvYWRlciB9IGZyb20gJy4uLy4uL2Nkay9kZXRhY2hlZC1sb2FkZXInO1xuaW1wb3J0IHsgVmlld1V0aWwgfSBmcm9tICcuLi8uLi92aWV3LXV0aWwnO1xuaW1wb3J0IHsgTlNMb2NhdGlvblN0cmF0ZWd5IH0gZnJvbSAnLi9ucy1sb2NhdGlvbi1zdHJhdGVneSc7XG5pbXBvcnQgeyBPdXRsZXQgfSBmcm9tICcuL25zLWxvY2F0aW9uLXV0aWxzJztcbmltcG9ydCB7IE5TUm91dGVSZXVzZVN0cmF0ZWd5IH0gZnJvbSAnLi9ucy1yb3V0ZS1yZXVzZS1zdHJhdGVneSc7XG5pbXBvcnQgeyBmaW5kVG9wQWN0aXZhdGVkUm91dGVOb2RlRm9yT3V0bGV0LCBwYWdlUm91dGVyQWN0aXZhdGVkU3ltYm9sLCBsb2FkZXJSZWZTeW1ib2wsIGRlc3Ryb3lDb21wb25lbnRSZWYgfSBmcm9tICcuL3BhZ2Utcm91dGVyLW91dGxldC11dGlscyc7XG5pbXBvcnQgeyByZWdpc3RlckVsZW1lbnQgfSBmcm9tICcuLi8uLi9lbGVtZW50LXJlZ2lzdHJ5JztcbmltcG9ydCB7IFBhZ2VTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vY2RrL2ZyYW1lLXBhZ2UvcGFnZS5zZXJ2aWNlJztcblxuZXhwb3J0IGNsYXNzIFBhZ2VSb3V0ZSB7XG4gIGFjdGl2YXRlZFJvdXRlOiBCZWhhdmlvclN1YmplY3Q8QWN0aXZhdGVkUm91dGU+O1xuXG4gIGNvbnN0cnVjdG9yKHN0YXJ0Um91dGU6IEFjdGl2YXRlZFJvdXRlKSB7XG4gICAgdGhpcy5hY3RpdmF0ZWRSb3V0ZSA9IG5ldyBCZWhhdmlvclN1YmplY3Qoc3RhcnRSb3V0ZSk7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIERlc3RydWN0aWJsZUluamVjdG9yIGltcGxlbWVudHMgSW5qZWN0b3Ige1xuICBwcml2YXRlIHJlZnMgPSBuZXcgU2V0PGFueT4oKTtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBkZXN0cnVjdGFibGVQcm92aWRlcnM6IFByb3ZpZGVyU2V0LCBwcml2YXRlIHBhcmVudDogSW5qZWN0b3IpIHt9XG4gIGdldDxUPih0b2tlbjogVHlwZTxUPiB8IEluamVjdGlvblRva2VuPFQ+LCBub3RGb3VuZFZhbHVlPzogVCwgZmxhZ3M/OiBJbmplY3RGbGFncyk6IFQge1xuICAgIGNvbnN0IHJlZiA9IHRoaXMucGFyZW50LmdldCh0b2tlbiwgbm90Rm91bmRWYWx1ZSwgZmxhZ3MpO1xuICAgIGlmICh0aGlzLmRlc3RydWN0YWJsZVByb3ZpZGVycy5oYXModG9rZW4pKSB7XG4gICAgICB0aGlzLnJlZnMuYWRkKHJlZik7XG4gICAgfVxuICAgIHJldHVybiByZWY7XG4gIH1cbiAgZGVzdHJveSgpIHtcbiAgICB0aGlzLnJlZnMuZm9yRWFjaCgocmVmKSA9PiB7XG4gICAgICBpZiAocmVmLm5nT25EZXN0cm95IGluc3RhbmNlb2YgRnVuY3Rpb24pIHtcbiAgICAgICAgcmVmLm5nT25EZXN0cm95KCk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgdGhpcy5yZWZzLmNsZWFyKCk7XG4gIH1cbn1cblxudHlwZSBQcm92aWRlclNldCA9IFNldDxUeXBlPGFueT4gfCBJbmplY3Rpb25Ub2tlbjxhbnk+PjtcblxuY29uc3Qgcm91dGVUb1N0cmluZyA9IGZ1bmN0aW9uIChhY3RpdmF0ZWRSb3V0ZTogQWN0aXZhdGVkUm91dGUgfCBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90KTogc3RyaW5nIHtcbiAgcmV0dXJuIGFjdGl2YXRlZFJvdXRlLnBhdGhGcm9tUm9vdC5qb2luKCctPicpO1xufTtcblxucmVnaXN0ZXJFbGVtZW50KCdwYWdlLXJvdXRlci1vdXRsZXQnLCAoKSA9PiBGcmFtZSk7XG4vLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQGFuZ3VsYXItZXNsaW50L2RpcmVjdGl2ZS1zZWxlY3RvclxuQERpcmVjdGl2ZSh7IHNlbGVjdG9yOiAncGFnZS1yb3V0ZXItb3V0bGV0JyB9KSAvLyB0c2xpbnQ6ZGlzYWJsZS1saW5lOmRpcmVjdGl2ZS1zZWxlY3RvclxuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEBhbmd1bGFyLWVzbGludC9kaXJlY3RpdmUtY2xhc3Mtc3VmZml4XG5leHBvcnQgY2xhc3MgUGFnZVJvdXRlck91dGxldCBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XG4gIC8vIHRzbGludDpkaXNhYmxlLWxpbmU6ZGlyZWN0aXZlLWNsYXNzLXN1ZmZpeFxuICBwcml2YXRlIGFjdGl2YXRlZDogQ29tcG9uZW50UmVmPGFueT4gfCBudWxsID0gbnVsbDtcbiAgcHJpdmF0ZSBfYWN0aXZhdGVkUm91dGU6IEFjdGl2YXRlZFJvdXRlIHwgbnVsbCA9IG51bGw7XG4gIHByaXZhdGUgZGV0YWNoZWRMb2FkZXJGYWN0b3J5OiBDb21wb25lbnRGYWN0b3J5PERldGFjaGVkTG9hZGVyPjtcblxuICBwcml2YXRlIG91dGxldDogT3V0bGV0O1xuICBwcml2YXRlIG5hbWU6IHN0cmluZztcbiAgcHJpdmF0ZSBpc0VtcHR5T3V0bGV0OiBib29sZWFuO1xuICBwcml2YXRlIHZpZXdVdGlsOiBWaWV3VXRpbDtcbiAgcHJpdmF0ZSBmcmFtZTogRnJhbWU7XG5cbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEBhbmd1bGFyLWVzbGludC9uby1vdXRwdXQtcmVuYW1lXG4gIEBPdXRwdXQoJ2FjdGl2YXRlJykgYWN0aXZhdGVFdmVudHMgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTsgLy8gdHNsaW50OmRpc2FibGUtbGluZTpuby1vdXRwdXQtcmVuYW1lXG4gIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAYW5ndWxhci1lc2xpbnQvbm8tb3V0cHV0LXJlbmFtZVxuICBAT3V0cHV0KCdkZWFjdGl2YXRlJykgZGVhY3RpdmF0ZUV2ZW50cyA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpOyAvLyB0c2xpbnQ6ZGlzYWJsZS1saW5lOm5vLW91dHB1dC1yZW5hbWVcblxuICAvKiogQGRlcHJlY2F0ZWQgZnJvbSBBbmd1bGFyIHNpbmNlIHY0ICovXG4gIGdldCBsb2NhdGlvbkluamVjdG9yKCk6IEluamVjdG9yIHtcbiAgICByZXR1cm4gdGhpcy5sb2NhdGlvbi5pbmplY3RvcjtcbiAgfVxuICAvKiogQGRlcHJlY2F0ZWQgZnJvbSBBbmd1bGFyIHNpbmNlIHY0ICovXG4gIGdldCBsb2NhdGlvbkZhY3RvcnlSZXNvbHZlcigpOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIge1xuICAgIHJldHVybiB0aGlzLnJlc29sdmVyO1xuICB9XG5cbiAgZ2V0IGlzQWN0aXZhdGVkKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAhIXRoaXMuYWN0aXZhdGVkO1xuICB9XG5cbiAgZ2V0IGNvbXBvbmVudCgpOiB1bmtub3duIHtcbiAgICBpZiAoIXRoaXMuYWN0aXZhdGVkKSB7XG4gICAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKCdPdXRsZXQgaXMgbm90IGFjdGl2YXRlZCcpO1xuICAgICAgfVxuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLmFjdGl2YXRlZC5pbnN0YW5jZTtcbiAgfVxuICBnZXQgYWN0aXZhdGVkUm91dGUoKTogQWN0aXZhdGVkUm91dGUge1xuICAgIGlmICghdGhpcy5hY3RpdmF0ZWQpIHtcbiAgICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ091dGxldCBpcyBub3QgYWN0aXZhdGVkJyk7XG4gICAgICB9XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuX2FjdGl2YXRlZFJvdXRlO1xuICB9XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBwYXJlbnRDb250ZXh0czogQ2hpbGRyZW5PdXRsZXRDb250ZXh0cyxcbiAgICBwcml2YXRlIGxvY2F0aW9uOiBWaWV3Q29udGFpbmVyUmVmLFxuICAgIEBBdHRyaWJ1dGUoJ25hbWUnKSBuYW1lOiBzdHJpbmcsXG4gICAgQEF0dHJpYnV0ZSgnYWN0aW9uQmFyVmlzaWJpbGl0eScpIGFjdGlvbkJhclZpc2liaWxpdHk6IHN0cmluZyxcbiAgICBAQXR0cmlidXRlKCdpc0VtcHR5T3V0bGV0JykgaXNFbXB0eU91dGxldDogYm9vbGVhbixcbiAgICBwcml2YXRlIGxvY2F0aW9uU3RyYXRlZ3k6IE5TTG9jYXRpb25TdHJhdGVneSxcbiAgICBwcml2YXRlIGNvbXBvbmVudEZhY3RvcnlSZXNvbHZlcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxuICAgIHByaXZhdGUgcmVzb2x2ZXI6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcbiAgICBwcml2YXRlIGNoYW5nZURldGVjdG9yOiBDaGFuZ2VEZXRlY3RvclJlZixcbiAgICBASW5qZWN0KFBBR0VfRkFDVE9SWSkgcHJpdmF0ZSBwYWdlRmFjdG9yeTogUGFnZUZhY3RvcnksXG4gICAgcHJpdmF0ZSByb3V0ZVJldXNlU3RyYXRlZ3k6IE5TUm91dGVSZXVzZVN0cmF0ZWd5LFxuICAgIHByaXZhdGUgbmdab25lOiBOZ1pvbmUsXG4gICAgZWxSZWY6IEVsZW1lbnRSZWYsXG4gICAgdmlld1V0aWw6IFZpZXdVdGlsXG4gICkge1xuICAgIHRoaXMuaXNFbXB0eU91dGxldCA9IGlzRW1wdHlPdXRsZXQ7XG4gICAgdGhpcy5mcmFtZSA9IGVsUmVmLm5hdGl2ZUVsZW1lbnQ7XG4gICAgdGhpcy5zZXRBY3Rpb25CYXJWaXNpYmlsaXR5KGFjdGlvbkJhclZpc2liaWxpdHkpO1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKGBQYWdlUm91dGVyT3V0bGV0LmNvbnN0cnVjdG9yIGZyYW1lOiAke3RoaXMuZnJhbWV9YCk7XG4gICAgfVxuXG4gICAgdGhpcy5uYW1lID0gbmFtZSB8fCBQUklNQVJZX09VVExFVDtcbiAgICBwYXJlbnRDb250ZXh0cy5vbkNoaWxkT3V0bGV0Q3JlYXRlZCh0aGlzLm5hbWUsIDxhbnk+dGhpcyk7XG5cbiAgICB0aGlzLnZpZXdVdGlsID0gdmlld1V0aWw7XG4gICAgdGhpcy5kZXRhY2hlZExvYWRlckZhY3RvcnkgPSByZXNvbHZlci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeShEZXRhY2hlZExvYWRlcik7XG4gIH1cblxuICBzZXRBY3Rpb25CYXJWaXNpYmlsaXR5KGFjdGlvbkJhclZpc2liaWxpdHk6IHN0cmluZyk6IHZvaWQge1xuICAgIHN3aXRjaCAoYWN0aW9uQmFyVmlzaWJpbGl0eSkge1xuICAgICAgY2FzZSAnYWx3YXlzJzpcbiAgICAgIGNhc2UgJ25ldmVyJzpcbiAgICAgICAgdGhpcy5mcmFtZS5hY3Rpb25CYXJWaXNpYmlsaXR5ID0gYWN0aW9uQmFyVmlzaWJpbGl0eTtcbiAgICAgICAgcmV0dXJuO1xuXG4gICAgICBkZWZhdWx0OlxuICAgICAgICB0aGlzLmZyYW1lLmFjdGlvbkJhclZpc2liaWxpdHkgPSAnYXV0byc7XG4gICAgfVxuICB9XG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgLy8gQ2xlYXIgYWNjdW11bGF0ZWQgbW9kYWwgdmlldyBwYWdlIGNhY2hlIHdoZW4gcGFnZS1yb3V0ZXItb3V0bGV0XG4gICAgLy8gZGVzdHJveWVkIG9uIG1vZGFsIHZpZXcgY2xvc2luZ1xuICAgIHRoaXMucGFyZW50Q29udGV4dHMub25DaGlsZE91dGxldERlc3Ryb3llZCh0aGlzLm5hbWUpO1xuXG4gICAgaWYgKHRoaXMub3V0bGV0KSB7XG4gICAgICB0aGlzLm91dGxldC5vdXRsZXRLZXlzLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgICB0aGlzLnJvdXRlUmV1c2VTdHJhdGVneS5jbGVhck1vZGFsQ2FjaGUoa2V5KTtcbiAgICAgIH0pO1xuICAgICAgdGhpcy5sb2NhdGlvblN0cmF0ZWd5LmNsZWFyT3V0bGV0KHRoaXMuZnJhbWUpO1xuICAgIH0gZWxzZSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ1BhZ2VSb3V0ZXJPdXRsZXQubmdPbkRlc3Ryb3k6IG5vIG91dGxldCBhdmFpbGFibGUgZm9yIHBhZ2Utcm91dGVyLW91dGxldCcpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmlzQWN0aXZhdGVkKSB7XG4gICAgICBjb25zdCBjID0gdGhpcy5hY3RpdmF0ZWQuaW5zdGFuY2U7XG4gICAgICB0aGlzLmFjdGl2YXRlZC5ob3N0Vmlldy5kZXRhY2goKTtcbiAgICAgIGRlc3Ryb3lDb21wb25lbnRSZWYodGhpcy5hY3RpdmF0ZWQpO1xuXG4gICAgICB0aGlzLmRlYWN0aXZhdGVFdmVudHMuZW1pdChjKTtcbiAgICAgIHRoaXMuYWN0aXZhdGVkID0gbnVsbDtcbiAgICB9XG4gIH1cblxuICBkZWFjdGl2YXRlKCk6IHZvaWQge1xuICAgIGlmICghdGhpcy5vdXRsZXQgfHwgIXRoaXMub3V0bGV0LmlzUGFnZU5hdmlnYXRpb25CYWNrKSB7XG4gICAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKCdDdXJyZW50bHkgbm90IGluIHBhZ2UgYmFjayBuYXZpZ2F0aW9uIC0gY29tcG9uZW50IHNob3VsZCBiZSBkZXRhY2hlZCBpbnN0ZWFkIG9mIGRlYWN0aXZhdGVkLicpO1xuICAgICAgfVxuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKCdQYWdlUm91dGVyT3V0bGV0LmRlYWN0aXZhdGUoKSB3aGlsZSBnb2luZyBiYWNrIC0gc2hvdWxkIGRlc3Ryb3knKTtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMuaXNBY3RpdmF0ZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBjID0gdGhpcy5hY3RpdmF0ZWQuaW5zdGFuY2U7XG4gICAgZGVzdHJveUNvbXBvbmVudFJlZih0aGlzLmFjdGl2YXRlZCk7XG5cbiAgICB0aGlzLmFjdGl2YXRlZCA9IG51bGw7XG4gICAgdGhpcy5fYWN0aXZhdGVkUm91dGUgPSBudWxsO1xuXG4gICAgdGhpcy5kZWFjdGl2YXRlRXZlbnRzLmVtaXQoYyk7XG4gIH1cblxuICAvKipcbiAgICogQ2FsbGVkIHdoZW4gdGhlIGBSb3V0ZVJldXNlU3RyYXRlZ3lgIGluc3RydWN0cyB0byBkZXRhY2ggdGhlIHN1YnRyZWVcbiAgICovXG4gIGRldGFjaCgpOiBDb21wb25lbnRSZWY8YW55PiB7XG4gICAgaWYgKCF0aGlzLmlzQWN0aXZhdGVkKSB7XG4gICAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKCdPdXRsZXQgaXMgbm90IGFjdGl2YXRlZCcpO1xuICAgICAgfVxuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKGBQYWdlUm91dGVyT3V0bGV0LmRldGFjaCgpIC0gJHtyb3V0ZVRvU3RyaW5nKHRoaXMuX2FjdGl2YXRlZFJvdXRlKX1gKTtcbiAgICB9XG5cbiAgICAvLyBEZXRhY2ggZnJvbSBDaGFuZ2VEZXRlY3Rpb25cbiAgICB0aGlzLmFjdGl2YXRlZC5ob3N0Vmlldy5kZXRhY2goKTtcblxuICAgIGNvbnN0IGNvbXBvbmVudCA9IHRoaXMuYWN0aXZhdGVkO1xuICAgIHRoaXMuYWN0aXZhdGVkID0gbnVsbDtcbiAgICB0aGlzLl9hY3RpdmF0ZWRSb3V0ZSA9IG51bGw7XG4gICAgcmV0dXJuIGNvbXBvbmVudDtcbiAgfVxuXG4gIC8qKlxuICAgKiBDYWxsZWQgd2hlbiB0aGUgYFJvdXRlUmV1c2VTdHJhdGVneWAgaW5zdHJ1Y3RzIHRvIHJlLWF0dGFjaCBhIHByZXZpb3VzbHkgZGV0YWNoZWQgc3VidHJlZVxuICAgKi9cbiAgYXR0YWNoKHJlZjogQ29tcG9uZW50UmVmPGFueT4sIGFjdGl2YXRlZFJvdXRlOiBBY3RpdmF0ZWRSb3V0ZSkge1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKGBQYWdlUm91dGVyT3V0bGV0LmF0dGFjaCgpIC0gJHtyb3V0ZVRvU3RyaW5nKGFjdGl2YXRlZFJvdXRlKX1gKTtcbiAgICB9XG5cbiAgICB0aGlzLmFjdGl2YXRlZCA9IHJlZjtcblxuICAgIC8vIHJlYXR0YWNoIHRvIENoYW5nZURldGVjdGlvblxuICAgIHRoaXMuYWN0aXZhdGVkLmhvc3RWaWV3Lm1hcmtGb3JDaGVjaygpO1xuICAgIHRoaXMuYWN0aXZhdGVkLmhvc3RWaWV3LnJlYXR0YWNoKCk7XG4gICAgdGhpcy5fYWN0aXZhdGVkUm91dGUgPSBhY3RpdmF0ZWRSb3V0ZTtcbiAgICB0aGlzLm1hcmtBY3RpdmF0ZWRSb3V0ZShhY3RpdmF0ZWRSb3V0ZSk7XG5cbiAgICB0aGlzLmxvY2F0aW9uU3RyYXRlZ3kuX2ZpbmlzaEJhY2tQYWdlTmF2aWdhdGlvbih0aGlzLmZyYW1lKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDYWxsZWQgYnkgdGhlIFJvdXRlciB0byBpbnN0YW50aWF0ZSBhIG5ldyBjb21wb25lbnQgZHVyaW5nIHRoZSBjb21taXQgcGhhc2Ugb2YgYSBuYXZpZ2F0aW9uLlxuICAgKiBUaGlzIG1ldGhvZCBpbiB0dXJuIGlzIHJlc3BvbnNpYmxlIGZvciBjYWxsaW5nIHRoZSBgcm91dGVyT25BY3RpdmF0ZWAgaG9vayBvZiBpdHMgY2hpbGQuXG4gICAqL1xuICBAcHJvZmlsZVxuICBhY3RpdmF0ZVdpdGgoYWN0aXZhdGVkUm91dGU6IEFjdGl2YXRlZFJvdXRlLCByZXNvbHZlcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyIHwgbnVsbCk6IHZvaWQge1xuICAgIHRoaXMub3V0bGV0ID0gdGhpcy5vdXRsZXQgfHwgdGhpcy5nZXRPdXRsZXQoYWN0aXZhdGVkUm91dGUuc25hcHNob3QpO1xuICAgIGlmICghdGhpcy5vdXRsZXQpIHtcbiAgICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJFcnJvcignTm8gb3V0bGV0IGZvdW5kIHJlbGF0aXZlIHRvIGFjdGl2YXRlZCByb3V0ZScpO1xuICAgICAgfVxuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMub3V0bGV0LmlzTlNFbXB0eU91dGxldCA9IHRoaXMuaXNFbXB0eU91dGxldDtcbiAgICB0aGlzLmxvY2F0aW9uU3RyYXRlZ3kudXBkYXRlT3V0bGV0RnJhbWUodGhpcy5vdXRsZXQsIHRoaXMuZnJhbWUsIHRoaXMuaXNFbXB0eU91dGxldCk7XG5cbiAgICBpZiAodGhpcy5vdXRsZXQgJiYgdGhpcy5vdXRsZXQuaXNQYWdlTmF2aWdhdGlvbkJhY2spIHtcbiAgICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ0N1cnJlbnRseSBpbiBwYWdlIGJhY2sgbmF2aWdhdGlvbiAtIGNvbXBvbmVudCBzaG91bGQgYmUgcmVhdHRhY2hlZCBpbnN0ZWFkIG9mIGFjdGl2YXRlZC4nKTtcbiAgICAgIH1cbiAgICAgIHRoaXMubG9jYXRpb25TdHJhdGVneS5fZmluaXNoQmFja1BhZ2VOYXZpZ2F0aW9uKHRoaXMuZnJhbWUpO1xuICAgIH1cblxuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVyTG9nKGBQYWdlUm91dGVyT3V0bGV0LmFjdGl2YXRlV2l0aCgpIC0gJHtyb3V0ZVRvU3RyaW5nKGFjdGl2YXRlZFJvdXRlKX1gKTtcbiAgICB9XG5cbiAgICB0aGlzLl9hY3RpdmF0ZWRSb3V0ZSA9IGFjdGl2YXRlZFJvdXRlO1xuXG4gICAgdGhpcy5tYXJrQWN0aXZhdGVkUm91dGUoYWN0aXZhdGVkUm91dGUpO1xuXG4gICAgcmVzb2x2ZXIgPSByZXNvbHZlciB8fCB0aGlzLnJlc29sdmVyO1xuXG4gICAgdGhpcy5hY3RpdmF0ZU9uR29Gb3J3YXJkKGFjdGl2YXRlZFJvdXRlLCByZXNvbHZlcik7XG4gICAgdGhpcy5hY3RpdmF0ZUV2ZW50cy5lbWl0KHRoaXMuYWN0aXZhdGVkLmluc3RhbmNlKTtcbiAgfVxuXG4gIHByaXZhdGUgYWN0aXZhdGVPbkdvRm9yd2FyZChhY3RpdmF0ZWRSb3V0ZTogQWN0aXZhdGVkUm91dGUsIGxvYWRlZFJlc29sdmVyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIpOiB2b2lkIHtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlckxvZygnUGFnZVJvdXRlck91dGxldC5hY3RpdmF0ZSgpIGZvcndhcmQgbmF2aWdhdGlvbiAtICcgKyAnY3JlYXRlIGRldGFjaGVkIGxvYWRlciBpbiB0aGUgbG9hZGVyIGNvbnRhaW5lcicpO1xuICAgIH1cblxuICAgIGNvbnN0IGZhY3RvcnkgPSB0aGlzLmdldENvbXBvbmVudEZhY3RvcnkoYWN0aXZhdGVkUm91dGUsIGxvYWRlZFJlc29sdmVyKTtcbiAgICBjb25zdCBwYWdlID0gdGhpcy5wYWdlRmFjdG9yeSh7XG4gICAgICBpc05hdmlnYXRpb246IHRydWUsXG4gICAgICBjb21wb25lbnRUeXBlOiBmYWN0b3J5LmNvbXBvbmVudFR5cGUsXG4gICAgfSk7XG5cbiAgICBjb25zdCBkZXN0cnVjdGFibGVzID0gbmV3IFNldChbXSk7XG4gICAgY29uc3QgaW5qZWN0b3IgPSBJbmplY3Rvci5jcmVhdGUoe1xuICAgICAgcHJvdmlkZXJzOiBbXG4gICAgICAgIHsgcHJvdmlkZTogUGFnZSwgdXNlVmFsdWU6IHBhZ2UgfSxcbiAgICAgICAgeyBwcm92aWRlOiBGcmFtZSwgdXNlVmFsdWU6IHRoaXMuZnJhbWUgfSxcbiAgICAgICAgeyBwcm92aWRlOiBQYWdlUm91dGUsIHVzZVZhbHVlOiBuZXcgUGFnZVJvdXRlKGFjdGl2YXRlZFJvdXRlKSB9LFxuICAgICAgICB7IHByb3ZpZGU6IEFjdGl2YXRlZFJvdXRlLCB1c2VWYWx1ZTogYWN0aXZhdGVkUm91dGUgfSxcbiAgICAgICAgeyBwcm92aWRlOiBDaGlsZHJlbk91dGxldENvbnRleHRzLCB1c2VWYWx1ZTogdGhpcy5wYXJlbnRDb250ZXh0cy5nZXRPckNyZWF0ZUNvbnRleHQodGhpcy5uYW1lKS5jaGlsZHJlbiB9LFxuICAgICAgICB7IHByb3ZpZGU6IFBhZ2VTZXJ2aWNlLCB1c2VDbGFzczogUGFnZVNlcnZpY2UgfSxcbiAgICAgIF0sXG4gICAgICBwYXJlbnQ6IHRoaXMubG9jYXRpb24uaW5qZWN0b3IsXG4gICAgfSk7XG5cbiAgICBjb25zdCBjaGlsZEluamVjdG9yID0gbmV3IERlc3RydWN0aWJsZUluamVjdG9yKGRlc3RydWN0YWJsZXMsIGluamVjdG9yKTtcbiAgICBjb25zdCBsb2FkZXJSZWYgPSB0aGlzLmxvY2F0aW9uLmNyZWF0ZUNvbXBvbmVudCh0aGlzLmRldGFjaGVkTG9hZGVyRmFjdG9yeSwgdGhpcy5sb2NhdGlvbi5sZW5ndGgsIGNoaWxkSW5qZWN0b3IsIFtdKTtcbiAgICBsb2FkZXJSZWYub25EZXN0cm95KCgpID0+IGNoaWxkSW5qZWN0b3IuZGVzdHJveSgpKTtcbiAgICB0aGlzLmNoYW5nZURldGVjdG9yLm1hcmtGb3JDaGVjaygpO1xuXG4gICAgdGhpcy5hY3RpdmF0ZWQgPSBsb2FkZXJSZWYuaW5zdGFuY2UubG9hZFdpdGhGYWN0b3J5KGZhY3RvcnkpO1xuICAgIHRoaXMuYWN0aXZhdGVkLmNoYW5nZURldGVjdG9yUmVmLmRldGVjdENoYW5nZXMoKTtcbiAgICB0aGlzLmxvYWRDb21wb25lbnRJblBhZ2UocGFnZSwgdGhpcy5hY3RpdmF0ZWQsIHsgYWN0aXZhdGVkUm91dGUgfSk7XG5cbiAgICB0aGlzLmFjdGl2YXRlZFtsb2FkZXJSZWZTeW1ib2xdID0gbG9hZGVyUmVmO1xuICB9XG5cbiAgQHByb2ZpbGVcbiAgcHJpdmF0ZSBsb2FkQ29tcG9uZW50SW5QYWdlKHBhZ2U6IFBhZ2UsIGNvbXBvbmVudFJlZjogQ29tcG9uZW50UmVmPGFueT4sIG5hdmlnYXRpb25Db250ZXh0KTogdm9pZCB7XG4gICAgLy8gQ29tcG9uZW50IGxvYWRlZC4gRmluZCBpdHMgcm9vdCBuYXRpdmUgdmlldy5cbiAgICBjb25zdCBjb21wb25lbnRWaWV3ID0gY29tcG9uZW50UmVmLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnQ7XG4gICAgLy8gUmVtb3ZlIGl0IGZyb20gb3JpZ2luYWwgbmF0aXZlIHBhcmVudC5cbiAgICB0aGlzLnZpZXdVdGlsLnJlbW92ZUNoaWxkKGNvbXBvbmVudFZpZXcucGFyZW50LCBjb21wb25lbnRWaWV3KTtcbiAgICAvLyBBZGQgaXQgdG8gdGhlIG5ldyBwYWdlXG4gICAgdGhpcy52aWV3VXRpbC5hcHBlbmRDaGlsZChwYWdlLCBjb21wb25lbnRWaWV3KTtcblxuICAgIGNvbnN0IG5hdmlnYXRlZEZyb21DYWxsYmFjayA9ICg8YW55Pmdsb2JhbCkuWm9uZS5jdXJyZW50LndyYXAoKGFyZ3M6IE5hdmlnYXRlZERhdGEpID0+IHtcbiAgICAgIGlmIChhcmdzLmlzQmFja05hdmlnYXRpb24pIHtcbiAgICAgICAgdGhpcy5sb2NhdGlvblN0cmF0ZWd5Ll9iZWdpbkJhY2tQYWdlTmF2aWdhdGlvbih0aGlzLmZyYW1lKTtcbiAgICAgICAgdGhpcy5sb2NhdGlvblN0cmF0ZWd5LmJhY2sobnVsbCwgdGhpcy5mcmFtZSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgLy8gVE9ETzogZXhwZXJpbWVudCB3aXRoIHVzaW5nIE5nWm9uZSBpbnN0ZWFkIG9mIGdsb2JhbCBhYm92ZVxuICAgIC8vIGNvbnN0IG5hdmlnYXRlZEZyb21DYWxsYmFjayA9IChhcmdzOiBOYXZpZ2F0ZWREYXRhKSA9PiB7XG4gICAgLy8gXHRpZiAoYXJncy5pc0JhY2tOYXZpZ2F0aW9uKSB7XG4gICAgLy8gICAgIHRoaXMubmdab25lLnJ1bigoKSA9PiB7XG4gICAgLy8gICAgICAgdGhpcy5sb2NhdGlvblN0cmF0ZWd5Ll9iZWdpbkJhY2tQYWdlTmF2aWdhdGlvbih0aGlzLmZyYW1lKTtcbiAgICAvLyAgICAgICB0aGlzLmxvY2F0aW9uU3RyYXRlZ3kuYmFjayhudWxsLCB0aGlzLmZyYW1lKTtcbiAgICAvLyAgICAgfSk7XG4gICAgLy8gXHR9XG4gICAgLy8gfTtcblxuICAgIHBhZ2Uub24oUGFnZS5uYXZpZ2F0ZWRGcm9tRXZlbnQsIG5hdmlnYXRlZEZyb21DYWxsYmFjayk7XG4gICAgY29tcG9uZW50UmVmLm9uRGVzdHJveSgoKSA9PiB7XG4gICAgICBpZiAocGFnZSkge1xuICAgICAgICBwYWdlLm9mZihQYWdlLm5hdmlnYXRlZEZyb21FdmVudCwgbmF2aWdhdGVkRnJvbUNhbGxiYWNrKTtcbiAgICAgICAgcGFnZSA9IG51bGw7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBjb25zdCBuYXZPcHRpb25zID0gdGhpcy5sb2NhdGlvblN0cmF0ZWd5Ll9iZWdpblBhZ2VOYXZpZ2F0aW9uKHRoaXMuZnJhbWUpO1xuXG4gICAgLy8gQ2xlYXIgcmVmQ2FjaGUgaWYgbmF2aWdhdGlvbiB3aXRoIGNsZWFySGlzdG9yeVxuICAgIGlmIChuYXZPcHRpb25zLmNsZWFySGlzdG9yeSkge1xuICAgICAgY29uc3QgY2xlYXJDYWxsYmFjayA9ICgpID0+XG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgIGlmICh0aGlzLm91dGxldCkge1xuICAgICAgICAgICAgdGhpcy5yb3V0ZVJldXNlU3RyYXRlZ3kuY2xlYXJDYWNoZSh0aGlzLm91dGxldC5vdXRsZXRLZXlzWzBdKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICBwYWdlLm9uY2UoUGFnZS5uYXZpZ2F0ZWRUb0V2ZW50LCBjbGVhckNhbGxiYWNrKTtcbiAgICB9XG5cbiAgICB0aGlzLmZyYW1lLm5hdmlnYXRlKHtcbiAgICAgIGNyZWF0ZSgpIHtcbiAgICAgICAgcmV0dXJuIHBhZ2U7XG4gICAgICB9LFxuICAgICAgY29udGV4dDogbmF2aWdhdGlvbkNvbnRleHQsXG4gICAgICBjbGVhckhpc3Rvcnk6IG5hdk9wdGlvbnMuY2xlYXJIaXN0b3J5LFxuICAgICAgYW5pbWF0ZWQ6IG5hdk9wdGlvbnMuYW5pbWF0ZWQsXG4gICAgICB0cmFuc2l0aW9uOiBuYXZPcHRpb25zLnRyYW5zaXRpb24sXG4gICAgfSk7XG4gIH1cblxuICAvLyBGaW5kIGFuZCBtYXJrIHRoZSB0b3AgYWN0aXZhdGVkIHJvdXRlIGFzIGFuIGFjdGl2YXRlZCBvbmUuXG4gIC8vIEluIG5zLWxvY2F0aW9uLXN0cmF0ZWd5IHdlIGFyZSByZXVzaW5nIGNvbXBvbmVudHMgb25seSBpZiB0aGVpciBjb3JyZXNwb25pbmcgcm91dGVzXG4gIC8vIGFyZSBtYXJrZWQgYXMgYWN0aXZhdGVkIGZyb20gdGhpcyBtZXRob2QuXG4gIHByaXZhdGUgbWFya0FjdGl2YXRlZFJvdXRlKGFjdGl2YXRlZFJvdXRlOiBBY3RpdmF0ZWRSb3V0ZSkge1xuICAgIGNvbnN0IHF1ZXVlID0gW107XG4gICAgcXVldWUucHVzaChhY3RpdmF0ZWRSb3V0ZS5zbmFwc2hvdCk7XG4gICAgbGV0IGN1cnJlbnRSb3V0ZSA9IHF1ZXVlLnNoaWZ0KCk7XG5cbiAgICB3aGlsZSAoY3VycmVudFJvdXRlKSB7XG4gICAgICBjdXJyZW50Um91dGUuY2hpbGRyZW4uZm9yRWFjaCgoY2hpbGRSb3V0ZSkgPT4ge1xuICAgICAgICBxdWV1ZS5wdXNoKGNoaWxkUm91dGUpO1xuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHRvcEFjdGl2YXRlZFJvdXRlID0gZmluZFRvcEFjdGl2YXRlZFJvdXRlTm9kZUZvck91dGxldChjdXJyZW50Um91dGUpO1xuICAgICAgY29uc3Qgb3V0bGV0S2V5ID0gdGhpcy5sb2NhdGlvblN0cmF0ZWd5LmdldFJvdXRlRnVsbFBhdGgodG9wQWN0aXZhdGVkUm91dGUpO1xuICAgICAgY29uc3Qgb3V0bGV0ID0gdGhpcy5sb2NhdGlvblN0cmF0ZWd5LmZpbmRPdXRsZXQob3V0bGV0S2V5LCB0b3BBY3RpdmF0ZWRSb3V0ZSk7XG5cbiAgICAgIGlmIChvdXRsZXQgJiYgb3V0bGV0LmZyYW1lcy5sZW5ndGgpIHtcbiAgICAgICAgdG9wQWN0aXZhdGVkUm91dGVbcGFnZVJvdXRlckFjdGl2YXRlZFN5bWJvbF0gPSB0cnVlO1xuICAgICAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZXJMb2coJ0FjdGl2YXRlZCByb3V0ZSBtYXJrZWQgYXMgcGFnZTogJyArIHJvdXRlVG9TdHJpbmcodG9wQWN0aXZhdGVkUm91dGUpKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBjdXJyZW50Um91dGUgPSBxdWV1ZS5zaGlmdCgpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0Q29tcG9uZW50RmFjdG9yeShhY3RpdmF0ZWRSb3V0ZTogQWN0aXZhdGVkUm91dGUsIGxvYWRlZFJlc29sdmVyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIpOiBDb21wb25lbnRGYWN0b3J5PGFueT4ge1xuICAgIGNvbnN0IHsgY29tcG9uZW50IH0gPSBhY3RpdmF0ZWRSb3V0ZS5yb3V0ZUNvbmZpZztcblxuICAgIHJldHVybiBsb2FkZWRSZXNvbHZlciA/IGxvYWRlZFJlc29sdmVyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KGNvbXBvbmVudCkgOiB0aGlzLmNvbXBvbmVudEZhY3RvcnlSZXNvbHZlci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeShjb21wb25lbnQpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRPdXRsZXQoYWN0aXZhdGVkUm91dGVTbmFwc2hvdDogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCk6IE91dGxldCB7XG4gICAgY29uc3QgdG9wQWN0aXZhdGVkUm91dGUgPSBmaW5kVG9wQWN0aXZhdGVkUm91dGVOb2RlRm9yT3V0bGV0KGFjdGl2YXRlZFJvdXRlU25hcHNob3QpO1xuICAgIGNvbnN0IG91dGxldEtleSA9IHRoaXMubG9jYXRpb25TdHJhdGVneS5nZXRSb3V0ZUZ1bGxQYXRoKHRvcEFjdGl2YXRlZFJvdXRlKTtcbiAgICBsZXQgb3V0bGV0ID0gdGhpcy5sb2NhdGlvblN0cmF0ZWd5LmZpbmRPdXRsZXQob3V0bGV0S2V5LCB0b3BBY3RpdmF0ZWRSb3V0ZSk7XG5cbiAgICAvLyBOYW1lZCBsYXp5IGxvYWRlZCBvdXRsZXQuXG4gICAgaWYgKCFvdXRsZXQgJiYgdGhpcy5pc0VtcHR5T3V0bGV0KSB7XG4gICAgICBjb25zdCBwYXJlbnRPdXRsZXRLZXkgPSB0aGlzLmxvY2F0aW9uU3RyYXRlZ3kuZ2V0Um91dGVGdWxsUGF0aCh0b3BBY3RpdmF0ZWRSb3V0ZS5wYXJlbnQpO1xuICAgICAgb3V0bGV0ID0gdGhpcy5sb2NhdGlvblN0cmF0ZWd5LmZpbmRPdXRsZXQocGFyZW50T3V0bGV0S2V5LCB0b3BBY3RpdmF0ZWRSb3V0ZS5wYXJlbnQpO1xuXG4gICAgICBpZiAob3V0bGV0KSB7XG4gICAgICAgIG91dGxldC5vdXRsZXRLZXlzLnB1c2gob3V0bGV0S2V5KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gb3V0bGV0O1xuICB9XG59XG4iXX0=