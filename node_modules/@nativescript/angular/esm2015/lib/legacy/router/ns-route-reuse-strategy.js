import { Injectable } from '@angular/core';
import { NativeScriptDebug } from '../../trace';
import { NSLocationStrategy } from './ns-location-strategy';
import { destroyComponentRef, findTopActivatedRouteNodeForOutlet, pageRouterActivatedSymbol } from './page-router-outlet-utils';
const getSnapshotKey = function (snapshot) {
    return snapshot.pathFromRoot.join('->');
};
const ɵ0 = getSnapshotKey;
/**
 * Detached state cache
 */
class DetachedStateCache {
    constructor() {
        this.cache = new Array();
    }
    get length() {
        return this.cache.length;
    }
    push(cacheItem) {
        this.cache.push(cacheItem);
    }
    pop() {
        return this.cache.pop();
    }
    peek() {
        return this.cache[this.cache.length - 1];
    }
    clear() {
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routeReuseStrategyLog(`DetachedStateCache.clear() ${this.cache.length} items will be destroyed`);
        }
        while (this.cache.length > 0) {
            const state = this.cache.pop().state;
            if (!state.componentRef) {
                throw new Error('No componentRed found in DetachedRouteHandle');
            }
            destroyComponentRef(state.componentRef);
        }
    }
    clearModalCache() {
        let removedItemsCount = 0;
        const hasModalPages = this.cache.some((cacheItem) => {
            return cacheItem.isModal;
        });
        if (hasModalPages) {
            let modalCacheCleared = false;
            while (!modalCacheCleared) {
                let cacheItem = this.peek();
                const state = cacheItem.state;
                if (!state.componentRef) {
                    throw new Error('No componentRef found in DetachedRouteHandle');
                }
                destroyComponentRef(state.componentRef);
                if (cacheItem.isModal) {
                    modalCacheCleared = true;
                }
                this.pop();
                removedItemsCount++;
            }
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routeReuseStrategyLog(`DetachedStateCache.clearModalCache() ${removedItemsCount} items will be destroyed`);
        }
    }
}
/**
 * Detaches subtrees loaded inside PageRouterOutlet in forward navigation
 * and reattaches them on back.
 * Reuses routes as long as their route config is the same.
 */
export class NSRouteReuseStrategy {
    constructor(location) {
        this.location = location;
        this.cacheByOutlet = {};
    }
    shouldDetach(route) {
        route = findTopActivatedRouteNodeForOutlet(route);
        const outletKey = this.location.getRouteFullPath(route);
        const outlet = this.location.findOutlet(outletKey, route);
        const key = getSnapshotKey(route);
        const isPageActivated = route[pageRouterActivatedSymbol];
        const isBack = outlet ? outlet.isPageNavigationBack : false;
        let shouldDetach = outlet && !isBack && isPageActivated;
        if (outlet) {
            if (outlet.parent && !outlet.parent.shouldDetach) {
                shouldDetach = false;
            }
            outlet.shouldDetach = shouldDetach;
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routeReuseStrategyLog(`shouldDetach isBack: ${isBack} key: ${key} result: ${shouldDetach}`);
        }
        return shouldDetach;
    }
    shouldAttach(route) {
        var _a;
        route = findTopActivatedRouteNodeForOutlet(route);
        const outletKey = this.location.getRouteFullPath(route);
        const outlet = this.location.findOutlet(outletKey, route);
        const cache = this.cacheByOutlet[outletKey];
        if (!cache) {
            return false;
        }
        const key = getSnapshotKey(route);
        const isBack = outlet ? outlet.isPageNavigationBack : false;
        const shouldAttach = isBack && ((_a = cache.peek()) === null || _a === void 0 ? void 0 : _a.key) === key;
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routeReuseStrategyLog(`shouldAttach isBack: ${isBack} key: ${key} result: ${shouldAttach}`);
        }
        if (outlet) {
            outlet.shouldDetach = true;
        }
        return shouldAttach;
    }
    store(route, state) {
        route = findTopActivatedRouteNodeForOutlet(route);
        const key = getSnapshotKey(route);
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routeReuseStrategyLog(`store key: ${key}, state: ${state}`);
        }
        const outletKey = this.location.getRouteFullPath(route);
        // tslint:disable-next-line:max-line-length
        const cache = (this.cacheByOutlet[outletKey] = this.cacheByOutlet[outletKey] || new DetachedStateCache());
        if (state) {
            let isModal = false;
            if (this.location._modalNavigationDepth > 0) {
                isModal = true;
            }
            cache.push({ key, state, isModal });
        }
        else {
            const topItem = cache.peek();
            if (topItem.key === key) {
                cache.pop();
                if (!cache.length) {
                    delete this.cacheByOutlet[outletKey];
                }
            }
            else {
                throw new Error("Trying to pop from DetachedStateCache but keys don't match. " + `expected: ${topItem.key} actual: ${key}`);
            }
        }
    }
    retrieve(route) {
        route = findTopActivatedRouteNodeForOutlet(route);
        const outletKey = this.location.getRouteFullPath(route);
        const outlet = this.location.findOutlet(outletKey, route);
        const cache = this.cacheByOutlet[outletKey];
        if (!cache) {
            return null;
        }
        const key = getSnapshotKey(route);
        const isBack = outlet ? outlet.isPageNavigationBack : false;
        const cachedItem = cache.peek();
        let state = null;
        if (isBack && cachedItem && cachedItem.key === key) {
            state = cachedItem.state;
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routeReuseStrategyLog(`retrieved isBack: ${isBack} key: ${key} state: ${state}`);
        }
        return state;
    }
    shouldReuseRoute(future, curr) {
        const shouldReuse = future.routeConfig === curr.routeConfig;
        if (shouldReuse && curr && curr[pageRouterActivatedSymbol]) {
            // When reusing route - copy the pageRouterActivated to the new snapshot
            // It's needed in shouldDetach to determine if the route should be detached.
            future[pageRouterActivatedSymbol] = curr[pageRouterActivatedSymbol];
        }
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.routeReuseStrategyLog(`shouldReuseRoute result: ${shouldReuse}`);
        }
        return shouldReuse;
    }
    clearCache(outletKey) {
        const cache = this.cacheByOutlet[outletKey];
        if (cache) {
            cache.clear();
        }
    }
    clearModalCache(outletKey) {
        const cache = this.cacheByOutlet[outletKey];
        if (cache) {
            cache.clearModalCache();
        }
    }
}
NSRouteReuseStrategy.decorators = [
    { type: Injectable }
];
NSRouteReuseStrategy.ctorParameters = () => [
    { type: NSLocationStrategy }
];
export { ɵ0 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibnMtcm91dGUtcmV1c2Utc3RyYXRlZ3kuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvbGliL2xlZ2FjeS9yb3V0ZXIvbnMtcm91dGUtcmV1c2Utc3RyYXRlZ3kudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUczQyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDaEQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDNUQsT0FBTyxFQUFFLG1CQUFtQixFQUFFLGtDQUFrQyxFQUFFLHlCQUF5QixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFRaEksTUFBTSxjQUFjLEdBQUcsVUFBVSxRQUFnQztJQUMvRCxPQUFPLFFBQVEsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQzFDLENBQUMsQ0FBQzs7QUFFRjs7R0FFRztBQUNILE1BQU0sa0JBQWtCO0lBQXhCO1FBQ1UsVUFBSyxHQUFHLElBQUksS0FBSyxFQUFhLENBQUM7SUFnRXpDLENBQUM7SUE5REMsSUFBVyxNQUFNO1FBQ2YsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQztJQUMzQixDQUFDO0lBRU0sSUFBSSxDQUFDLFNBQW9CO1FBQzlCLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQzdCLENBQUM7SUFFTSxHQUFHO1FBQ1IsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQzFCLENBQUM7SUFFTSxJQUFJO1FBQ1QsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQzNDLENBQUM7SUFFTSxLQUFLO1FBQ1YsSUFBSSxpQkFBaUIsQ0FBQyxZQUFZLEVB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QUFXLEtBQUssSUFBSSxDQUFDLFdBQVcsQ0FBQztRQUU1RCxJQUFJLFdBQVcsSUFBSSxJQUFJLElBQUksSUFBSSxDQUFDLHlCQUF5QixDQUFDLEVBQUU7WUFDMUQsd0VBQXdFO1lBQ3hFLDRFQUE0RTtZQUM1RSxNQUFNLENBQUMseUJBQXlCLENBQUMsR0FBRyxJQUFJLENBQUMseUJBQXlCLENBQUMsQ0FBQztTQUNyRTtRQUVELElBQUksaUJBQWlCLENBQUMsWUFBWSxFQUFFLEVBQUU7WUFDcEMsaUJBQWlCLENBQUMscUJBQXFCLENBQUMsNEJBQTRCLFdBQVcsRUFBRSxDQUFDLENBQUM7U0FDcEY7UUFFRCxPQUFPLFdBQVcsQ0FBQztJQUNyQixDQUFDO0lBRUQsVUFBVSxDQUFDLFNBQWlCO1FBQzFCLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDLENBQUM7UUFFNUMsSUFBSSxLQUFLLEVBQUU7WUFDVCxLQUFLLENBQUMsS0FBSyxFQUFFLENBQUM7U0FDZjtJQUNILENBQUM7SUFFRCxlQUFlLENBQUMsU0FBaUI7UUFDL0IsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUU1QyxJQUFJLEtBQUssRUFBRTtZQUNULEtBQUssQ0FBQyxlQUFlLEVBQUUsQ0FBQztTQUN6QjtJQUNILENBQUM7OztZQWxKRixVQUFVOzs7WUF4RkYsa0JBQWtCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgUm91dGVSZXVzZVN0cmF0ZWd5LCBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90LCBEZXRhY2hlZFJvdXRlSGFuZGxlIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcblxuaW1wb3J0IHsgTmF0aXZlU2NyaXB0RGVidWcgfSBmcm9tICcuLi8uLi90cmFjZSc7XG5pbXBvcnQgeyBOU0xvY2F0aW9uU3RyYXRlZ3kgfSBmcm9tICcuL25zLWxvY2F0aW9uLXN0cmF0ZWd5JztcbmltcG9ydCB7IGRlc3Ryb3lDb21wb25lbnRSZWYsIGZpbmRUb3BBY3RpdmF0ZWRSb3V0ZU5vZGVGb3JPdXRsZXQsIHBhZ2VSb3V0ZXJBY3RpdmF0ZWRTeW1ib2wgfSBmcm9tICcuL3BhZ2Utcm91dGVyLW91dGxldC11dGlscyc7XG5cbmludGVyZmFjZSBDYWNoZUl0ZW0ge1xuICBrZXk6IHN0cmluZztcbiAgc3RhdGU6IERldGFjaGVkUm91dGVIYW5kbGU7XG4gIGlzTW9kYWw6IGJvb2xlYW47XG59XG5cbmNvbnN0IGdldFNuYXBzaG90S2V5ID0gZnVuY3Rpb24gKHNuYXBzaG90OiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90KTogc3RyaW5nIHtcbiAgcmV0dXJuIHNuYXBzaG90LnBhdGhGcm9tUm9vdC5qb2luKCctPicpO1xufTtcblxuLyoqXG4gKiBEZXRhY2hlZCBzdGF0ZSBjYWNoZVxuICovXG5jbGFzcyBEZXRhY2hlZFN0YXRlQ2FjaGUge1xuICBwcml2YXRlIGNhY2hlID0gbmV3IEFycmF5PENhY2hlSXRlbT4oKTtcblxuICBwdWJsaWMgZ2V0IGxlbmd0aCgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLmNhY2hlLmxlbmd0aDtcbiAgfVxuXG4gIHB1YmxpYyBwdXNoKGNhY2hlSXRlbTogQ2FjaGVJdGVtKSB7XG4gICAgdGhpcy5jYWNoZS5wdXNoKGNhY2hlSXRlbSk7XG4gIH1cblxuICBwdWJsaWMgcG9wKCk6IENhY2hlSXRlbSB7XG4gICAgcmV0dXJuIHRoaXMuY2FjaGUucG9wKCk7XG4gIH1cblxuICBwdWJsaWMgcGVlaygpOiBDYWNoZUl0ZW0ge1xuICAgIHJldHVybiB0aGlzLmNhY2hlW3RoaXMuY2FjaGUubGVuZ3RoIC0gMV07XG4gIH1cblxuICBwdWJsaWMgY2xlYXIoKSB7XG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZVJldXNlU3RyYXRlZ3lMb2coYERldGFjaGVkU3RhdGVDYWNoZS5jbGVhcigpICR7dGhpcy5jYWNoZS5sZW5ndGh9IGl0ZW1zIHdpbGwgYmUgZGVzdHJveWVkYCk7XG4gICAgfVxuXG4gICAgd2hpbGUgKHRoaXMuY2FjaGUubGVuZ3RoID4gMCkge1xuICAgICAgY29uc3Qgc3RhdGUgPSA8YW55PnRoaXMuY2FjaGUucG9wKCkuc3RhdGU7XG4gICAgICBpZiAoIXN0YXRlLmNvbXBvbmVudFJlZikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIGNvbXBvbmVudFJlZCBmb3VuZCBpbiBEZXRhY2hlZFJvdXRlSGFuZGxlJyk7XG4gICAgICB9XG5cbiAgICAgIGRlc3Ryb3lDb21wb25lbnRSZWYoc3RhdGUuY29tcG9uZW50UmVmKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgY2xlYXJNb2RhbENhY2hlKCkge1xuICAgIGxldCByZW1vdmVkSXRlbXNDb3VudCA9IDA7XG4gICAgY29uc3QgaGFzTW9kYWxQYWdlcyA9IHRoaXMuY2FjaGUuc29tZSgoY2FjaGVJdGVtKSA9PiB7XG4gICAgICByZXR1cm4gY2FjaGVJdGVtLmlzTW9kYWw7XG4gICAgfSk7XG5cbiAgICBpZiAoaGFzTW9kYWxQYWdlcykge1xuICAgICAgbGV0IG1vZGFsQ2FjaGVDbGVhcmVkID0gZmFsc2U7XG5cbiAgICAgIHdoaWxlICghbW9kYWxDYWNoZUNsZWFyZWQpIHtcbiAgICAgICAgbGV0IGNhY2hlSXRlbSA9IHRoaXMucGVlaygpO1xuICAgICAgICBjb25zdCBzdGF0ZSA9IDxhbnk+Y2FjaGVJdGVtLnN0YXRlO1xuXG4gICAgICAgIGlmICghc3RhdGUuY29tcG9uZW50UmVmKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyBjb21wb25lbnRSZWYgZm91bmQgaW4gRGV0YWNoZWRSb3V0ZUhhbmRsZScpO1xuICAgICAgICB9XG5cbiAgICAgICAgZGVzdHJveUNvbXBvbmVudFJlZihzdGF0ZS5jb21wb25lbnRSZWYpO1xuICAgICAgICBpZiAoY2FjaGVJdGVtLmlzTW9kYWwpIHtcbiAgICAgICAgICBtb2RhbENhY2hlQ2xlYXJlZCA9IHRydWU7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnBvcCgpO1xuICAgICAgICByZW1vdmVkSXRlbXNDb3VudCsrO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVSZXVzZVN0cmF0ZWd5TG9nKGBEZXRhY2hlZFN0YXRlQ2FjaGUuY2xlYXJNb2RhbENhY2hlKCkgJHtyZW1vdmVkSXRlbXNDb3VudH0gaXRlbXMgd2lsbCBiZSBkZXN0cm95ZWRgKTtcbiAgICB9XG4gIH1cbn1cblxuLyoqXG4gKiBEZXRhY2hlcyBzdWJ0cmVlcyBsb2FkZWQgaW5zaWRlIFBhZ2VSb3V0ZXJPdXRsZXQgaW4gZm9yd2FyZCBuYXZpZ2F0aW9uXG4gKiBhbmQgcmVhdHRhY2hlcyB0aGVtIG9uIGJhY2suXG4gKiBSZXVzZXMgcm91dGVzIGFzIGxvbmcgYXMgdGhlaXIgcm91dGUgY29uZmlnIGlzIHRoZSBzYW1lLlxuICovXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgTlNSb3V0ZVJldXNlU3RyYXRlZ3kgaW1wbGVtZW50cyBSb3V0ZVJldXNlU3RyYXRlZ3kge1xuICBwcml2YXRlIGNhY2hlQnlPdXRsZXQ6IHsgW2tleTogc3RyaW5nXTogRGV0YWNoZWRTdGF0ZUNhY2hlIH0gPSB7fTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGxvY2F0aW9uOiBOU0xvY2F0aW9uU3RyYXRlZ3kpIHt9XG5cbiAgc2hvdWxkRGV0YWNoKHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90KTogYm9vbGVhbiB7XG4gICAgcm91dGUgPSBmaW5kVG9wQWN0aXZhdGVkUm91dGVOb2RlRm9yT3V0bGV0KHJvdXRlKTtcblxuICAgIGNvbnN0IG91dGxldEtleSA9IHRoaXMubG9jYXRpb24uZ2V0Um91dGVGdWxsUGF0aChyb3V0ZSk7XG4gICAgY29uc3Qgb3V0bGV0ID0gdGhpcy5sb2NhdGlvbi5maW5kT3V0bGV0KG91dGxldEtleSwgcm91dGUpO1xuICAgIGNvbnN0IGtleSA9IGdldFNuYXBzaG90S2V5KHJvdXRlKTtcbiAgICBjb25zdCBpc1BhZ2VBY3RpdmF0ZWQgPSByb3V0ZVtwYWdlUm91dGVyQWN0aXZhdGVkU3ltYm9sXTtcbiAgICBjb25zdCBpc0JhY2sgPSBvdXRsZXQgPyBvdXRsZXQuaXNQYWdlTmF2aWdhdGlvbkJhY2sgOiBmYWxzZTtcbiAgICBsZXQgc2hvdWxkRGV0YWNoID0gb3V0bGV0ICYmICFpc0JhY2sgJiYgaXNQYWdlQWN0aXZhdGVkO1xuXG4gICAgaWYgKG91dGxldCkge1xuICAgICAgaWYgKG91dGxldC5wYXJlbnQgJiYgIW91dGxldC5wYXJlbnQuc2hvdWxkRGV0YWNoKSB7XG4gICAgICAgIHNob3VsZERldGFjaCA9IGZhbHNlO1xuICAgICAgfVxuXG4gICAgICBvdXRsZXQuc2hvdWxkRGV0YWNoID0gc2hvdWxkRGV0YWNoO1xuICAgIH1cblxuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVSZXVzZVN0cmF0ZWd5TG9nKGBzaG91bGREZXRhY2ggaXNCYWNrOiAke2lzQmFja30ga2V5OiAke2tleX0gcmVzdWx0OiAke3Nob3VsZERldGFjaH1gKTtcbiAgICB9XG5cbiAgICByZXR1cm4gc2hvdWxkRGV0YWNoO1xuICB9XG5cbiAgc2hvdWxkQXR0YWNoKHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZVNuYXBzaG90KTogYm9vbGVhbiB7XG4gICAgcm91dGUgPSBmaW5kVG9wQWN0aXZhdGVkUm91dGVOb2RlRm9yT3V0bGV0KHJvdXRlKTtcblxuICAgIGNvbnN0IG91dGxldEtleSA9IHRoaXMubG9jYXRpb24uZ2V0Um91dGVGdWxsUGF0aChyb3V0ZSk7XG4gICAgY29uc3Qgb3V0bGV0ID0gdGhpcy5sb2NhdGlvbi5maW5kT3V0bGV0KG91dGxldEtleSwgcm91dGUpO1xuICAgIGNvbnN0IGNhY2hlID0gdGhpcy5jYWNoZUJ5T3V0bGV0W291dGxldEtleV07XG4gICAgaWYgKCFjYWNoZSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIGNvbnN0IGtleSA9IGdldFNuYXBzaG90S2V5KHJvdXRlKTtcbiAgICBjb25zdCBpc0JhY2sgPSBvdXRsZXQgPyBvdXRsZXQuaXNQYWdlTmF2aWdhdGlvbkJhY2sgOiBmYWxzZTtcbiAgICBjb25zdCBzaG91bGRBdHRhY2ggPSBpc0JhY2sgJiYgY2FjaGUucGVlaygpPy5rZXkgPT09IGtleTtcblxuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVSZXVzZVN0cmF0ZWd5TG9nKGBzaG91bGRBdHRhY2ggaXNCYWNrOiAke2lzQmFja30ga2V5OiAke2tleX0gcmVzdWx0OiAke3Nob3VsZEF0dGFjaH1gKTtcbiAgICB9XG5cbiAgICBpZiAob3V0bGV0KSB7XG4gICAgICBvdXRsZXQuc2hvdWxkRGV0YWNoID0gdHJ1ZTtcbiAgICB9XG5cbiAgICByZXR1cm4gc2hvdWxkQXR0YWNoO1xuICB9XG5cbiAgc3RvcmUocm91dGU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QsIHN0YXRlOiBEZXRhY2hlZFJvdXRlSGFuZGxlKTogdm9pZCB7XG4gICAgcm91dGUgPSBmaW5kVG9wQWN0aXZhdGVkUm91dGVOb2RlRm9yT3V0bGV0KHJvdXRlKTtcblxuICAgIGNvbnN0IGtleSA9IGdldFNuYXBzaG90S2V5KHJvdXRlKTtcbiAgICBpZiAoTmF0aXZlU2NyaXB0RGVidWcuaXNMb2dFbmFibGVkKCkpIHtcbiAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLnJvdXRlUmV1c2VTdHJhdGVneUxvZyhgc3RvcmUga2V5OiAke2tleX0sIHN0YXRlOiAke3N0YXRlfWApO1xuICAgIH1cblxuICAgIGNvbnN0IG91dGxldEtleSA9IHRoaXMubG9jYXRpb24uZ2V0Um91dGVGdWxsUGF0aChyb3V0ZSk7XG5cbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWxpbmUtbGVuZ3RoXG4gICAgY29uc3QgY2FjaGUgPSAodGhpcy5jYWNoZUJ5T3V0bGV0W291dGxldEtleV0gPSB0aGlzLmNhY2hlQnlPdXRsZXRbb3V0bGV0S2V5XSB8fCBuZXcgRGV0YWNoZWRTdGF0ZUNhY2hlKCkpO1xuXG4gICAgaWYgKHN0YXRlKSB7XG4gICAgICBsZXQgaXNNb2RhbCA9IGZhbHNlO1xuICAgICAgaWYgKHRoaXMubG9jYXRpb24uX21vZGFsTmF2aWdhdGlvbkRlcHRoID4gMCkge1xuICAgICAgICBpc01vZGFsID0gdHJ1ZTtcbiAgICAgIH1cblxuICAgICAgY2FjaGUucHVzaCh7IGtleSwgc3RhdGUsIGlzTW9kYWwgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHRvcEl0ZW0gPSBjYWNoZS5wZWVrKCk7XG4gICAgICBpZiAodG9wSXRlbS5rZXkgPT09IGtleSkge1xuICAgICAgICBjYWNoZS5wb3AoKTtcblxuICAgICAgICBpZiAoIWNhY2hlLmxlbmd0aCkge1xuICAgICAgICAgIGRlbGV0ZSB0aGlzLmNhY2hlQnlPdXRsZXRbb3V0bGV0S2V5XTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiVHJ5aW5nIHRvIHBvcCBmcm9tIERldGFjaGVkU3RhdGVDYWNoZSBidXQga2V5cyBkb24ndCBtYXRjaC4gXCIgKyBgZXhwZWN0ZWQ6ICR7dG9wSXRlbS5rZXl9IGFjdHVhbDogJHtrZXl9YCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcmV0cmlldmUocm91dGU6IEFjdGl2YXRlZFJvdXRlU25hcHNob3QpOiBEZXRhY2hlZFJvdXRlSGFuZGxlIHwgbnVsbCB7XG4gICAgcm91dGUgPSBmaW5kVG9wQWN0aXZhdGVkUm91dGVOb2RlRm9yT3V0bGV0KHJvdXRlKTtcblxuICAgIGNvbnN0IG91dGxldEtleSA9IHRoaXMubG9jYXRpb24uZ2V0Um91dGVGdWxsUGF0aChyb3V0ZSk7XG4gICAgY29uc3Qgb3V0bGV0ID0gdGhpcy5sb2NhdGlvbi5maW5kT3V0bGV0KG91dGxldEtleSwgcm91dGUpO1xuICAgIGNvbnN0IGNhY2hlID0gdGhpcy5jYWNoZUJ5T3V0bGV0W291dGxldEtleV07XG4gICAgaWYgKCFjYWNoZSkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgY29uc3Qga2V5ID0gZ2V0U25hcHNob3RLZXkocm91dGUpO1xuICAgIGNvbnN0IGlzQmFjayA9IG91dGxldCA/IG91dGxldC5pc1BhZ2VOYXZpZ2F0aW9uQmFjayA6IGZhbHNlO1xuICAgIGNvbnN0IGNhY2hlZEl0ZW0gPSBjYWNoZS5wZWVrKCk7XG5cbiAgICBsZXQgc3RhdGUgPSBudWxsO1xuICAgIGlmIChpc0JhY2sgJiYgY2FjaGVkSXRlbSAmJiBjYWNoZWRJdGVtLmtleSA9PT0ga2V5KSB7XG4gICAgICBzdGF0ZSA9IGNhY2hlZEl0ZW0uc3RhdGU7XG4gICAgfVxuXG4gICAgaWYgKE5hdGl2ZVNjcmlwdERlYnVnLmlzTG9nRW5hYmxlZCgpKSB7XG4gICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5yb3V0ZVJldXNlU3RyYXRlZ3lMb2coYHJldHJpZXZlZCBpc0JhY2s6ICR7aXNCYWNrfSBrZXk6ICR7a2V5fSBzdGF0ZTogJHtzdGF0ZX1gKTtcbiAgICB9XG5cbiAgICByZXR1cm4gc3RhdGU7XG4gIH1cblxuICBzaG91bGRSZXVzZVJvdXRlKGZ1dHVyZTogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCwgY3VycjogQWN0aXZhdGVkUm91dGVTbmFwc2hvdCk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IHNob3VsZFJldXNlID0gZnV0dXJlLnJvdXRlQ29uZmlnID09PSBjdXJyLnJvdXRlQ29uZmlnO1xuXG4gICAgaWYgKHNob3VsZFJldXNlICYmIGN1cnIgJiYgY3VycltwYWdlUm91dGVyQWN0aXZhdGVkU3ltYm9sXSkge1xuICAgICAgLy8gV2hlbiByZXVzaW5nIHJvdXRlIC0gY29weSB0aGUgcGFnZVJvdXRlckFjdGl2YXRlZCB0byB0aGUgbmV3IHNuYXBzaG90XG4gICAgICAvLyBJdCdzIG5lZWRlZCBpbiBzaG91bGREZXRhY2ggdG8gZGV0ZXJtaW5lIGlmIHRoZSByb3V0ZSBzaG91bGQgYmUgZGV0YWNoZWQuXG4gICAgICBmdXR1cmVbcGFnZVJvdXRlckFjdGl2YXRlZFN5bWJvbF0gPSBjdXJyW3BhZ2VSb3V0ZXJBY3RpdmF0ZWRTeW1ib2xdO1xuICAgIH1cblxuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcucm91dGVSZXVzZVN0cmF0ZWd5TG9nKGBzaG91bGRSZXVzZVJvdXRlIHJlc3VsdDogJHtzaG91bGRSZXVzZX1gKTtcbiAgICB9XG5cbiAgICByZXR1cm4gc2hvdWxkUmV1c2U7XG4gIH1cblxuICBjbGVhckNhY2hlKG91dGxldEtleTogc3RyaW5nKSB7XG4gICAgY29uc3QgY2FjaGUgPSB0aGlzLmNhY2hlQnlPdXRsZXRbb3V0bGV0S2V5XTtcblxuICAgIGlmIChjYWNoZSkge1xuICAgICAgY2FjaGUuY2xlYXIoKTtcbiAgICB9XG4gIH1cblxuICBjbGVhck1vZGFsQ2FjaGUob3V0bGV0S2V5OiBzdHJpbmcpIHtcbiAgICBjb25zdCBjYWNoZSA9IHRoaXMuY2FjaGVCeU91dGxldFtvdXRsZXRLZXldO1xuXG4gICAgaWYgKGNhY2hlKSB7XG4gICAgICBjYWNoZS5jbGVhck1vZGFsQ2FjaGUoKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==