import { ApplicationRef, ComponentFactoryResolver, Injectable, Injector, NgZone, ɵmarkDirty } from '@angular/core';
import { Application, ContentView, Frame } from '@nativescript/core';
import { AppHostAsyncView, AppHostView } from '../../app-host-view';
import { ComponentPortal } from '../../cdk/portal/common';
import { NativeScriptDomPortalOutlet } from '../../cdk/portal/nsdom-portal-outlet';
import { once } from '../../utils/general';
import { NgViewRef } from '../../view-refs';
import { NSLocationStrategy } from '../router/ns-location-strategy';
export class ModalDialogParams {
    constructor(context = {}, closeCallback) {
        this.context = context;
        this.closeCallback = closeCallback;
    }
}
export class ModalDialogService {
    constructor(location, zone, appRef, defaultInjector) {
        this.location = location;
        this.zone = zone;
        this.appRef = appRef;
        this.defaultInjector = defaultInjector;
    }
    showModal(type, options = {}) {
        // if (!options.viewContainerRef) {
        //   throw new Error('No viewContainerRef: ' + 'Make sure you pass viewContainerRef in ModalDialogOptions.');
        // }
        var _a, _b, _c, _d;
        let parentView = ((_a = options.viewContainerRef) === null || _a === void 0 ? void 0 : _a.element.nativeElement) || Application.getRootView();
        if (options.target) {
            parentView = options.target;
        }
        if ((parentView instanceof AppHostView || parentView instanceof AppHostAsyncView) && parentView.ngAppRoot) {
            parentView = parentView.ngAppRoot;
        }
        // _ngDialogRoot is the first child of the previously detached proxy.
        // It should have 'viewController' (iOS) or '_dialogFragment' (Android) available for
        // presenting future modal views.
        if (parentView._ngDialogRoot) {
            parentView = parentView._ngDialogRoot;
        }
        // resolve from particular module (moduleRef)
        // or from same module as parentView (viewContainerRef)
        const componentInjector = ((_b = options.moduleRef) === null || _b === void 0 ? void 0 : _b.injector) || ((_c = options.viewContainerRef) === null || _c === void 0 ? void 0 : _c.injector) || this.defaultInjector;
        const resolver = componentInjector.get(ComponentFactoryResolver);
        let frame = parentView;
        if (!(parentView instanceof Frame)) {
            frame = (parentView.page && parentView.page.frame) || Frame.topmost();
        }
        (_d = this.location) === null || _d === void 0 ? void 0 : _d._beginModalNavigation(frame);
        return new Promise((resolve, reject) => {
            setTimeout(() => {
                try {
                    this._showDialog(Object.assign(Object.assign({}, options), { containerRef: options.viewContainerRef, injector: componentInjector, context: options.context, doneCallback: resolve, parentView,
                        resolver,
                        type }));
                }
                catch (err) {
                    reject(err);
                }
            }, 10);
        });
    }
    _showDialog(options) {
        let componentViewRef;
        let detachedLoaderRef;
        let portalOutlet;
        const closeCallback = once((...args) => {
            options.doneCallback.apply(undefined, args);
            if (componentViewRef) {
                componentViewRef.firstNativeLikeView.closeModal();
                this.location._closeModalNavigation();
                if (detachedLoaderRef || portalOutlet) {
                    this.zone.run(() => {
                        portalOutlet === null || portalOutlet === void 0 ? void 0 : portalOutlet.dispose();
                        detachedLoaderRef === null || detachedLoaderRef === void 0 ? void 0 : detachedLoaderRef.instance.detectChanges();
                        detachedLoaderRef === null || detachedLoaderRef === void 0 ? void 0 : detachedLoaderRef.destroy();
                    });
                }
            }
        });
        const modalParams = new ModalDialogParams(options.context, closeCallback);
        const childInjector = Injector.create({
            providers: [{ provide: ModalDialogParams, useValue: modalParams }],
            parent: options.injector,
        });
        this.zone.run(() => {
            // if we ever support templates in the old API
            // if(options.templateRef) {
            //     const detachedFactory = options.resolver.resolveComponentFactory(DetachedLoader);
            //     if(options.attachToContainerRef) {
            //         detachedLoaderRef = options.attachToContainerRef.createComponent(detachedFactory, 0, childInjector, null);
            //     } else {
            //         detachedLoaderRef = detachedFactory.create(childInjector); // this DetachedLoader is **completely** detached
            //         this.appRef.attachView(detachedLoaderRef.hostView); // we attach it to the applicationRef, so it becomes a "root" view in angular's hierarchy
            //     }
            //     detachedLoaderRef.changeDetectorRef.detectChanges(); // force a change detection
            //     detachedLoaderRef.instance.createTemplatePortal(options.templateRef);
            // }
            const targetView = new ContentView();
            const portal = new ComponentPortal(options.type);
            portalOutlet = new NativeScriptDomPortalOutlet(targetView, options.resolver, this.appRef, childInjector);
            const componentRef = portalOutlet.attach(portal);
            ɵmarkDirty(componentRef.instance);
            componentViewRef = new NgViewRef(componentRef);
            if (componentViewRef !== componentRef.location.nativeElement) {
                componentRef.location.nativeElement._ngDialogRoot = componentViewRef.firstNativeLikeView;
            }
            // if we don't detach the view from its parent, ios gets mad
            componentViewRef.detachNativeLikeView();
            options.parentView.showModal(componentViewRef.firstNativeLikeView, Object.assign(Object.assign({}, options), { closeCallback }));
        });
    }
}
ModalDialogService.decorators = [
    { type: Injectable }
];
ModalDialogService.ctorParameters = () => [
    { type: NSLocationStrategy },
    { type: NgZone },
    { type: ApplicationRef },
    { type: Injector }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlhbG9ncy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9saWIvbGVnYWN5L2RpcmVjdGl2ZXMvZGlhbG9ncy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsY0FBYyxFQUFFLHdCQUF3QixFQUFnQixVQUFVLEVBQUUsUUFBUSxFQUFlLE1BQU0sRUFBMEIsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3RLLE9BQU8sRUFBRSxXQUFXLEVBQUUsV0FBVyxFQUFFLEtBQUssRUFBb0MsTUFBTSxvQkFBb0IsQ0FBQztBQUN2RyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsV0FBVyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFcEUsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQzFELE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxNQUFNLHNDQUFzQyxDQUFDO0FBQ25GLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUMzQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDNUMsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUEyQnBFLE1BQU0sT0FBTyxpQkFBaUI7SUFDNUIsWUFBbUIsVUFBZSxFQUFFLEVBQVMsYUFBK0I7UUFBekQsWUFBTyxHQUFQLE9BQU8sQ0FBVTtRQUFTLGtCQUFhLEdBQWIsYUFBYSxDQUFrQjtJQUFHLENBQUM7Q0FDakY7QUFHRCxNQUFNLE9BQU8sa0JBQWtCO0lBQzdCLFlBQW9CLFFBQTRCLEVBQVUsSUFBWSxFQUFVLE1BQXNCLEVBQVUsZUFBeUI7UUFBckgsYUFBUSxHQUFSLFFBQVEsQ0FBb0I7UUFBVSxTQUFJLEdBQUosSUFBSSxDQUFRO1FBQVUsV0FBTSxHQUFOLE1BQU0sQ0FBZ0I7UUFBVSxvQkFBZSxHQUFmLGVBQWUsQ0FBVTtJQUFHLENBQUM7SUFFdEksU0FBUyxDQUFDLElB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QUFTLENBQUMsWUFBWSxDQUFDLENBQUM7WUFDL0MsSUFBSSxnQkFBZ0IsS0FBSyxZQUFZLENBQUMsUUFBUSxDQUFDLGFBQWEsRUFBRTtnQkFDNUQsWUFBWSxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsYUFBYSxHQUFHLGdCQUFnQixDQUFDLG1CQUFtQixDQUFDO2FBQzFGO1lBQ0QsNERBQTREO1lBQzVELGdCQUFnQixDQUFDLG9CQUFvQixFQUFFLENBQUM7WUFDeEMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsZ0JBQWdCLENBQUMsbUJBQW1CLGtDQUFPLE9BQU8sS0FBRSxhQUFhLElBQUcsQ0FBQztRQUNwRyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7OztZQTdHRixVQUFVOzs7WUEvQkYsa0JBQWtCO1lBUnlFLE1BQU07WUFBakcsY0FBYztZQUFzRCxRQUFRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXBwbGljYXRpb25SZWYsIENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciwgQ29tcG9uZW50UmVmLCBJbmplY3RhYmxlLCBJbmplY3RvciwgTmdNb2R1bGVSZWYsIE5nWm9uZSwgVHlwZSwgVmlld0NvbnRhaW5lclJlZiwgybVtYXJrRGlydHkgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFwcGxpY2F0aW9uLCBDb250ZW50VmlldywgRnJhbWUsIFNob3dNb2RhbE9wdGlvbnMsIFZpZXcsIFZpZXdCYXNlIH0gZnJvbSAnQG5hdGl2ZXNjcmlwdC9jb3JlJztcbmltcG9ydCB7IEFwcEhvc3RBc3luY1ZpZXcsIEFwcEhvc3RWaWV3IH0gZnJvbSAnLi4vLi4vYXBwLWhvc3Qtdmlldyc7XG5pbXBvcnQgeyBEZXRhY2hlZExvYWRlciB9IGZyb20gJy4uLy4uL2Nkay9kZXRhY2hlZC1sb2FkZXInO1xuaW1wb3J0IHsgQ29tcG9uZW50UG9ydGFsIH0gZnJvbSAnLi4vLi4vY2RrL3BvcnRhbC9jb21tb24nO1xuaW1wb3J0IHsgTmF0aXZlU2NyaXB0RG9tUG9ydGFsT3V0bGV0IH0gZnJvbSAnLi4vLi4vY2RrL3BvcnRhbC9uc2RvbS1wb3J0YWwtb3V0bGV0JztcbmltcG9ydCB7IG9uY2UgfSBmcm9tICcuLi8uLi91dGlscy9nZW5lcmFsJztcbmltcG9ydCB7IE5nVmlld1JlZiB9IGZyb20gJy4uLy4uL3ZpZXctcmVmcyc7XG5pbXBvcnQgeyBOU0xvY2F0aW9uU3RyYXRlZ3kgfSBmcm9tICcuLi9yb3V0ZXIvbnMtbG9jYXRpb24tc3RyYXRlZ3knO1xuXG5leHBvcnQgdHlwZSBCYXNlU2hvd01vZGFsT3B0aW9ucyA9IFBpY2s8U2hvd01vZGFsT3B0aW9ucywgRXhjbHVkZTxrZXlvZiBTaG93TW9kYWxPcHRpb25zLCAnY2xvc2VDYWxsYmFjaycgfCAnY29udGV4dCc+PjtcblxuZXhwb3J0IGludGVyZmFjZSBNb2RhbERpYWxvZ09wdGlvbnMgZXh0ZW5kcyBCYXNlU2hvd01vZGFsT3B0aW9ucyB7XG4gIGNvbnRleHQ/OiBhbnk7XG4gIHZpZXdDb250YWluZXJSZWY/OiBWaWV3Q29udGFpbmVyUmVmO1xuICBtb2R1bGVSZWY/OiBOZ01vZHVsZVJlZjxhbnk+O1xuICB0YXJnZXQ/OiBWaWV3O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFNob3dEaWFsb2dPcHRpb25zIGV4dGVuZHMgQmFzZVNob3dNb2RhbE9wdGlvbnMge1xuICBjb250YWluZXJSZWY/OiBWaWV3Q29udGFpbmVyUmVmO1xuICAvKipcbiAgICogd2hpY2ggY29udGFpbmVyIHRvIGF0dGFjaCB0aGUgY2hhbmdlIGRldGVjdGlvblxuICAgKiBpZiBub3Qgc3BlY2lmaWVkLCBhdHRhY2hlcyB0byB0aGUgQXBwbGljYXRpb25SZWYgKHJlY29tbWVuZGVkKVxuICAgKi9cbiAgYXR0YWNoVG9Db250YWluZXJSZWY/OiBWaWV3Q29udGFpbmVyUmVmO1xuICBpbmplY3RvcjogSW5qZWN0b3I7XG4gIGNvbnRleHQ6IGFueTtcbiAgZG9uZUNhbGxiYWNrO1xuICBwYWdlRmFjdG9yeT86IGFueTtcbiAgcGFyZW50VmlldzogVmlld0Jhc2U7XG4gIHJlc29sdmVyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXI7XG4gIHR5cGU6IFR5cGU8YW55Pjtcbn1cblxuZXhwb3J0IGNsYXNzIE1vZGFsRGlhbG9nUGFyYW1zIHtcbiAgY29uc3RydWN0b3IocHVibGljIGNvbnRleHQ6IGFueSA9IHt9LCBwdWJsaWMgY2xvc2VDYWxsYmFjazogKC4uLmFyZ3MpID0+IGFueSkge31cbn1cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIE1vZGFsRGlhbG9nU2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgbG9jYXRpb246IE5TTG9jYXRpb25TdHJhdGVneSwgcHJpdmF0ZSB6b25lOiBOZ1pvbmUsIHByaXZhdGUgYXBwUmVmOiBBcHBsaWNhdGlvblJlZiwgcHJpdmF0ZSBkZWZhdWx0SW5qZWN0b3I6IEluamVjdG9yKSB7fVxuXG4gIHB1YmxpYyBzaG93TW9kYWwodHlwZTogVHlwZTxhbnk+LCBvcHRpb25zOiBNb2RhbERpYWxvZ09wdGlvbnMgPSB7fSk6IFByb21pc2U8YW55PiB7XG4gICAgLy8gaWYgKCFvcHRpb25zLnZpZXdDb250YWluZXJSZWYpIHtcbiAgICAvLyAgIHRocm93IG5ldyBFcnJvcignTm8gdmlld0NvbnRhaW5lclJlZjogJyArICdNYWtlIHN1cmUgeW91IHBhc3Mgdmlld0NvbnRhaW5lclJlZiBpbiBNb2RhbERpYWxvZ09wdGlvbnMuJyk7XG4gICAgLy8gfVxuXG4gICAgbGV0IHBhcmVudFZpZXcgPSBvcHRpb25zLnZpZXdDb250YWluZXJSZWY/LmVsZW1lbnQubmF0aXZlRWxlbWVudCB8fCBBcHBsaWNhdGlvbi5nZXRSb290VmlldygpO1xuICAgIGlmIChvcHRpb25zLnRhcmdldCkge1xuICAgICAgcGFyZW50VmlldyA9IG9wdGlvbnMudGFyZ2V0O1xuICAgIH1cblxuICAgIGlmICgocGFyZW50VmlldyBpbnN0YW5jZW9mIEFwcEhvc3RWaWV3IHx8IHBhcmVudFZpZXcgaW5zdGFuY2VvZiBBcHBIb3N0QXN5bmNWaWV3KSAmJiBwYXJlbnRWaWV3Lm5nQXBwUm9vdCkge1xuICAgICAgcGFyZW50VmlldyA9IHBhcmVudFZpZXcubmdBcHBSb290O1xuICAgIH1cblxuICAgIC8vIF9uZ0RpYWxvZ1Jvb3QgaXMgdGhlIGZpcnN0IGNoaWxkIG9mIHRoZSBwcmV2aW91c2x5IGRldGFjaGVkIHByb3h5LlxuICAgIC8vIEl0IHNob3VsZCBoYXZlICd2aWV3Q29udHJvbGxlcicgKGlPUykgb3IgJ19kaWFsb2dGcmFnbWVudCcgKEFuZHJvaWQpIGF2YWlsYWJsZSBmb3JcbiAgICAvLyBwcmVzZW50aW5nIGZ1dHVyZSBtb2RhbCB2aWV3cy5cbiAgICBpZiAocGFyZW50Vmlldy5fbmdEaWFsb2dSb290KSB7XG4gICAgICBwYXJlbnRWaWV3ID0gcGFyZW50Vmlldy5fbmdEaWFsb2dSb290O1xuICAgIH1cblxuICAgIC8vIHJlc29sdmUgZnJvbSBwYXJ0aWN1bGFyIG1vZHVsZSAobW9kdWxlUmVmKVxuICAgIC8vIG9yIGZyb20gc2FtZSBtb2R1bGUgYXMgcGFyZW50VmlldyAodmlld0NvbnRhaW5lclJlZilcbiAgICBjb25zdCBjb21wb25lbnRJbmplY3RvciA9IG9wdGlvbnMubW9kdWxlUmVmPy5pbmplY3RvciB8fCBvcHRpb25zLnZpZXdDb250YWluZXJSZWY/LmluamVjdG9yIHx8IHRoaXMuZGVmYXVsdEluamVjdG9yO1xuICAgIGNvbnN0IHJlc29sdmVyID0gY29tcG9uZW50SW5qZWN0b3IuZ2V0KENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcik7XG5cbiAgICBsZXQgZnJhbWUgPSBwYXJlbnRWaWV3O1xuICAgIGlmICghKHBhcmVudFZpZXcgaW5zdGFuY2VvZiBGcmFtZSkpIHtcbiAgICAgIGZyYW1lID0gKHBhcmVudFZpZXcucGFnZSAmJiBwYXJlbnRWaWV3LnBhZ2UuZnJhbWUpIHx8IEZyYW1lLnRvcG1vc3QoKTtcbiAgICB9XG5cbiAgICB0aGlzLmxvY2F0aW9uPy5fYmVnaW5Nb2RhbE5hdmlnYXRpb24oZnJhbWUpO1xuXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIHRoaXMuX3Nob3dEaWFsb2coe1xuICAgICAgICAgICAgLi4ub3B0aW9ucyxcbiAgICAgICAgICAgIGNvbnRhaW5lclJlZjogb3B0aW9ucy52aWV3Q29udGFpbmVyUmVmLFxuICAgICAgICAgICAgaW5qZWN0b3I6IGNvbXBvbmVudEluamVjdG9yLFxuICAgICAgICAgICAgY29udGV4dDogb3B0aW9ucy5jb250ZXh0LFxuICAgICAgICAgICAgZG9uZUNhbGxiYWNrOiByZXNvbHZlLFxuICAgICAgICAgICAgcGFyZW50VmlldyxcbiAgICAgICAgICAgIHJlc29sdmVyLFxuICAgICAgICAgICAgdHlwZSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgIH1cbiAgICAgIH0sIDEwKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgX3Nob3dEaWFsb2cob3B0aW9uczogU2hvd0RpYWxvZ09wdGlvbnMpOiB2b2lkIHtcbiAgICBsZXQgY29tcG9uZW50Vmlld1JlZjogTmdWaWV3UmVmPHVua25vd24+O1xuICAgIGxldCBkZXRhY2hlZExvYWRlclJlZjogQ29tcG9uZW50UmVmPERldGFjaGVkTG9hZGVyPjtcbiAgICBsZXQgcG9ydGFsT3V0bGV0OiBOYXRpdmVTY3JpcHREb21Qb3J0YWxPdXRsZXQ7XG5cbiAgICBjb25zdCBjbG9zZUNhbGxiYWNrID0gb25jZSgoLi4uYXJncykgPT4ge1xuICAgICAgb3B0aW9ucy5kb25lQ2FsbGJhY2suYXBwbHkodW5kZWZpbmVkLCBhcmdzKTtcbiAgICAgIGlmIChjb21wb25lbnRWaWV3UmVmKSB7XG4gICAgICAgIGNvbXBvbmVudFZpZXdSZWYuZmlyc3ROYXRpdmVMaWtlVmlldy5jbG9zZU1vZGFsKCk7XG4gICAgICAgIHRoaXMubG9jYXRpb24uX2Nsb3NlTW9kYWxOYXZpZ2F0aW9uKCk7XG4gICAgICAgIGlmIChkZXRhY2hlZExvYWRlclJlZiB8fCBwb3J0YWxPdXRsZXQpIHtcbiAgICAgICAgICB0aGlzLnpvbmUucnVuKCgpID0+IHtcbiAgICAgICAgICAgIHBvcnRhbE91dGxldD8uZGlzcG9zZSgpO1xuICAgICAgICAgICAgZGV0YWNoZWRMb2FkZXJSZWY/Lmluc3RhbmNlLmRldGVjdENoYW5nZXMoKTtcbiAgICAgICAgICAgIGRldGFjaGVkTG9hZGVyUmVmPy5kZXN0cm95KCk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGNvbnN0IG1vZGFsUGFyYW1zID0gbmV3IE1vZGFsRGlhbG9nUGFyYW1zKG9wdGlvbnMuY29udGV4dCwgY2xvc2VDYWxsYmFjayk7XG5cbiAgICBjb25zdCBjaGlsZEluamVjdG9yID0gSW5qZWN0b3IuY3JlYXRlKHtcbiAgICAgIHByb3ZpZGVyczogW3sgcHJvdmlkZTogTW9kYWxEaWFsb2dQYXJhbXMsIHVzZVZhbHVlOiBtb2RhbFBhcmFtcyB9XSxcbiAgICAgIHBhcmVudDogb3B0aW9ucy5pbmplY3RvcixcbiAgICB9KTtcbiAgICB0aGlzLnpvbmUucnVuKCgpID0+IHtcbiAgICAgIC8vIGlmIHdlIGV2ZXIgc3VwcG9ydCB0ZW1wbGF0ZXMgaW4gdGhlIG9sZCBBUElcbiAgICAgIC8vIGlmKG9wdGlvbnMudGVtcGxhdGVSZWYpIHtcbiAgICAgIC8vICAgICBjb25zdCBkZXRhY2hlZEZhY3RvcnkgPSBvcHRpb25zLnJlc29sdmVyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KERldGFjaGVkTG9hZGVyKTtcbiAgICAgIC8vICAgICBpZihvcHRpb25zLmF0dGFjaFRvQ29udGFpbmVyUmVmKSB7XG4gICAgICAvLyAgICAgICAgIGRldGFjaGVkTG9hZGVyUmVmID0gb3B0aW9ucy5hdHRhY2hUb0NvbnRhaW5lclJlZi5jcmVhdGVDb21wb25lbnQoZGV0YWNoZWRGYWN0b3J5LCAwLCBjaGlsZEluamVjdG9yLCBudWxsKTtcbiAgICAgIC8vICAgICB9IGVsc2Uge1xuICAgICAgLy8gICAgICAgICBkZXRhY2hlZExvYWRlclJlZiA9IGRldGFjaGVkRmFjdG9yeS5jcmVhdGUoY2hpbGRJbmplY3Rvcik7IC8vIHRoaXMgRGV0YWNoZWRMb2FkZXIgaXMgKipjb21wbGV0ZWx5KiogZGV0YWNoZWRcbiAgICAgIC8vICAgICAgICAgdGhpcy5hcHBSZWYuYXR0YWNoVmlldyhkZXRhY2hlZExvYWRlclJlZi5ob3N0Vmlldyk7IC8vIHdlIGF0dGFjaCBpdCB0byB0aGUgYXBwbGljYXRpb25SZWYsIHNvIGl0IGJlY29tZXMgYSBcInJvb3RcIiB2aWV3IGluIGFuZ3VsYXIncyBoaWVyYXJjaHlcbiAgICAgIC8vICAgICB9XG4gICAgICAvLyAgICAgZGV0YWNoZWRMb2FkZXJSZWYuY2hhbmdlRGV0ZWN0b3JSZWYuZGV0ZWN0Q2hhbmdlcygpOyAvLyBmb3JjZSBhIGNoYW5nZSBkZXRlY3Rpb25cbiAgICAgIC8vICAgICBkZXRhY2hlZExvYWRlclJlZi5pbnN0YW5jZS5jcmVhdGVUZW1wbGF0ZVBvcnRhbChvcHRpb25zLnRlbXBsYXRlUmVmKTtcbiAgICAgIC8vIH1cbiAgICAgIGNvbnN0IHRhcmdldFZpZXcgPSBuZXcgQ29udGVudFZpZXcoKTtcbiAgICAgIGNvbnN0IHBvcnRhbCA9IG5ldyBDb21wb25lbnRQb3J0YWwob3B0aW9ucy50eXBlKTtcbiAgICAgIHBvcnRhbE91dGxldCA9IG5ldyBOYXRpdmVTY3JpcHREb21Qb3J0YWxPdXRsZXQodGFyZ2V0Vmlldywgb3B0aW9ucy5yZXNvbHZlciwgdGhpcy5hcHBSZWYsIGNoaWxkSW5qZWN0b3IpO1xuICAgICAgY29uc3QgY29tcG9uZW50UmVmID0gcG9ydGFsT3V0bGV0LmF0dGFjaChwb3J0YWwpO1xuICAgICAgybVtYXJrRGlydHkoY29tcG9uZW50UmVmLmluc3RhbmNlKTtcbiAgICAgIGNvbXBvbmVudFZpZXdSZWYgPSBuZXcgTmdWaWV3UmVmKGNvbXBvbmVudFJlZik7XG4gICAgICBpZiAoY29tcG9uZW50Vmlld1JlZiAhPT0gY29tcG9uZW50UmVmLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnQpIHtcbiAgICAgICAgY29tcG9uZW50UmVmLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnQuX25nRGlhbG9nUm9vdCA9IGNvbXBvbmVudFZpZXdSZWYuZmlyc3ROYXRpdmVMaWtlVmlldztcbiAgICAgIH1cbiAgICAgIC8vIGlmIHdlIGRvbid0IGRldGFjaCB0aGUgdmlldyBmcm9tIGl0cyBwYXJlbnQsIGlvcyBnZXRzIG1hZFxuICAgICAgY29tcG9uZW50Vmlld1JlZi5kZXRhY2hOYXRpdmVMaWtlVmlldygpO1xuICAgICAgb3B0aW9ucy5wYXJlbnRWaWV3LnNob3dNb2RhbChjb21wb25lbnRWaWV3UmVmLmZpcnN0TmF0aXZlTGlrZVZpZXcsIHsgLi4ub3B0aW9ucywgY2xvc2VDYWxsYmFjayB9KTtcbiAgICB9KTtcbiAgfVxufVxuIl19