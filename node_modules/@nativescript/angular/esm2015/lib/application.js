import { NgModuleRef, NgZone, PlatformRef } from '@angular/core';
import { filter, map, take } from 'rxjs/operators';
import { Application, Color, profile, removeTaggedAdditionalCSS, TextView, View, Utils } from '@nativescript/core';
import { AppHostView } from './app-host-view';
import { NativeScriptLoadingService } from './loading.service';
import { APP_ROOT_VIEW, DISABLE_ROOT_VIEW_HANDLING, NATIVESCRIPT_ROOT_MODULE_ID } from './tokens';
import { Subject } from 'rxjs';
import { NativeScriptDebug } from './trace';
export function disableRootViewHanding(view) {
    view.__disable_root_view_handling = true;
}
export const preAngularDisposal$ = new Subject();
export const postAngularBootstrap$ = new Subject();
const ɵ0 = (v) => v.moduleType === 'main' && v.reason === 'hotreload', ɵ1 = (v) => v.reference;
/**
 * @deprecated
 */
export const onBeforeLivesync = preAngularDisposal$.pipe(filter(ɵ0), map(ɵ1));
const ɵ2 = (v) => v.moduleType === 'main', ɵ3 = (v) => ({ moduleRef: v.reference });
/**
 * @deprecated
 */
export const onAfterLivesync = postAngularBootstrap$.pipe(filter(ɵ2), map(ɵ3));
if (module['hot']) {
    module['hot'].decline();
    global.__onLiveSyncCore = () => {
        var _a;
        (_a = Application.getRootView()) === null || _a === void 0 ? void 0 : _a._onCssStateChange();
        // all other changes are applied by runNativeScriptAngularApp
    };
}
function emitModuleBootstrapEvent(ref, name, reason) {
    postAngularBootstrap$.next({
        moduleType: name,
        reference: ref,
        reason,
    });
}
function destroyRef(ref, name, reason) {
    if (ref) {
        if (ref instanceof PlatformRef) {
            preAngularDisposal$.next({
                moduleType: 'platform',
                reference: ref,
                reason: name,
            });
        }
        if (ref instanceof NgModuleRef) {
            preAngularDisposal$.next({
                moduleType: name,
                reference: ref,
                reason,
            });
        }
        ref.destroy();
    }
}
export function runNativeScriptAngularApp(options) {
    let mainModuleRef = null;
    let loadingModuleRef;
    let platformRef = null;
    let bootstrapId = -1;
    const updatePlatformRef = (moduleRef, reason) => {
        const newPlatformRef = moduleRef.injector.get(PlatformRef);
        if (newPlatformRef === platformRef) {
            return;
        }
        destroyRef(platformRef, reason);
        platformRef = newPlatformRef;
        platformRef.onDestroy(() => (platformRef = platformRef === newPlatformRef ? null : platformRef));
    };
    const setRootView = (ref) => {
        var _a;
        if (bootstrapId === -1) {
            // treat edge cases
            return;
        }
        if (ref instanceof NgModuleRef) {
            if (ref.injector.get(DISABLE_ROOT_VIEW_HANDLING, false)) {
                return;
            }
        }
        else {
            if (ref['__disable_root_view_handling']) {
                return;
            }
        }
        (_a = Application.getRootView()) === null || _a === void 0 ? void 0 : _a._closeAllModalViewsInternal(); // cleanup old rootview
        // TODO: check for leaks when root view isn't properly destroyed
        if (ref instanceof View) {
            if (NativeScriptDebug.isLogEnabled()) {
                NativeScriptDebug.bootstrapLog(`Setting RootView to ${ref}`);
            }
            Application.resetRootView({
                create: () => ref,
            });
            return;
        }
        const view = ref.injector.get(APP_ROOT_VIEW);
        const newRoot = view instanceof AppHostView ? view.content : view;
        if (NativeScriptDebug.isLogEnabled()) {
            NativeScriptDebug.bootstrapLog(`Setting RootView to ${newRoot}`);
        }
        Application.resetRootView({
            create: () => newRoot,
        });
    };
    const showErrorUI = (error) => {
        const message = error.message + '\n\n' + error.stack;
        const errorTextBox = new TextView();
        errorTextBox.text = message;
        errorTextBox.color = new Color('red');
        setRootView(errorTextBox);
    };
    const bootstrapRoot = (reason) => {
        bootstrapId = Date.now();
        const currentBootstrapId = bootstrapId;
        let bootstrapped = false;
        let onMainBootstrap = () => {
            setRootView(mainModuleRef);
        };
        options.appModuleBootstrap(reason).then((ref) => {
            if (currentBootstrapId !== bootstrapId) {
                // this module is old and not needed anymore
                // this may happen when developer uses async app initializer and the user exits the app before this bootstraps
                ref.destroy();
                return;
            }
            mainModuleRef = ref;
            ref.onDestroy(() => (mainModuleRef = mainModuleRef === ref ? null : mainModuleRef));
            updatePlatformRef(ref, reason);
            const styleTag = ref.injector.get(NATIVESCRIPT_ROOT_MODULE_ID);
            ref.onDestroy(() => {
                removeTaggedAdditionalCSS(styleTag);
            });
            bootstrapped = true;
            // delay bootstrap callback until all rendering is good to go
            Utils.queueMacrotask(() => onMainBootstrap());
            // onMainBootstrap();
            emitModuleBootstrapEvent(ref, 'main', reason);
            // bootstrapped component: (ref as any)._bootstrapComponents[0];
        }, (err) => {
            bootstrapped = true;
            NativeScriptDebug.bootstrapLogError(`Error bootstrapping app module:\n${err.message}\n\n${err.stack}`);
            showErrorUI(err);
            throw err;
        });
        Utils.queueMacrotask(() => {
            if (currentBootstrapId !== bootstrapId) {
                return;
            }
            if (!bootstrapped) {
                if (options.loadingModule) {
                    options.loadingModule(reason).then((loadingRef) => {
                        if (currentBootstrapId !== bootstrapId) {
                            // this module is old and not needed anymore
                            // this may happen when developer uses async app initializer and the user exits the app before this bootstraps
                            loadingRef.destroy();
                            return;
                        }
                        loadingModuleRef = loadingRef;
                        loadingModuleRef.onDestroy(() => (loadingModuleRef = loadingModuleRef === loadingRef ? null : loadingModuleRef));
                        updatePlatformRef(loadingRef, reason);
                        const styleTag = loadingModuleRef.injector.get(NATIVESCRIPT_ROOT_MODULE_ID);
                        loadingRef.onDestroy(() => {
                            removeTaggedAdditionalCSS(styleTag);
                        });
                        setRootView(loadingRef);
                        onMainBootstrap = () => {
                            const loadingService = loadingModuleRef.injector.get(NativeScriptLoadingService);
                            loadingModuleRef.injector.get(NgZone).run(() => {
                                loadingService._notifyMainModuleReady();
                            });
                            loadingService.readyToDestroy$
                                .pipe(filter((ready) => ready), take(1))
                                .subscribe(() => {
                                destroyRef(loadingModuleRef, 'loading', reason);
                                loadingModuleRef = null;
                                setRootView(mainModuleRef);
                            });
                        };
                        emitModuleBootstrapEvent(loadingModuleRef, 'loading', reason);
                    }, (err) => {
                        NativeScriptDebug.bootstrapLogError(`Error bootstrapping loading module:\n${err.message}\n\n${err.stack}`);
                        showErrorUI(err);
                        throw err;
                    });
                }
                else if (options.launchView) {
                    let launchView = options.launchView(reason);
                    setRootView(launchView);
                    if (launchView.startAnimation) {
                        setTimeout(() => {
                            // ensure launch animation is executed after launchView added to view stack
                            launchView.startAnimation();
                        });
                    }
                    onMainBootstrap = () => {
                        if (launchView.cleanup) {
                            launchView
                                .cleanup()
                                .catch()
                                .then(() => {
                                launchView = null;
                                setRootView(mainModuleRef);
                            });
                        }
                    };
                }
                else {
                    console.warn('App is bootstrapping asynchronously (likely APP_INITIALIZER) but did not provide a launchView or LoadingModule.');
                }
            }
        });
    };
    const disposePlatform = (reason) => {
        destroyRef(platformRef, reason);
        platformRef = null;
    };
    const disposeLastModules = (reason) => {
        // reset bootstrap ID to make sure any modules bootstrapped after this are discarded
        bootstrapId = -1;
        destroyRef(loadingModuleRef, 'loading', reason);
        loadingModuleRef = null;
        destroyRef(mainModuleRef, 'main', reason);
        mainModuleRef = null;
    };
    const launchCallback = profile('@nativescript/angular/platform-common.launchCallback', (args) => {
        args.root = null;
        bootstrapRoot('applaunch');
    });
    const exitCallback = profile('@nativescript/angular/platform-common.exitCallback', (args) => {
        disposeLastModules('appexit');
    });
    Application.on(Application.launchEvent, launchCallback);
    Application.on(Application.exitEvent, exitCallback);
    if (module['hot']) {
        // handle HMR Application.run
        global['__dispose_app_ng_platform__'] = () => {
            disposePlatform('hotreload');
        };
        global['__dispose_app_ng_modules__'] = () => {
            disposeLastModules('hotreload');
        };
        global['__bootstrap_app_ng_modules__'] = () => {
            bootstrapRoot('hotreload');
        };
        global['__cleanup_ng_hot__'] = () => {
            Application.off(Application.launchEvent, launchCallback);
            Application.off(Application.exitEvent, exitCallback);
            disposeLastModules('hotreload');
            disposePlatform('hotreload');
        };
        global['__reboot_ng_modules__'] = (shouldDisposePlatform = false) => {
            disposeLastModules('hotreload');
            if (shouldDisposePlatform) {
                disposePlatform('hotreload');
            }
            bootstrapRoot('hotreload');
        };
        if (!Application.hasLaunched()) {
            Application.run();
            return;
        }
        bootstrapRoot('hotreload');
        return;
    }
    Application.run();
}
export { ɵ0, ɵ1, ɵ2, ɵ3 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwbGljYXRpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbGliL2FwcGxpY2F0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxFQUFFLFdBQVcsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNqRSxPQUFPLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNuRCxPQUFPLEVBQUUsV0FBVyxFQUF3QixLQUFLLEVBQStCLE9BQU8sRUFBRSx5QkFBeUIsRUFBZSxRQUFRLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBUyxNQUFNLG9CQUFvQixDQUFDO0FBQzFMLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUM5QyxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUMvRCxPQUFPLEVBQUUsYUFBYSxFQUFFLDBCQUEwQixFQUFFLDJCQUEyQixFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQ2xHLE9BQU8sRUFBYyxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDM0MsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sU0FBUyxDQUFDO0FBYTVDLE1BQU0sVUFBVSxzQkFBc0IsQ0FBQyxJQUFtQjtJQUN4RCxJQUFJLENBQUMsNEJBQTRCLEdBQUcsSUFBSSxDQUFDO0FBQzNDLENBQUM7QUFnQkQsTUFBTSxDQUFDLE1BQU0sbUJBQW1CLEdBQUcsSUFBSSxPQUFPLEVBQWlCLENBQUM7QUFDaEUsTUFBTSxDQUFDLE1BQU0scUJBQXFCLEdBQUcsSUFBSSxPQUFPLEVBQWlCLENBQUM7V0FNekQsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxVQUFVLEtBQUssTUFBTSxJQUFJLENBQUMsQ0FBQyxNQUFNLEtBQUssV0FBVyxPQUM3RCxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FB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N0IsQ0FBQyxDQUFDO1FBQ0YsTUFBTSxDQUFDLG9CQUFvQixDQUFDLEdBQUcsR0FBRyxFQUFFO1lBQ2xDLFdBQVcsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLFdBQVcsRUFBRSxjQUFjLENBQUMsQ0FBQztZQUN6RCxXQUFXLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxTQUFTLEVBQUUsWUFBWSxDQUFDLENBQUM7WUFDckQsa0JBQWtCLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDaEMsZUFBZSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQy9CLENBQUMsQ0FBQztRQUNGLE1BQU0sQ0FBQyx1QkFBdUIsQ0FBQyxHQUFHLENBQUMsd0JBQWlDLEtBQUssRUFBRSxFQUFFO1lBQzNFLGtCQUFrQixDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQ2hDLElBQUkscUJBQXFCLEVBQUU7Z0JBQ3pCLGVBQWUsQ0FBQyxXQUFXLENBQUMsQ0FBQzthQUM5QjtZQUNELGFBQWEsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUM3QixDQUFDLENBQUM7UUFFRixJQUFJLENBQUMsV0FBVyxDQUFDLFdBQVcsRUFBRSxFQUFFO1lBQzlCLFdBQVcsQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUNsQixPQUFPO1NBQ1I7UUFDRCxhQUFhLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDM0IsT0FBTztLQUNSO0lBRUQsV0FBVyxDQUFDLEdBQUcsRUFBRSxDQUFDO0FBQ3BCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBOZ01vZHVsZVJlZiwgTmdab25lLCBQbGF0Zm9ybVJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgZmlsdGVyLCBtYXAsIHRha2UgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBBcHBsaWNhdGlvbiwgQXBwbGljYXRpb25FdmVudERhdGEsIENvbG9yLCBMYXVuY2hFdmVudERhdGEsIExheW91dEJhc2UsIHByb2ZpbGUsIHJlbW92ZVRhZ2dlZEFkZGl0aW9uYWxDU1MsIFN0YWNrTGF5b3V0LCBUZXh0VmlldywgVmlldywgVXRpbHMsIFRyYWNlIH0gZnJvbSAnQG5hdGl2ZXNjcmlwdC9jb3JlJztcbmltcG9ydCB7IEFwcEhvc3RWaWV3IH0gZnJvbSAnLi9hcHAtaG9zdC12aWV3JztcbmltcG9ydCB7IE5hdGl2ZVNjcmlwdExvYWRpbmdTZXJ2aWNlIH0gZnJvbSAnLi9sb2FkaW5nLnNlcnZpY2UnO1xuaW1wb3J0IHsgQVBQX1JPT1RfVklFVywgRElTQUJMRV9ST09UX1ZJRVdfSEFORExJTkcsIE5BVElWRVNDUklQVF9ST09UX01PRFVMRV9JRCB9IGZyb20gJy4vdG9rZW5zJztcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IE5hdGl2ZVNjcmlwdERlYnVnIH0gZnJvbSAnLi90cmFjZSc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXBwTGF1bmNoVmlldyBleHRlbmRzIExheW91dEJhc2Uge1xuICAvLyBjYWxsZWQgd2hlbiB0aGUgYW5pbWF0aW9uIGlzIHRvIGJlZ2luXG4gIHN0YXJ0QW5pbWF0aW9uPzogKCkgPT4gdm9pZDtcbiAgLy8gY2FsbGVkIHdoZW4gYm9vdHN0cmFwIGlzIGNvbXBsZXRlIGFuZCBjbGVhbnVwIGNhbiBiZWdpblxuICAvLyBzaG91bGQgcmVzb2x2ZSB3aGVuIGFuaW1hdGlvbiBpcyBjb21wbGV0ZWx5IGZpbmlzaGVkXG4gIGNsZWFudXA/OiAoKSA9PiBQcm9taXNlPGFueT47XG5cbiAgLy8gZG8geW91IHdhbnQgdG8gaGFuZGxlIHNldHRpbmcgdGhpcyBhcyBhIHJvb3R2aWV3IG1hbnVhbGx5P1xuICBfX2Rpc2FibGVfcm9vdF92aWV3X2hhbmRsaW5nPzogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRpc2FibGVSb290Vmlld0hhbmRpbmcodmlldzogQXBwTGF1bmNoVmlldykge1xuICB2aWV3Ll9fZGlzYWJsZV9yb290X3ZpZXdfaGFuZGxpbmcgPSB0cnVlO1xufVxuXG5leHBvcnQgdHlwZSBOZ01vZHVsZVJlYXNvbiA9ICdob3RyZWxvYWQnIHwgJ2FwcGxhdW5jaCcgfCAnYXBwZXhpdCc7XG5cbmV4cG9ydCB0eXBlIE5nTW9kdWxlRXZlbnQgPVxuICB8IHtcbiAgICAgIG1vZHVsZVR5cGU6ICdtYWluJyB8ICdsb2FkaW5nJyB8IHN0cmluZztcbiAgICAgIHJlZmVyZW5jZTogTmdNb2R1bGVSZWY8dW5rbm93bj47XG4gICAgICByZWFzb246IE5nTW9kdWxlUmVhc29uIHwgc3RyaW5nO1xuICAgIH1cbiAgfCB7XG4gICAgICBtb2R1bGVUeXBlOiAncGxhdGZvcm0nO1xuICAgICAgcmVmZXJlbmNlOiBQbGF0Zm9ybVJlZjtcbiAgICAgIHJlYXNvbjogTmdNb2R1bGVSZWFzb24gfCBzdHJpbmc7XG4gICAgfTtcblxuZXhwb3J0IGNvbnN0IHByZUFuZ3VsYXJEaXNwb3NhbCQgPSBuZXcgU3ViamVjdDxOZ01vZHVsZUV2ZW50PigpO1xuZXhwb3J0IGNvbnN0IHBvc3RBbmd1bGFyQm9vdHN0cmFwJCA9IG5ldyBTdWJqZWN0PE5nTW9kdWxlRXZlbnQ+KCk7XG5cbi8qKlxuICogQGRlcHJlY2F0ZWRcbiAqL1xuZXhwb3J0IGNvbnN0IG9uQmVmb3JlTGl2ZXN5bmM6IE9ic2VydmFibGU8TmdNb2R1bGVSZWY8YW55Pj4gPSBwcmVBbmd1bGFyRGlzcG9zYWwkLnBpcGUoXG4gIGZpbHRlcigodikgPT4gdi5tb2R1bGVUeXBlID09PSAnbWFpbicgJiYgdi5yZWFzb24gPT09ICdob3RyZWxvYWQnKSxcbiAgbWFwKCh2KSA9PiB2LnJlZmVyZW5jZSBhcyBOZ01vZHVsZVJlZjxhbnk+KVxuKTtcbi8qKlxuICogQGRlcHJlY2F0ZWRcbiAqL1xuZXhwb3J0IGNvbnN0IG9uQWZ0ZXJMaXZlc3luYzogT2JzZXJ2YWJsZTx7XG4gIG1vZHVsZVJlZj86IE5nTW9kdWxlUmVmPGFueT47XG4gIGVycm9yPzogRXJyb3I7XG59PiA9IHBvc3RBbmd1bGFyQm9vdHN0cmFwJC5waXBlKFxuICBmaWx0ZXIoKHYpID0+IHYubW9kdWxlVHlwZSA9PT0gJ21haW4nKSxcbiAgbWFwKCh2KSA9PiAoeyBtb2R1bGVSZWY6IHYucmVmZXJlbmNlIGFzIE5nTW9kdWxlUmVmPGFueT4gfSkpXG4pO1xuZXhwb3J0IGludGVyZmFjZSBBcHBSdW5PcHRpb25zPFQsIEs+IHtcbiAgYXBwTW9kdWxlQm9vdHN0cmFwOiAocmVhc29uOiBOZ01vZHVsZVJlYXNvbikgPT4gUHJvbWlzZTxOZ01vZHVsZVJlZjxUPj47XG4gIGxvYWRpbmdNb2R1bGU/OiAocmVhc29uOiBOZ01vZHVsZVJlYXNvbikgPT4gUHJvbWlzZTxOZ01vZHVsZVJlZjxLPj47XG4gIGxhdW5jaFZpZXc/OiAocmVhc29uOiBOZ01vZHVsZVJlYXNvbikgPT4gQXBwTGF1bmNoVmlldztcbn1cblxuaWYgKG1vZHVsZVsnaG90J10pIHtcbiAgbW9kdWxlWydob3QnXS5kZWNsaW5lKCk7XG4gIGdsb2JhbC5fX29uTGl2ZVN5bmNDb3JlID0gKCkgPT4ge1xuICAgIEFwcGxpY2F0aW9uLmdldFJvb3RWaWV3KCk/Ll9vbkNzc1N0YXRlQ2hhbmdlKCk7XG4gICAgLy8gYWxsIG90aGVyIGNoYW5nZXMgYXJlIGFwcGxpZWQgYnkgcnVuTmF0aXZlU2NyaXB0QW5ndWxhckFwcFxuICB9O1xufVxuXG5mdW5jdGlvbiBlbWl0TW9kdWxlQm9vdHN0cmFwRXZlbnQ8VD4ocmVmOiBOZ01vZHVsZVJlZjxUPiwgbmFtZTogJ21haW4nIHwgJ2xvYWRpbmcnLCByZWFzb246IE5nTW9kdWxlUmVhc29uKSB7XG4gIHBvc3RBbmd1bGFyQm9vdHN0cmFwJC5uZXh0KHtcbiAgICBtb2R1bGVUeXBlOiBuYW1lLFxuICAgIHJlZmVyZW5jZTogcmVmLFxuICAgIHJlYXNvbixcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGRlc3Ryb3lSZWY8VD4ocmVmOiBOZ01vZHVsZVJlZjxUPiwgbmFtZTogJ21haW4nIHwgJ2xvYWRpbmcnLCByZWFzb246IE5nTW9kdWxlUmVhc29uKTogdm9pZDtcbmZ1bmN0aW9uIGRlc3Ryb3lSZWYocmVmOiBQbGF0Zm9ybVJlZiwgcmVhc29uOiBOZ01vZHVsZVJlYXNvbik6IHZvaWQ7XG5mdW5jdGlvbiBkZXN0cm95UmVmPFQ+KHJlZjogUGxhdGZvcm1SZWYgfCBOZ01vZHVsZVJlZjxUPiwgbmFtZT86IHN0cmluZywgcmVhc29uPzogc3RyaW5nKTogdm9pZCB7XG4gIGlmIChyZWYpIHtcbiAgICBpZiAocmVmIGluc3RhbmNlb2YgUGxhdGZvcm1SZWYpIHtcbiAgICAgIHByZUFuZ3VsYXJEaXNwb3NhbCQubmV4dCh7XG4gICAgICAgIG1vZHVsZVR5cGU6ICdwbGF0Zm9ybScsXG4gICAgICAgIHJlZmVyZW5jZTogcmVmLFxuICAgICAgICByZWFzb246IG5hbWUsXG4gICAgICB9KTtcbiAgICB9XG4gICAgaWYgKHJlZiBpbnN0YW5jZW9mIE5nTW9kdWxlUmVmKSB7XG4gICAgICBwcmVBbmd1bGFyRGlzcG9zYWwkLm5leHQoe1xuICAgICAgICBtb2R1bGVUeXBlOiBuYW1lLFxuICAgICAgICByZWZlcmVuY2U6IHJlZixcbiAgICAgICAgcmVhc29uLFxuICAgICAgfSk7XG4gICAgfVxuICAgIHJlZi5kZXN0cm95KCk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJ1bk5hdGl2ZVNjcmlwdEFuZ3VsYXJBcHA8VCwgSz4ob3B0aW9uczogQXBwUnVuT3B0aW9uczxULCBLPikge1xuICBsZXQgbWFpbk1vZHVsZVJlZjogTmdNb2R1bGVSZWY8VD4gPSBudWxsO1xuICBsZXQgbG9hZGluZ01vZHVsZVJlZjogTmdNb2R1bGVSZWY8Sz47XG4gIGxldCBwbGF0Zm9ybVJlZjogUGxhdGZvcm1SZWYgPSBudWxsO1xuICBsZXQgYm9vdHN0cmFwSWQgPSAtMTtcbiAgY29uc3QgdXBkYXRlUGxhdGZvcm1SZWYgPSAobW9kdWxlUmVmOiBOZ01vZHVsZVJlZjxUIHwgSz4sIHJlYXNvbjogTmdNb2R1bGVSZWFzb24pID0+IHtcbiAgICBjb25zdCBuZXdQbGF0Zm9ybVJlZiA9IG1vZHVsZVJlZi5pbmplY3Rvci5nZXQoUGxhdGZvcm1SZWYpO1xuICAgIGlmIChuZXdQbGF0Zm9ybVJlZiA9PT0gcGxhdGZvcm1SZWYpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgZGVzdHJveVJlZihwbGF0Zm9ybVJlZiwgcmVhc29uKTtcbiAgICBwbGF0Zm9ybVJlZiA9IG5ld1BsYXRmb3JtUmVmO1xuICAgIHBsYXRmb3JtUmVmLm9uRGVzdHJveSgoKSA9PiAocGxhdGZvcm1SZWYgPSBwbGF0Zm9ybVJlZiA9PT0gbmV3UGxhdGZvcm1SZWYgPyBudWxsIDogcGxhdGZvcm1SZWYpKTtcbiAgfTtcbiAgY29uc3Qgc2V0Um9vdFZpZXcgPSAocmVmOiBOZ01vZHVsZVJlZjxUIHwgSz4gfCBWaWV3KSA9PiB7XG4gICAgaWYgKGJvb3RzdHJhcElkID09PSAtMSkge1xuICAgICAgLy8gdHJlYXQgZWRnZSBjYXNlc1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAocmVmIGluc3RhbmNlb2YgTmdNb2R1bGVSZWYpIHtcbiAgICAgIGlmIChyZWYuaW5qZWN0b3IuZ2V0KERJU0FCTEVfUk9PVF9WSUVXX0hBTkRMSU5HLCBmYWxzZSkpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBpZiAocmVmWydfX2Rpc2FibGVfcm9vdF92aWV3X2hhbmRsaW5nJ10pIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIH1cbiAgICBBcHBsaWNhdGlvbi5nZXRSb290VmlldygpPy5fY2xvc2VBbGxNb2RhbFZpZXdzSW50ZXJuYWwoKTsgLy8gY2xlYW51cCBvbGQgcm9vdHZpZXdcbiAgICAvLyBUT0RPOiBjaGVjayBmb3IgbGVha3Mgd2hlbiByb290IHZpZXcgaXNuJ3QgcHJvcGVybHkgZGVzdHJveWVkXG4gICAgaWYgKHJlZiBpbnN0YW5jZW9mIFZpZXcpIHtcbiAgICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgICBOYXRpdmVTY3JpcHREZWJ1Zy5ib290c3RyYXBMb2coYFNldHRpbmcgUm9vdFZpZXcgdG8gJHtyZWZ9YCk7XG4gICAgICB9XG4gICAgICBBcHBsaWNhdGlvbi5yZXNldFJvb3RWaWV3KHtcbiAgICAgICAgY3JlYXRlOiAoKSA9PiByZWYsXG4gICAgICB9KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgdmlldyA9IHJlZi5pbmplY3Rvci5nZXQoQVBQX1JPT1RfVklFVykgYXMgQXBwSG9zdFZpZXcgfCBWaWV3O1xuICAgIGNvbnN0IG5ld1Jvb3QgPSB2aWV3IGluc3RhbmNlb2YgQXBwSG9zdFZpZXcgPyB2aWV3LmNvbnRlbnQgOiB2aWV3O1xuICAgIGlmIChOYXRpdmVTY3JpcHREZWJ1Zy5pc0xvZ0VuYWJsZWQoKSkge1xuICAgICAgTmF0aXZlU2NyaXB0RGVidWcuYm9vdHN0cmFwTG9nKGBTZXR0aW5nIFJvb3RWaWV3IHRvICR7bmV3Um9vdH1gKTtcbiAgICB9XG4gICAgQXBwbGljYXRpb24ucmVzZXRSb290Vmlldyh7XG4gICAgICBjcmVhdGU6ICgpID0+IG5ld1Jvb3QsXG4gICAgfSk7XG4gIH07XG4gIGNvbnN0IHNob3dFcnJvclVJID0gKGVycm9yOiBFcnJvcikgPT4ge1xuICAgIGNvbnN0IG1lc3NhZ2UgPSBlcnJvci5tZXNzYWdlICsgJ1xcblxcbicgKyBlcnJvci5zdGFjaztcbiAgICBjb25zdCBlcnJvclRleHRCb3ggPSBuZXcgVGV4dFZpZXcoKTtcbiAgICBlcnJvclRleHRCb3gudGV4dCA9IG1lc3NhZ2U7XG4gICAgZXJyb3JUZXh0Qm94LmNvbG9yID0gbmV3IENvbG9yKCdyZWQnKTtcbiAgICBzZXRSb290VmlldyhlcnJvclRleHRCb3gpO1xuICB9O1xuICBjb25zdCBib290c3RyYXBSb290ID0gKHJlYXNvbjogTmdNb2R1bGVSZWFzb24pID0+IHtcbiAgICBib290c3RyYXBJZCA9IERhdGUubm93KCk7XG4gICAgY29uc3QgY3VycmVudEJvb3RzdHJhcElkID0gYm9vdHN0cmFwSWQ7XG4gICAgbGV0IGJvb3RzdHJhcHBlZCA9IGZhbHNlO1xuICAgIGxldCBvbk1haW5Cb290c3RyYXAgPSAoKSA9PiB7XG4gICAgICBzZXRSb290VmlldyhtYWluTW9kdWxlUmVmKTtcbiAgICB9O1xuICAgIG9wdGlvbnMuYXBwTW9kdWxlQm9vdHN0cmFwKHJlYXNvbikudGhlbihcbiAgICAgIChyZWYpID0+IHtcbiAgICAgICAgaWYgKGN1cnJlbnRCb290c3RyYXBJZCAhPT0gYm9vdHN0cmFwSWQpIHtcbiAgICAgICAgICAvLyB0aGlzIG1vZHVsZSBpcyBvbGQgYW5kIG5vdCBuZWVkZWQgYW55bW9yZVxuICAgICAgICAgIC8vIHRoaXMgbWF5IGhhcHBlbiB3aGVuIGRldmVsb3BlciB1c2VzIGFzeW5jIGFwcCBpbml0aWFsaXplciBhbmQgdGhlIHVzZXIgZXhpdHMgdGhlIGFwcCBiZWZvcmUgdGhpcyBib290c3RyYXBzXG4gICAgICAgICAgcmVmLmRlc3Ryb3koKTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgbWFpbk1vZHVsZVJlZiA9IHJlZjtcbiAgICAgICAgcmVmLm9uRGVzdHJveSgoKSA9PiAobWFpbk1vZHVsZVJlZiA9IG1haW5Nb2R1bGVSZWYgPT09IHJlZiA/IG51bGwgOiBtYWluTW9kdWxlUmVmKSk7XG4gICAgICAgIHVwZGF0ZVBsYXRmb3JtUmVmKHJlZiwgcmVhc29uKTtcbiAgICAgICAgY29uc3Qgc3R5bGVUYWcgPSByZWYuaW5qZWN0b3IuZ2V0KE5BVElWRVNDUklQVF9ST09UX01PRFVMRV9JRCk7XG4gICAgICAgIHJlZi5vbkRlc3Ryb3koKCkgPT4ge1xuICAgICAgICAgIHJlbW92ZVRhZ2dlZEFkZGl0aW9uYWxDU1Moc3R5bGVUYWcpO1xuICAgICAgICB9KTtcbiAgICAgICAgYm9vdHN0cmFwcGVkID0gdHJ1ZTtcbiAgICAgICAgLy8gZGVsYXkgYm9vdHN0cmFwIGNhbGxiYWNrIHVudGlsIGFsbCByZW5kZXJpbmcgaXMgZ29vZCB0byBnb1xuICAgICAgICBVdGlscy5xdWV1ZU1hY3JvdGFzaygoKSA9PiBvbk1haW5Cb290c3RyYXAoKSk7XG4gICAgICAgIC8vIG9uTWFpbkJvb3RzdHJhcCgpO1xuICAgICAgICBlbWl0TW9kdWxlQm9vdHN0cmFwRXZlbnQocmVmLCAnbWFpbicsIHJlYXNvbik7XG4gICAgICAgIC8vIGJvb3RzdHJhcHBlZCBjb21wb25lbnQ6IChyZWYgYXMgYW55KS5fYm9vdHN0cmFwQ29tcG9uZW50c1swXTtcbiAgICAgIH0sXG4gICAgICAoZXJyKSA9PiB7XG4gICAgICAgIGJvb3RzdHJhcHBlZCA9IHRydWU7XG4gICAgICAgIE5hdGl2ZVNjcmlwdERlYnVnLmJvb3RzdHJhcExvZ0Vycm9yKGBFcnJvciBib290c3RyYXBwaW5nIGFwcCBtb2R1bGU6XFxuJHtlcnIubWVzc2FnZX1cXG5cXG4ke2Vyci5zdGFja31gKTtcbiAgICAgICAgc2hvd0Vycm9yVUkoZXJyKTtcbiAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgfVxuICAgICk7XG4gICAgVXRpbHMucXVldWVNYWNyb3Rhc2soKCkgPT4ge1xuICAgICAgaWYgKGN1cnJlbnRCb290c3RyYXBJZCAhPT0gYm9vdHN0cmFwSWQpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgaWYgKCFib290c3RyYXBwZWQpIHtcbiAgICAgICAgaWYgKG9wdGlvbnMubG9hZGluZ01vZHVsZSkge1xuICAgICAgICAgIG9wdGlvbnMubG9hZGluZ01vZHVsZShyZWFzb24pLnRoZW4oXG4gICAgICAgICAgICAobG9hZGluZ1JlZikgPT4ge1xuICAgICAgICAgICAgICBpZiAoY3VycmVudEJvb3RzdHJhcElkICE9PSBib290c3RyYXBJZCkge1xuICAgICAgICAgICAgICAgIC8vIHRoaXMgbW9kdWxlIGlzIG9sZCBhbmQgbm90IG5lZWRlZCBhbnltb3JlXG4gICAgICAgICAgICAgICAgLy8gdGhpcyBtYXkgaGFwcGVuIHdoZW4gZGV2ZWxvcGVyIHVzZXMgYXN5bmMgYXBwIGluaXRpYWxpemVyIGFuZCB0aGUgdXNlciBleGl0cyB0aGUgYXBwIGJlZm9yZSB0aGlzIGJvb3RzdHJhcHNcbiAgICAgICAgICAgICAgICBsb2FkaW5nUmVmLmRlc3Ryb3koKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgbG9hZGluZ01vZHVsZVJlZiA9IGxvYWRpbmdSZWY7XG4gICAgICAgICAgICAgIGxvYWRpbmdNb2R1bGVSZWYub25EZXN0cm95KCgpID0+IChsb2FkaW5nTW9kdWxlUmVmID0gbG9hZGluZ01vZHVsZVJlZiA9PT0gbG9hZGluZ1JlZiA/IG51bGwgOiBsb2FkaW5nTW9kdWxlUmVmKSk7XG4gICAgICAgICAgICAgIHVwZGF0ZVBsYXRmb3JtUmVmKGxvYWRpbmdSZWYsIHJlYXNvbik7XG4gICAgICAgICAgICAgIGNvbnN0IHN0eWxlVGFnID0gbG9hZGluZ01vZHVsZVJlZi5pbmplY3Rvci5nZXQoTkFUSVZFU0NSSVBUX1JPT1RfTU9EVUxFX0lEKTtcbiAgICAgICAgICAgICAgbG9hZGluZ1JlZi5vbkRlc3Ryb3koKCkgPT4ge1xuICAgICAgICAgICAgICAgIHJlbW92ZVRhZ2dlZEFkZGl0aW9uYWxDU1Moc3R5bGVUYWcpO1xuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgc2V0Um9vdFZpZXcobG9hZGluZ1JlZik7XG4gICAgICAgICAgICAgIG9uTWFpbkJvb3RzdHJhcCA9ICgpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBsb2FkaW5nU2VydmljZSA9IGxvYWRpbmdNb2R1bGVSZWYuaW5qZWN0b3IuZ2V0KE5hdGl2ZVNjcmlwdExvYWRpbmdTZXJ2aWNlKTtcbiAgICAgICAgICAgICAgICBsb2FkaW5nTW9kdWxlUmVmLmluamVjdG9yLmdldChOZ1pvbmUpLnJ1bigoKSA9PiB7XG4gICAgICAgICAgICAgICAgICBsb2FkaW5nU2VydmljZS5fbm90aWZ5TWFpbk1vZHVsZVJlYWR5KCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgbG9hZGluZ1NlcnZpY2UucmVhZHlUb0Rlc3Ryb3kkXG4gICAgICAgICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICAgICAgZmlsdGVyKChyZWFkeSkgPT4gcmVhZHkpLFxuICAgICAgICAgICAgICAgICAgICB0YWtlKDEpXG4gICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgZGVzdHJveVJlZihsb2FkaW5nTW9kdWxlUmVmLCAnbG9hZGluZycsIHJlYXNvbik7XG4gICAgICAgICAgICAgICAgICAgIGxvYWRpbmdNb2R1bGVSZWYgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICBzZXRSb290VmlldyhtYWluTW9kdWxlUmVmKTtcbiAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICBlbWl0TW9kdWxlQm9vdHN0cmFwRXZlbnQobG9hZGluZ01vZHVsZVJlZiwgJ2xvYWRpbmcnLCByZWFzb24pO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIChlcnIpID0+IHtcbiAgICAgICAgICAgICAgTmF0aXZlU2NyaXB0RGVidWcuYm9vdHN0cmFwTG9nRXJyb3IoYEVycm9yIGJvb3RzdHJhcHBpbmcgbG9hZGluZyBtb2R1bGU6XFxuJHtlcnIubWVzc2FnZX1cXG5cXG4ke2Vyci5zdGFja31gKTtcbiAgICAgICAgICAgICAgc2hvd0Vycm9yVUkoZXJyKTtcbiAgICAgICAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSBpZiAob3B0aW9ucy5sYXVuY2hWaWV3KSB7XG4gICAgICAgICAgbGV0IGxhdW5jaFZpZXcgPSBvcHRpb25zLmxhdW5jaFZpZXcocmVhc29uKTtcbiAgICAgICAgICBzZXRSb290VmlldyhsYXVuY2hWaWV3KTtcbiAgICAgICAgICBpZiAobGF1bmNoVmlldy5zdGFydEFuaW1hdGlvbikge1xuICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgIC8vIGVuc3VyZSBsYXVuY2ggYW5pbWF0aW9uIGlzIGV4ZWN1dGVkIGFmdGVyIGxhdW5jaFZpZXcgYWRkZWQgdG8gdmlldyBzdGFja1xuICAgICAgICAgICAgICBsYXVuY2hWaWV3LnN0YXJ0QW5pbWF0aW9uKCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgICAgb25NYWluQm9vdHN0cmFwID0gKCkgPT4ge1xuICAgICAgICAgICAgaWYgKGxhdW5jaFZpZXcuY2xlYW51cCkge1xuICAgICAgICAgICAgICBsYXVuY2hWaWV3XG4gICAgICAgICAgICAgICAgLmNsZWFudXAoKVxuICAgICAgICAgICAgICAgIC5jYXRjaCgpXG4gICAgICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgbGF1bmNoVmlldyA9IG51bGw7XG4gICAgICAgICAgICAgICAgICBzZXRSb290VmlldyhtYWluTW9kdWxlUmVmKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnNvbGUud2FybignQXBwIGlzIGJvb3RzdHJhcHBpbmcgYXN5bmNocm9ub3VzbHkgKGxpa2VseSBBUFBfSU5JVElBTElaRVIpIGJ1dCBkaWQgbm90IHByb3ZpZGUgYSBsYXVuY2hWaWV3IG9yIExvYWRpbmdNb2R1bGUuJyk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgfTtcbiAgY29uc3QgZGlzcG9zZVBsYXRmb3JtID0gKHJlYXNvbjogTmdNb2R1bGVSZWFzb24pID0+IHtcbiAgICBkZXN0cm95UmVmKHBsYXRmb3JtUmVmLCByZWFzb24pO1xuICAgIHBsYXRmb3JtUmVmID0gbnVsbDtcbiAgfTtcbiAgY29uc3QgZGlzcG9zZUxhc3RNb2R1bGVzID0gKHJlYXNvbjogTmdNb2R1bGVSZWFzb24pID0+IHtcbiAgICAvLyByZXNldCBib290c3RyYXAgSUQgdG8gbWFrZSBzdXJlIGFueSBtb2R1bGVzIGJvb3RzdHJhcHBlZCBhZnRlciB0aGlzIGFyZSBkaXNjYXJkZWRcbiAgICBib290c3RyYXBJZCA9IC0xO1xuICAgIGRlc3Ryb3lSZWYobG9hZGluZ01vZHVsZVJlZiwgJ2xvYWRpbmcnLCByZWFzb24pO1xuICAgIGxvYWRpbmdNb2R1bGVSZWYgPSBudWxsO1xuICAgIGRlc3Ryb3lSZWYobWFpbk1vZHVsZVJlZiwgJ21haW4nLCByZWFzb24pO1xuICAgIG1haW5Nb2R1bGVSZWYgPSBudWxsO1xuICB9O1xuICBjb25zdCBsYXVuY2hDYWxsYmFjayA9IHByb2ZpbGUoJ0BuYXRpdmVzY3JpcHQvYW5ndWxhci9wbGF0Zm9ybS1jb21tb24ubGF1bmNoQ2FsbGJhY2snLCAoYXJnczogTGF1bmNoRXZlbnREYXRhKSA9PiB7XG4gICAgYXJncy5yb290ID0gbnVsbDtcbiAgICBib290c3RyYXBSb290KCdhcHBsYXVuY2gnKTtcbiAgfSk7XG4gIGNvbnN0IGV4aXRDYWxsYmFjayA9IHByb2ZpbGUoJ0BuYXRpdmVzY3JpcHQvYW5ndWxhci9wbGF0Zm9ybS1jb21tb24uZXhpdENhbGxiYWNrJywgKGFyZ3M6IEFwcGxpY2F0aW9uRXZlbnREYXRhKSA9PiB7XG4gICAgZGlzcG9zZUxhc3RNb2R1bGVzKCdhcHBleGl0Jyk7XG4gIH0pO1xuXG4gIEFwcGxpY2F0aW9uLm9uKEFwcGxpY2F0aW9uLmxhdW5jaEV2ZW50LCBsYXVuY2hDYWxsYmFjayk7XG4gIEFwcGxpY2F0aW9uLm9uKEFwcGxpY2F0aW9uLmV4aXRFdmVudCwgZXhpdENhbGxiYWNrKTtcbiAgaWYgKG1vZHVsZVsnaG90J10pIHtcbiAgICAvLyBoYW5kbGUgSE1SIEFwcGxpY2F0aW9uLnJ1blxuICAgIGdsb2JhbFsnX19kaXNwb3NlX2FwcF9uZ19wbGF0Zm9ybV9fJ10gPSAoKSA9PiB7XG4gICAgICBkaXNwb3NlUGxhdGZvcm0oJ2hvdHJlbG9hZCcpO1xuICAgIH07XG4gICAgZ2xvYmFsWydfX2Rpc3Bvc2VfYXBwX25nX21vZHVsZXNfXyddID0gKCkgPT4ge1xuICAgICAgZGlzcG9zZUxhc3RNb2R1bGVzKCdob3RyZWxvYWQnKTtcbiAgICB9O1xuICAgIGdsb2JhbFsnX19ib290c3RyYXBfYXBwX25nX21vZHVsZXNfXyddID0gKCkgPT4ge1xuICAgICAgYm9vdHN0cmFwUm9vdCgnaG90cmVsb2FkJyk7XG4gICAgfTtcbiAgICBnbG9iYWxbJ19fY2xlYW51cF9uZ19ob3RfXyddID0gKCkgPT4ge1xuICAgICAgQXBwbGljYXRpb24ub2ZmKEFwcGxpY2F0aW9uLmxhdW5jaEV2ZW50LCBsYXVuY2hDYWxsYmFjayk7XG4gICAgICBBcHBsaWNhdGlvbi5vZmYoQXBwbGljYXRpb24uZXhpdEV2ZW50LCBleGl0Q2FsbGJhY2spO1xuICAgICAgZGlzcG9zZUxhc3RNb2R1bGVzKCdob3RyZWxvYWQnKTtcbiAgICAgIGRpc3Bvc2VQbGF0Zm9ybSgnaG90cmVsb2FkJyk7XG4gICAgfTtcbiAgICBnbG9iYWxbJ19fcmVib290X25nX21vZHVsZXNfXyddID0gKHNob3VsZERpc3Bvc2VQbGF0Zm9ybTogYm9vbGVhbiA9IGZhbHNlKSA9PiB7XG4gICAgICBkaXNwb3NlTGFzdE1vZHVsZXMoJ2hvdHJlbG9hZCcpO1xuICAgICAgaWYgKHNob3VsZERpc3Bvc2VQbGF0Zm9ybSkge1xuICAgICAgICBkaXNwb3NlUGxhdGZvcm0oJ2hvdHJlbG9hZCcpO1xuICAgICAgfVxuICAgICAgYm9vdHN0cmFwUm9vdCgnaG90cmVsb2FkJyk7XG4gICAgfTtcblxuICAgIGlmICghQXBwbGljYXRpb24uaGFzTGF1bmNoZWQoKSkge1xuICAgICAgQXBwbGljYXRpb24ucnVuKCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGJvb3RzdHJhcFJvb3QoJ2hvdHJlbG9hZCcpO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIEFwcGxpY2F0aW9uLnJ1bigpO1xufVxuIl19