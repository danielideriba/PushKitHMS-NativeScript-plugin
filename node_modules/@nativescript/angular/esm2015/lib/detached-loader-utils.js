import { ApplicationRef, ComponentFactoryResolver, TemplateRef } from '@angular/core';
import { ContentView } from '@nativescript/core';
import { DetachedLoader } from './cdk/detached-loader';
import { ComponentPortal, NativeScriptDomPortalOutlet, TemplatePortal } from './cdk/portal';
import { NgViewRef } from './view-refs';
/**
 * creates a DetachedLoader either linked to the ViewContainerRef or the ApplicationRef if ViewContainerRef is not defined
 * @param resolver component factory resolver
 * @param injector default injector, unused if viewContainerRef is set
 * @param viewContainerRef where the view should live in the angular tree
 * @returns reference to the DetachedLoader
 */
export function generateDetachedLoader(resolver, injector, viewContainerRef) {
    injector = (viewContainerRef === null || viewContainerRef === void 0 ? void 0 : viewContainerRef.injector) || injector;
    const detachedFactory = resolver.resolveComponentFactory(DetachedLoader);
    const detachedLoaderRef = (viewContainerRef === null || viewContainerRef === void 0 ? void 0 : viewContainerRef.createComponent(detachedFactory)) || detachedFactory.create(injector);
    if (!viewContainerRef) {
        injector.get(ApplicationRef).attachView(detachedLoaderRef.hostView);
    }
    detachedLoaderRef.changeDetectorRef.detectChanges();
    return detachedLoaderRef;
}
/**
 * Generates a NgViewRef from a component or template. @see NgViewRef
 * Pass keepNativeViewAttached as `true` if you don't want the first native view to be detached from its parent.
 * For opening modals and others, the firstNativeLikeView should be detached.
 * @param typeOrTemplate ComponentType or TemplateRef that should be instanced
 * @param options options for creating the view
 * @returns NgViewRef
 */
export function generateNativeScriptView(typeOrTemplate, options) {
    var _a;
    let detachedLoaderRef = options.detachedLoaderRef;
    const reusingDetachedLoader = !!detachedLoaderRef;
    if (reusingDetachedLoader) {
        options.viewContainerRef = detachedLoaderRef.instance.vc;
    }
    const injector = ((_a = options.viewContainerRef) === null || _a === void 0 ? void 0 : _a.injector) || options.injector;
    const resolver = options.resolver || injector.get(ComponentFactoryResolver);
    if (!detachedLoaderRef && (options.viewContainerRef || typeOrTemplate instanceof TemplateRef)) {
        detachedLoaderRef = generateDetachedLoader(resolver, injector, options.viewContainerRef);
    }
    let portal;
    if (typeOrTemplate instanceof TemplateRef) {
        portal = new TemplatePortal(typeOrTemplate, detachedLoaderRef.instance.vc);
    }
    else {
        portal = new ComponentPortal(typeOrTemplate, detachedLoaderRef === null || detachedLoaderRef === void 0 ? void 0 : detachedLoaderRef.instance.vc);
    }
    const parentView = new ContentView();
    const portalOutlet = new NativeScriptDomPortalOutlet(parentView, resolver, injector.get(ApplicationRef), injector);
    const componentOrTemplateRef = portalOutlet.attach(portal);
    componentOrTemplateRef.onDestroy(() => {
        portalOutlet.dispose();
    });
    if (detachedLoaderRef && !reusingDetachedLoader) {
        componentOrTemplateRef.onDestroy(() => {
            detachedLoaderRef.destroy();
        });
    }
    const viewRef = new NgViewRef(componentOrTemplateRef);
    viewRef.detachedLoaderRef = detachedLoaderRef;
    if (!options.keepNativeViewAttached) {
        viewRef.detachNativeLikeView();
    }
    return viewRef;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV0YWNoZWQtbG9hZGVyLXV0aWxzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2xpYi9kZXRhY2hlZC1sb2FkZXItdXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGNBQWMsRUFBRSx3QkFBd0IsRUFBMkMsV0FBVyxFQUEwQixNQUFNLGVBQWUsQ0FBQztBQUN2SixPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDakQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxlQUFlLEVBQUUsMkJBQTJCLEVBQUUsY0FBYyxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQzVGLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFFeEM7Ozs7OztHQU1HO0FBQ0gsTUFBTSxVQUFVLHNCQUFzQixDQUFDLFFBQWtDLEVBQUUsUUFBa0IsRUFBRSxnQkFBbUM7SUFDaEksUUFBUSxHQUFHLENBQUEsZ0JBQWdCLGFBQWhCLGdCQUFnQix1QkFBaEIsZ0JBQWdCLENBQUUsUUFBUSxLQUFJLFFBQVEsQ0FBQztJQUNsRCxNQUFNLGVBQWUsR0FBRyxRQUFRLENBQUMsdUJBQXVCLENBQUMsY0FBYyxDQUFDLENBQUM7SUFDekUsTUFBTSxpQkFBaUIsR0FBRyxDQUFBLGdCQUFnQixhQUFoQixnQkFBZ0IsdUJBQWhCLGdCQUFnQixDQUFFLGVBQWUsQ0FBQyxlQUFlLENBQUMsS0FBSSxlQUFlLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ2pILElBQUksQ0FBQyxnQkFBZ0IsRUFBRTtRQUNyQixRQUFRLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQyxRQUFRLENBQUMsQ0FBQztLQUNyRTtJQUNELGlCQUFpQixDQUFDLGlCQUFpQixDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3BELE9BQU8saUJBQWlCLENBQUM7QUFDM0IsQ0FBQztBQUVEOzs7Ozs7O0dBT0c7QUFDSCxNQUFNLFVBQVUsd0JBQXdCLENBQ3RDLGNBQXdDLEVBQ3hDLE9BU0M7O0lBRUQsSUFBSSxpQkFBaUIsR0FBaUMsT0FBTyxDQUFDLGlCQUFpQixDQUFDO0lBQ2hGLE1BQU0scUJBQXFCLEdBQUcsQ0FBQyxDQUFDLGlCQUFpQixDQUFDO0lBQ2xELElBQUkscUJBQXFCLEVBQUU7UUFDekIsT0FBTyxDQUFDLGdCQUFnQixHQUFHLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUM7S0FDMUQ7SUFDRCxNQUFNLFFBQVEsR0FBRyxDQUFBLE1BQUEsT0FBTyxDQUFDLGdCQUFnQiwwQ0FBRSxRQUFRLEtBQUksT0FBTyxDQUFDLFFBQVEsQ0FBQztJQUN4RSxNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsUUFBUSxJQUFJLFFBQVEsQ0FBQyxHQUFHLENBQUMsd0JBQXdCLENBQUMsQ0FBQztJQUM1RSxJQUFJLENBQUMsaUJBQWlCLElBQUksQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLElBQUksY0FBYyxZQUFZLFdBQVcsQ0FBQyxFQUFFO1FBQzdGLGlCQUFpQixHQUFHLHNCQUFzQixDQUFDLFFBQVEsRUFBRSxRQUFRLEVBQUUsT0FBTyxDQUFDLGdCQUFnQixDQUFDLENBQUM7S0FDMUY7SUFDRCxJQUFJLE1BQThDLENBQUM7SUFDbkQsSUFBSSxjQUFjLFlBQVksV0FBVyxFQUFFO1FBQ3pDLE1BQU0sR0FBRyxJQUFJLGNBQWMsQ0FBQyxjQUFjLEVBQUUsaUJBQWlCLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0tBQzVFO1NBQU07UUFDTCxNQUFNLEdBQUcsSUFBSSxlQUFlLENBQUMsY0FBYyxFQUFFLGlCQUFpQixhQUFqQixpQkFBaUIsdUJBQWpCLGlCQUFpQixDQUFFLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztLQUM5RTtJQUNELE1BQU0sVUFBVSxHQUFHLElBQUksV0FBVyxFQUFFLENBQUM7SUFDckMsTUFBTSxZQUFZLEdBQUcsSUFBSSwyQkFBMkIsQ0FBQyxVQUFVLEVBQUUsUUFBUSxFQUFFLFFBQVEsQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDbkgsTUFBTSxzQkFBc0IsR0FBeUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNqRyxzQkFBc0IsQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFO1FBQ3BDLFlBQVksQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUN6QixDQUFDLENBQUMsQ0FBQztJQUNILElBQUksaUJBQWlCLElBQUksQ0FBQyxxQkFBcUIsRUFBRTtRQUMvQyxzQkFBc0IsQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFO1lBQ3BDLGlCQUFpQixDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQzlCLENBQUMsQ0FBQyxDQUFDO0tBQ0o7SUFDRCxNQUFNLE9BQU8sR0FBRyxJQUFJLFNBQVMsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0lBQ3JELE9BQWUsQ0FBQyxpQkFBaUIsR0FBRyxpQkFBaUIsQ0FBQztJQUN2RCxJQUFJLENBQUMsT0FBTyxDQUFDLHNCQUFzQixFQUFFO1FBQ25DLE9BQU8sQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO0tBQ2hDO0lBQ0QsT0FBTyxPQUFPLENBQUM7QUFDakIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFwcGxpY2F0aW9uUmVmLCBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsIENvbXBvbmVudFJlZiwgRW1iZWRkZWRWaWV3UmVmLCBJbmplY3RvciwgVGVtcGxhdGVSZWYsIFR5cGUsIFZpZXdDb250YWluZXJSZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IENvbnRlbnRWaWV3IH0gZnJvbSAnQG5hdGl2ZXNjcmlwdC9jb3JlJztcbmltcG9ydCB7IERldGFjaGVkTG9hZGVyIH0gZnJvbSAnLi9jZGsvZGV0YWNoZWQtbG9hZGVyJztcbmltcG9ydCB7IENvbXBvbmVudFBvcnRhbCwgTmF0aXZlU2NyaXB0RG9tUG9ydGFsT3V0bGV0LCBUZW1wbGF0ZVBvcnRhbCB9IGZyb20gJy4vY2RrL3BvcnRhbCc7XG5pbXBvcnQgeyBOZ1ZpZXdSZWYgfSBmcm9tICcuL3ZpZXctcmVmcyc7XG5cbi8qKlxuICogY3JlYXRlcyBhIERldGFjaGVkTG9hZGVyIGVpdGhlciBsaW5rZWQgdG8gdGhlIFZpZXdDb250YWluZXJSZWYgb3IgdGhlIEFwcGxpY2F0aW9uUmVmIGlmIFZpZXdDb250YWluZXJSZWYgaXMgbm90IGRlZmluZWRcbiAqIEBwYXJhbSByZXNvbHZlciBjb21wb25lbnQgZmFjdG9yeSByZXNvbHZlclxuICogQHBhcmFtIGluamVjdG9yIGRlZmF1bHQgaW5qZWN0b3IsIHVudXNlZCBpZiB2aWV3Q29udGFpbmVyUmVmIGlzIHNldFxuICogQHBhcmFtIHZpZXdDb250YWluZXJSZWYgd2hlcmUgdGhlIHZpZXcgc2hvdWxkIGxpdmUgaW4gdGhlIGFuZ3VsYXIgdHJlZVxuICogQHJldHVybnMgcmVmZXJlbmNlIHRvIHRoZSBEZXRhY2hlZExvYWRlclxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2VuZXJhdGVEZXRhY2hlZExvYWRlcihyZXNvbHZlcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLCBpbmplY3RvcjogSW5qZWN0b3IsIHZpZXdDb250YWluZXJSZWY/OiBWaWV3Q29udGFpbmVyUmVmKSB7XG4gIGluamVjdG9yID0gdmlld0NvbnRhaW5lclJlZj8uaW5qZWN0b3IgfHwgaW5qZWN0b3I7XG4gIGNvbnN0IGRldGFjaGVkRmFjdG9yeSA9IHJlc29sdmVyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KERldGFjaGVkTG9hZGVyKTtcbiAgY29uc3QgZGV0YWNoZWRMb2FkZXJSZWYgPSB2aWV3Q29udGFpbmVyUmVmPy5jcmVhdGVDb21wb25lbnQoZGV0YWNoZWRGYWN0b3J5KSB8fCBkZXRhY2hlZEZhY3RvcnkuY3JlYXRlKGluamVjdG9yKTtcbiAgaWYgKCF2aWV3Q29udGFpbmVyUmVmKSB7XG4gICAgaW5qZWN0b3IuZ2V0KEFwcGxpY2F0aW9uUmVmKS5hdHRhY2hWaWV3KGRldGFjaGVkTG9hZGVyUmVmLmhvc3RWaWV3KTtcbiAgfVxuICBkZXRhY2hlZExvYWRlclJlZi5jaGFuZ2VEZXRlY3RvclJlZi5kZXRlY3RDaGFuZ2VzKCk7XG4gIHJldHVybiBkZXRhY2hlZExvYWRlclJlZjtcbn1cblxuLyoqXG4gKiBHZW5lcmF0ZXMgYSBOZ1ZpZXdSZWYgZnJvbSBhIGNvbXBvbmVudCBvciB0ZW1wbGF0ZS4gQHNlZSBOZ1ZpZXdSZWZcbiAqIFBhc3Mga2VlcE5hdGl2ZVZpZXdBdHRhY2hlZCBhcyBgdHJ1ZWAgaWYgeW91IGRvbid0IHdhbnQgdGhlIGZpcnN0IG5hdGl2ZSB2aWV3IHRvIGJlIGRldGFjaGVkIGZyb20gaXRzIHBhcmVudC5cbiAqIEZvciBvcGVuaW5nIG1vZGFscyBhbmQgb3RoZXJzLCB0aGUgZmlyc3ROYXRpdmVMaWtlVmlldyBzaG91bGQgYmUgZGV0YWNoZWQuXG4gKiBAcGFyYW0gdHlwZU9yVGVtcGxhdGUgQ29tcG9uZW50VHlwZSBvciBUZW1wbGF0ZVJlZiB0aGF0IHNob3VsZCBiZSBpbnN0YW5jZWRcbiAqIEBwYXJhbSBvcHRpb25zIG9wdGlvbnMgZm9yIGNyZWF0aW5nIHRoZSB2aWV3XG4gKiBAcmV0dXJucyBOZ1ZpZXdSZWZcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdlbmVyYXRlTmF0aXZlU2NyaXB0VmlldzxUPihcbiAgdHlwZU9yVGVtcGxhdGU6IFR5cGU8VD4gfCBUZW1wbGF0ZVJlZjxUPixcbiAgb3B0aW9uczoge1xuICAgIHJlc29sdmVyPzogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyO1xuICAgIHZpZXdDb250YWluZXJSZWY/OiBWaWV3Q29udGFpbmVyUmVmO1xuICAgIGluamVjdG9yOiBJbmplY3RvcjtcbiAgICBrZWVwTmF0aXZlVmlld0F0dGFjaGVkPzogYm9vbGVhbjtcbiAgICAvKipcbiAgICAgKiByZXVzZSBhIGRldGFjaGVkTG9hZGVyUmVmLiBUaGlzIHdpbGwgb3ZlcnJpZGUgdmlld0NvbnRhaW5lclJlZlxuICAgICAqL1xuICAgIGRldGFjaGVkTG9hZGVyUmVmPzogQ29tcG9uZW50UmVmPERldGFjaGVkTG9hZGVyPjtcbiAgfVxuKSB7XG4gIGxldCBkZXRhY2hlZExvYWRlclJlZjogQ29tcG9uZW50UmVmPERldGFjaGVkTG9hZGVyPiA9IG9wdGlvbnMuZGV0YWNoZWRMb2FkZXJSZWY7XG4gIGNvbnN0IHJldXNpbmdEZXRhY2hlZExvYWRlciA9ICEhZGV0YWNoZWRMb2FkZXJSZWY7XG4gIGlmIChyZXVzaW5nRGV0YWNoZWRMb2FkZXIpIHtcbiAgICBvcHRpb25zLnZpZXdDb250YWluZXJSZWYgPSBkZXRhY2hlZExvYWRlclJlZi5pbnN0YW5jZS52YztcbiAgfVxuICBjb25zdCBpbmplY3RvciA9IG9wdGlvbnMudmlld0NvbnRhaW5lclJlZj8uaW5qZWN0b3IgfHwgb3B0aW9ucy5pbmplY3RvcjtcbiAgY29uc3QgcmVzb2x2ZXIgPSBvcHRpb25zLnJlc29sdmVyIHx8IGluamVjdG9yLmdldChDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIpO1xuICBpZiAoIWRldGFjaGVkTG9hZGVyUmVmICYmIChvcHRpb25zLnZpZXdDb250YWluZXJSZWYgfHwgdHlwZU9yVGVtcGxhdGUgaW5zdGFuY2VvZiBUZW1wbGF0ZVJlZikpIHtcbiAgICBkZXRhY2hlZExvYWRlclJlZiA9IGdlbmVyYXRlRGV0YWNoZWRMb2FkZXIocmVzb2x2ZXIsIGluamVjdG9yLCBvcHRpb25zLnZpZXdDb250YWluZXJSZWYpO1xuICB9XG4gIGxldCBwb3J0YWw6IENvbXBvbmVudFBvcnRhbDxUPiB8IFRlbXBsYXRlUG9ydGFsPFQ+O1xuICBpZiAodHlwZU9yVGVtcGxhdGUgaW5zdGFuY2VvZiBUZW1wbGF0ZVJlZikge1xuICAgIHBvcnRhbCA9IG5ldyBUZW1wbGF0ZVBvcnRhbCh0eXBlT3JUZW1wbGF0ZSwgZGV0YWNoZWRMb2FkZXJSZWYuaW5zdGFuY2UudmMpO1xuICB9IGVsc2Uge1xuICAgIHBvcnRhbCA9IG5ldyBDb21wb25lbnRQb3J0YWwodHlwZU9yVGVtcGxhdGUsIGRldGFjaGVkTG9hZGVyUmVmPy5pbnN0YW5jZS52Yyk7XG4gIH1cbiAgY29uc3QgcGFyZW50VmlldyA9IG5ldyBDb250ZW50VmlldygpO1xuICBjb25zdCBwb3J0YWxPdXRsZXQgPSBuZXcgTmF0aXZlU2NyaXB0RG9tUG9ydGFsT3V0bGV0KHBhcmVudFZpZXcsIHJlc29sdmVyLCBpbmplY3Rvci5nZXQoQXBwbGljYXRpb25SZWYpLCBpbmplY3Rvcik7XG4gIGNvbnN0IGNvbXBvbmVudE9yVGVtcGxhdGVSZWY6IENvbXBvbmVudFJlZjxUPiB8IEVtYmVkZGVkVmlld1JlZjxUPiA9IHBvcnRhbE91dGxldC5hdHRhY2gocG9ydGFsKTtcbiAgY29tcG9uZW50T3JUZW1wbGF0ZVJlZi5vbkRlc3Ryb3koKCkgPT4ge1xuICAgIHBvcnRhbE91dGxldC5kaXNwb3NlKCk7XG4gIH0pO1xuICBpZiAoZGV0YWNoZWRMb2FkZXJSZWYgJiYgIXJldXNpbmdEZXRhY2hlZExvYWRlcikge1xuICAgIGNvbXBvbmVudE9yVGVtcGxhdGVSZWYub25EZXN0cm95KCgpID0+IHtcbiAgICAgIGRldGFjaGVkTG9hZGVyUmVmLmRlc3Ryb3koKTtcbiAgICB9KTtcbiAgfVxuICBjb25zdCB2aWV3UmVmID0gbmV3IE5nVmlld1JlZihjb21wb25lbnRPclRlbXBsYXRlUmVmKTtcbiAgKHZpZXdSZWYgYXMgYW55KS5kZXRhY2hlZExvYWRlclJlZiA9IGRldGFjaGVkTG9hZGVyUmVmO1xuICBpZiAoIW9wdGlvbnMua2VlcE5hdGl2ZVZpZXdBdHRhY2hlZCkge1xuICAgIHZpZXdSZWYuZGV0YWNoTmF0aXZlTGlrZVZpZXcoKTtcbiAgfVxuICByZXR1cm4gdmlld1JlZjtcbn1cbiJdfQ==